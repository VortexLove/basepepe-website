<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>Pepe Blackjack (PBJ) - DApp</title>
    <meta name="description" content="Presale + Blackjack + NFTs en Base. Pepe Blackjack (PBJ) token y juego Web3." />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />

    <!-- Preconnect / Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />

    <!-- Scripts (optimizados) -->
    <script defer src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script defer src="./cdn.tailwindcss.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>

    <style>
      :root { color-scheme: dark; }
      html, body {
        margin:0; padding:0; background:#000;
      }
      html, body, * {
        font-family:'Press Start 2P', cursive !important;
      }
      body { -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
      img { max-width:100%; height:auto; display:block; }

      #tsparticles {
        position:fixed; z-index:-1; inset:0; width:100%; height:100%; pointer-events:none;
      }

      /* Cards */
      .card {
        position:relative;
        width:90px;
        height:130px;
        background:#fff;
        border:3px solid #111;
        border-radius:10px;
        box-shadow:0 6px 10px rgba(0,0,0,.55), inset 0 0 0 2px #eee;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:1.9rem;
        font-weight:700;
        opacity:0;
        transform:translateY(-10px) scale(.9);
        transition:opacity .35s ease, transform .35s ease;
      }
      .card.reveal {
        opacity:1;
        transform:translateY(0) scale(1);
      }
      .card .corner {
        position:absolute;
        font-size:.75rem;
        line-height:1;
        font-weight:700;
      }
      .card .top-left { top:6px; left:6px; }
      .card .bottom-right { bottom:6px; right:6px; transform:rotate(180deg); }
      .red { color:#d60000; }
      .black { color:#111; }

      @media (min-width:640px){
        .card { width:110px; height:155px; font-size:2.3rem; }
      }

      /* Blackjack Table Enhanced */
      .blackjack-wrapper {
        background:radial-gradient(circle at 50% 35%, #0f3d26 0%, #062014 55%, #02120b 100%);
        border:4px solid #0a4d31;
        border-radius:24px;
        padding:18px 14px 26px;
        box-shadow:0 10px 30px rgba(0,0,0,.7), 0 0 0 3px #113d28, inset 0 0 30px #0c5134;
        position:relative;
        overflow:hidden;
      }
      .blackjack-wrapper::before {
        content:"PBJ BLACKJACK";
        position:absolute;
        top:8px; left:50%;
        transform:translateX(-50%);
        font-size:.65rem;
        letter-spacing:3px;
        color:#39ff14cc;
        text-shadow:0 0 6px #39ff14, 0 0 14px #39ff1480;
        pointer-events:none;
      }

      .hand-row {
        display:flex;
        justify-content:center;
        align-items:flex-end;
        gap:8px;
        flex-wrap:nowrap;
        overflow-x:auto;
        padding:8px 4px;
        min-height:142px;
      }

      .score-badge {
        background:#072818;
        border:2px solid #39ff14;
        color:#39ff14;
        padding:6px 10px;
        border-radius:12px;
        font-size:.55rem;
        display:inline-flex;
        align-items:center;
        gap:6px;
        box-shadow:0 0 8px #39ff1480;
      }
      .score-badge .chip {
        width:18px; height:18px;
        background:conic-gradient(#39ff14, #072818, #39ff14);
        border:2px solid #39ff14;
        border-radius:50%;
        box-shadow:0 0 4px #39ff1480;
      }
      .divider-line {
        height:2px;
        background:linear-gradient(90deg,#39ff1400,#39ff14 35%,#39ff14 65%,#39ff1400);
        margin:12px 0;
        filter:drop-shadow(0 0 6px #39ff14);
      }

      .bet-panel {
        display:flex;
        flex-direction:column;
        gap:6px;
        background:#0a2f1e;
        border:3px solid #124c31;
        padding:12px;
        border-radius:14px;
        box-shadow:0 4px 12px #00000080, inset 0 0 12px #0f5135;
      }
      .bet-panel label {
        font-size:.6rem;
        color:#a3ffce;
      }
      .bet-panel input {
        background:#143e2a;
        border:2px solid #206246;
        color:#e8ffe8;
        padding:6px 8px;
        border-radius:8px;
        font-size:.7rem;
        width:100%;
      }
      .bet-panel input:focus {
        outline:none;
        border-color:#39ff14;
        box-shadow:0 0 0 2px #39ff1420;
      }
      .bet-status {
        font-size:.55rem;
        min-height:1.2em;
        color:#39ff14;
      }
      .bet-status.error { color:#ff5151; }

      .btn-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
        gap:8px;
        margin-top:10px;
      }
      .bj-btn {
        background:linear-gradient(180deg,#1c7f55,#14573b);
        border:2px solid #39ff14;
        color:#eafff1;
        padding:10px 8px;
        font-size:.6rem;
        border-radius:12px;
        cursor:pointer;
        position:relative;
        overflow:hidden;
        letter-spacing:1px;
        box-shadow:0 0 8px #39ff1440, inset 0 0 10px #0b2f1f;
        transition:transform .15s, box-shadow .3s;
      }
      .bj-btn:hover:not([disabled]) {
        transform:translateY(-4px);
        box-shadow:0 6px 14px #000, 0 0 10px #39ff1490;
      }
      .bj-btn:disabled {
        opacity:.45;
        cursor:not-allowed;
      }
      .bj-btn.secondary {
        background:linear-gradient(180deg,#173d2b,#0b2317);
        border-color:#206246;
        color:#9dddbd;
      }
      .bj-btn.cancel {
        background:linear-gradient(180deg,#5d1313,#3b0b0b);
        border-color:#ff5858;
        color:#ffe5e5;
      }

      .result-banner {
        margin-top:14px;
        background:#072818;
        border:2px solid #206246;
        padding:10px 14px;
        border-radius:14px;
        font-size:.7rem;
        color:#e8ffe8;
        text-align:center;
        position:relative;
        min-height:52px;
      }
      .result-banner.win {
        border-color:#39ff14;
        box-shadow:0 0 10px #39ff14;
        color:#39ff14;
      }
      .result-banner.lose {
        border-color:#ff5151;
        box-shadow:0 0 10px #ff5151;
        color:#ff9090;
      }
      .result-banner.push {
        border-color:#00aaff;
        box-shadow:0 0 10px #00aaff;
        color:#7fd7ff;
      }

      .floating-glow {
        position:absolute;
        inset:0;
        pointer-events:none;
        background:
          radial-gradient(circle at 20% 30%, #39ff1425 0, transparent 45%),
          radial-gradient(circle at 80% 70%, #39ff1425 0, transparent 55%);
        mix-blend-mode:screen;
        animation:glowPulse 6s linear infinite;
      }
      @keyframes glowPulse {
        0% { opacity:.5; }
        50% { opacity:.8; }
        100% { opacity:.5; }
      }

      /* Utility classes */
      .defer-section {
        content-visibility:auto;
        contain-intrinsic-size:800px 600px;
      }

      @media (prefers-reduced-motion: reduce) {
        * { animation:none !important; transition:none !important; }
      }

      /* Existing other sections simplified from previous version omitted styles for brevity (retain previous styling) */
      /* Keep previous tokenomics / nft / etc styles if needed (already loaded externally with Tailwind). */
    </style>
  </head>

  <body class="bg-gray-950 text-white min-h-screen">
    <div id="tsparticles" aria-hidden="true"></div>

    <div class="max-w-4xl mx-auto p-4 space-y-8">
      <!-- Header -->
      <header class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700 gap-3">
        <h1 class="text-2xl sm:text-3xl font-bold text-green-400">Pepe Blackjack (PBJ)</h1>

        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
          <button id="connectButton" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-white w-full sm:w-auto text-center">
            Conectar Billetera
          </button>
          <button id="wcButton" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white w-full sm:w-auto text-center"
                  title="Usa WalletConnect (Trust Wallet, etc.)">
            WalletConnect
          </button>
        </div>

        <div id="pbjDisplay"
             style="display:none;align-items:center;gap:8px;font-size:20px;color:#39ff14;background:transparent;padding:10px 20px;">
          <img src="./Coin.png" alt="PBJ Coin" width="48" height="48" loading="lazy" decoding="async"
               style="image-rendering:pixelated;border-radius:50%;border:none;">
          <span id="pbjBalanceHeader">0</span> PBJ
        </div>
      </header>

      <div id="status" class="text-center text-base sm:text-lg" aria-live="polite"></div>

      <!-- PRESALE BLOCK (mantener igual que versi√≥n previa) -->
      <!-- (contenido omitido para brevedad ‚Äì mant√©n tu bloque anterior de preventa, barras y voto aqu√≠) -->

      <!-- Blackjack Game (MEJORADO) -->
      <section id="blackjackGame" class="bg-transparent p-0 sm:p-0 rounded-xl">
        <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-4">üÉè Blackjack PBJ (On-Chain Bet)</h2>

        <div class="blackjack-wrapper">
          <div class="floating-glow"></div>

          <!-- Panel de apuesta -->
          <div class="bet-panel">
            <label for="betAmountPBJ">Bet (PBJ tokens):</label>
            <input id="betAmountPBJ" type="number" min="10" step="10" value="1000" placeholder="Cantidad PBJ" />
            <div class="bet-status" id="betStatus"></div>
            <div class="score-badge" id="pbjBalanceGameWrap">
              <span class="chip"></span>
              Balance: <span id="pbjBalanceGame">0</span> PBJ
            </div>
          </div>

          <div class="divider-line"></div>

            <!-- Dealer -->
          <div class="flex items-center justify-between mb-2 px-2">
            <div class="score-badge">
              Dealer
              <span id="dealerScore">0</span>
            </div>
            <div class="score-badge secondary" style="background:#091d13;border-color:#206246;color:#9fdcb8;">
              Estado: <span id="gameState">Idle</span>
            </div>
          </div>
          <div id="dealerArea" class="hand-row" aria-label="Dealer cards"></div>

          <div class="divider-line"></div>

          <!-- Player -->
          <div class="flex items-center justify-between mb-2 px-2">
            <div class="score-badge">
              Player
              <span id="playerScore">0</span>
            </div>
            <div class="score-badge" style="background:#072818;">
              Bet Activa: <span id="activeBetDisplay">0</span> PBJ
            </div>
          </div>
          <div id="playerArea" class="hand-row" aria-label="Player cards"></div>

          <div class="btn-grid">
            <button id="dealBtn" class="bj-btn">DEAL</button>
            <button id="hitBtn" class="bj-btn secondary" disabled>HIT</button>
            <button id="standBtn" class="bj-btn secondary" disabled>STAND</button>
            <button id="doubleBtn" class="bj-btn secondary" disabled>DOUBLE</button>
            <button id="cancelBtn" class="bj-btn cancel" disabled>CANCEL BET</button>
          </div>

          <div id="resultMsg" class="result-banner"></div>
        </div>
      </section>

      <!-- (Resto de secciones: NFTs, Lore, Roadmap, Tokenomics, Team, FAQ) ‚Äì Mantener igual a la versi√≥n anterior optimizada -->
      <!-- Puedes reinsertar aqu√≠ el resto de tu contenido ya modificado para performance -->
    </div>

    <!-- tsParticles (idle/delayed init) -->
    <script defer>
      function initParticles() {
        if (typeof tsParticles === 'undefined') return;
        tsParticles.load("tsparticles", {
          background:{ color:{ value:"#000" } },
          fpsLimit:60,
          interactivity:{
            events:{ onHover:{ enable:true, mode:"repulse" }, resize:true },
            modes:{ repulse:{ distance:100, duration:0.4 } }
          },
          particles:{
            color:{ value:"#00ff99" },
            links:{ enable:true, color:"#00ff99", distance:150 },
            move:{ enable:true, speed:2 },
            number:{ value:window.matchMedia('(max-width:600px)').matches ? 25 : 40 },
            opacity:{ value:0.45 },
            shape:{ type:"circle" },
            size:{ value:{ min:1, max:2 } }
          },
          detectRetina:true
        });
      }
      window.addEventListener('load', () => {
        if ('requestIdleCallback' in window) requestIdleCallback(initParticles, { timeout:1200 });
        else setTimeout(initParticles, 500);
      });
    </script>

    <!-- App Logic + Blackjack -->
    <script defer>
      /* ================== Blockchain Config ================== */
      let provider, signer, userAddress;
      let pbjContract, casinoContract, presaleContract;

      const contractAddress     = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5'; // Presale
      const pbjContractAddress  = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
      const pbjTokenAddress     = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
      const casinoAddress       = '0x79e617b64eae98bda7f8Cd4b1EdC05dE696E4B74'; // Blackjack casino
      const nftAddress          = '0x4AabC024D719240e98e82930EAC04bD49CB86E31';

      const pbjAbi = [
        'function balanceOf(address) view returns (uint256)',
        'function decimals() view returns (uint8)',
        'function approve(address spender, uint256 amount) returns (bool)',
        'function allowance(address owner, address spender) view returns (uint256)'
      ];
      const casinoAbi = [
        'function placeBet(uint256 amount) external',
        'function finishGame(bool playerWon) external',
        'function cancelBet() external'
      ];
      const presaleAbi = ['function buyTokens() payable'];

      const nftAbi = [
        {"inputs":[{"internalType":"enum PepeBlackjackNFT.Rarity","name":"_rarity","type":"uint8"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"pbjToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"enum PepeBlackjackNFT.Rarity","name":"","type":"uint8"}],"name":"nftTypes","outputs":[
          {"internalType":"uint256","name":"pricePBJ","type":"uint256"},
          {"internalType":"uint256","name":"totalSupply","type":"uint256"},
          {"internalType":"uint256","name":"minted","type":"uint256"}
        ],"stateMutability":"view","type":"function"}
      ];

      const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      function showStatus(msg, ok = true) {
        const el = document.getElementById('status');
        if (!el) return;
        el.textContent = msg;
        el.style.color = ok ? '#39ff14' : '#ff5151';
      }

      async function ensureBaseNetwork() {
        try {
          const net = await provider.getNetwork();
          if (net.chainId === 8453) return true;
          if (provider.provider && provider.provider.request) {
            try {
              await provider.provider.request({
                method:'wallet_switchEthereumChain',
                params:[{ chainId:'0x2105' }]
              });
              return true;
            } catch(e){
              try {
                await provider.provider.request({
                  method:'wallet_addEthereumChain',
                  params:[{
                    chainId:'0x2105',
                    chainName:'Base',
                    nativeCurrency:{ name:'Ether', symbol:'ETH', decimals:18 },
                    rpcUrls:['https://mainnet.base.org'],
                    blockExplorerUrls:['https://basescan.org']
                  }]
                });
                return true;
              } catch(e2){
                showStatus('Cambia a Base (8453).', false);
                return false;
              }
            }
          }
          return false;
        } catch(e){ return false; }
      }

      function bindProviderEvents(eip1193Provider){
        if(!eip1193Provider?.on) return;
        eip1193Provider.on('accountsChanged', async (acc)=>{
          if(acc.length){
            userAddress = acc[0];
            await afterConnected();
          } else {
            showStatus('Wallet desconectada', false);
          }
        });
        eip1193Provider.on('chainChanged', async ()=>{
          await ensureBaseNetwork();
          await afterConnected();
        });
        eip1193Provider.on('disconnect', ()=> showStatus('Wallet desconectada', false));
      }

      async function connectInjected(){
        if(!window.ethereum) return null;
        await window.ethereum.request({ method:'eth_requestAccounts' });
        const ethProvider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        bindProviderEvents(window.ethereum);
        return ethProvider;
      }

      async function connectWalletConnect(){
        try {
          const { default: EthereumProvider } = await import("https://esm.sh/@walletconnect/ethereum-provider@2.11.1");
          const projectId = "06606e3b978574fe1fe67024c91c5aa3"; // Your WC projectId
          const wcProvider = await EthereumProvider.init({
            projectId,
            chains:[8453],
            showQrModal:true,
            optionalChains:[8453],
            methods:["eth_sendTransaction","personal_sign","eth_sign","eth_signTypedData","eth_signTransaction"],
            events:["chainChanged","accountsChanged"],
            rpcMap:{8453:"https://mainnet.base.org"},
            metadata:{
              name:"Pepe Blackjack (PBJ)",
              description:"PBJ Presale + Blackjack",
              url:window.location.origin,
              icons:[window.location.origin + "/logo.png"]
            }
          });
          await wcProvider.connect();
          bindProviderEvents(wcProvider);
          return new ethers.providers.Web3Provider(wcProvider,'any');
        } catch(e){
          console.error(e);
          alert("WalletConnect v2 error.");
          return null;
        }
      }

      async function connectFlow(preferWC=false){
        try {
          if(preferWC){
            provider = await connectWalletConnect();
            if(!provider && window.ethereum) provider = await connectInjected();
          } else {
            provider = window.ethereum ? await connectInjected() : await connectWalletConnect();
          }
          if(!provider){ showStatus('No se pudo conectar wallet.', false); return; }

          signer = provider.getSigner();
          userAddress = await signer.getAddress();

          const ok = await ensureBaseNetwork();
          if(!ok) return;

          await afterConnected();
        } catch(e){
          console.error(e);
          showStatus('Error conectando wallet.', false);
        }
      }

      async function afterConnected(){
        pbjContract      = new ethers.Contract(pbjContractAddress, pbjAbi, signer);
        casinoContract   = new ethers.Contract(casinoAddress, casinoAbi, signer);
        presaleContract  = new ethers.Contract(contractAddress, presaleAbi, signer);

        // ETH balance
        try {
          const balance = await provider.getBalance(userAddress);
          const ethEl = document.getElementById('ethBalance');
          if(ethEl) ethEl.textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + ' ETH';
        } catch{}

        document.getElementById('pbjDisplay').style.display='flex';
        showStatus('‚úÖ Wallet conectada');
        await updatePBJBalance();
      }

      async function updatePBJBalance(){
        if(!pbjContract || !userAddress) return;
        try {
          const raw = await pbjContract.balanceOf(userAddress);
          const dec = await pbjContract.decimals();
          const balance = ethers.utils.formatUnits(raw, dec);
          const formatted = parseFloat(balance).toFixed(2);
          const header = document.getElementById('pbjBalanceHeader');
          const game   = document.getElementById('pbjBalanceGame');
          if(header) header.textContent = formatted;
          if(game) game.textContent = formatted;
        } catch(e){ console.error(e); }
      }

      /* ================== Blackjack Game Logic ================== */
      let deck = [];
      let playerHand = [];
      let dealerHand = [];
      let gameActive = false;
      let betPlaced = false;
      let betAmountPBJ = 0;
      let betOnChain = false;
      let playerFinished = false;
      let pbjDecimals = 18;
      let doubleAvailable = true;

      function buildDeck(){
        const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
        const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        deck = [];
        for(const s of suits){
          for(const v of values){
            deck.push({s, v});
          }
        }
        // Fisher-Yates shuffle
        for(let i=deck.length-1;i>0;i--){
          const j = Math.floor(Math.random()* (i+1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }

      function cardValue(c){
        if(c.v === 'A') return 11;
        if(['J','Q','K'].includes(c.v)) return 10;
        return parseInt(c.v,10);
      }

      function handScore(hand){
        let total = 0;
        let aces = 0;
        hand.forEach(c=>{
          total += cardValue(c);
          if(c.v==='A') aces++;
        });
        while(total > 21 && aces>0){
          total -= 10;
          aces--;
        }
        return total;
      }

      function drawCard(){ return deck.pop(); }

      function createCardElement(card){
        const div = document.createElement('div');
        div.className = 'card';
        const isRed = (card.s==='‚ô•' || card.s==='‚ô¶');
        div.innerHTML = `
          <span class="corner top-left ${isRed?'red':'black'}">${card.v}${card.s}</span>
          <span class="${isRed?'red':'black'}">${card.v}${card.s}</span>
          <span class="corner bottom-right ${isRed?'red':'black'}">${card.v}${card.s}</span>
        `;
        requestAnimationFrame(()=> div.classList.add('reveal'));
        return div;
      }

      function renderHands(){
        const dealerArea = document.getElementById('dealerArea');
        const playerArea = document.getElementById('playerArea');
        dealerArea.innerHTML = '';
        playerArea.innerHTML = '';
        dealerHand.forEach(c=> dealerArea.appendChild(createCardElement(c)));
        playerHand.forEach(c=> playerArea.appendChild(createCardElement(c)));

        document.getElementById('dealerScore').textContent = handScore(dealerHand);
        document.getElementById('playerScore').textContent = handScore(playerHand);
      }

      function updateGameState(txt){
        document.getElementById('gameState').textContent = txt;
      }

      function setButtons({deal, hit, stand, double, cancel}){
        document.getElementById('dealBtn').disabled   = !deal;
        document.getElementById('hitBtn').disabled    = !hit;
        document.getElementById('standBtn').disabled  = !stand;
        document.getElementById('doubleBtn').disabled = !double;
        document.getElementById('cancelBtn').disabled = !cancel;
      }

      function showResult(msg, type){
        const el = document.getElementById('resultMsg');
        el.className = 'result-banner';
        if(type==='win') el.classList.add('win');
        else if(type==='lose') el.classList.add('lose');
        else if(type==='push') el.classList.add('push');
        el.textContent = msg;
      }

      async function ensureAllowance(amountRaw){
        if(!pbjContract || !userAddress) return false;
        try {
          const allowance = await pbjContract.allowance(userAddress, casinoAddress);
          if(allowance.gte(amountRaw)) return true;
          const tx = await pbjContract.approve(casinoAddress, amountRaw);
          document.getElementById('betStatus').textContent = 'Aprobando PBJ...';
          await tx.wait();
          document.getElementById('betStatus').textContent = 'Allowance OK';
          return true;
        } catch(e){
          console.error(e);
          document.getElementById('betStatus').textContent = 'Error allowance';
          document.getElementById('betStatus').classList.add('error');
          return false;
        }
      }

      async function placeBetOnChain(){
        if(!casinoContract) return false;
        try {
          const rawAmount = ethers.utils.parseUnits(betAmountPBJ.toString(), pbjDecimals);
          const ok = await ensureAllowance(rawAmount);
          if(!ok) return false;
          document.getElementById('betStatus').textContent = '‚è≥ Enviando apuesta...';
          const tx = await casinoContract.placeBet(rawAmount);
          await tx.wait();
          document.getElementById('betStatus').textContent = '‚úÖ Apuesta activa';
          betOnChain = true;
          return true;
        } catch(e){
          console.error(e);
          document.getElementById('betStatus').textContent = 'Error al apostar';
          document.getElementById('betStatus').classList.add('error');
          return false;
        }
      }

      async function finishBet(playerWon){
        if(!betOnChain) return;
        try {
          document.getElementById('betStatus').textContent = '‚è≥ Resolviendo...';
          const tx = await casinoContract.finishGame(playerWon);
          await tx.wait();
          document.getElementById('betStatus').textContent = playerWon ? 'üèÜ Ganaste' : 'üíÄ Perdiste';
          betOnChain = false;
          await updatePBJBalance();
        } catch(e){
          console.error(e);
          document.getElementById('betStatus').textContent = 'Error finishGame';
          document.getElementById('betStatus').classList.add('error');
        }
      }

      async function cancelBet(){
        if(!betOnChain) return;
        try {
          document.getElementById('betStatus').textContent = 'Cancelando apuesta...';
          const tx = await casinoContract.cancelBet();
          await tx.wait();
          document.getElementById('betStatus').textContent = 'Apuesta cancelada';
          betOnChain = false;
          resetGame(true);
          await updatePBJBalance();
        } catch(e){
          console.error(e);
          document.getElementById('betStatus').textContent = 'Error cancelBet';
          document.getElementById('betStatus').classList.add('error');
        }
      }

      function resetGame(keepBet=false){
        gameActive = false;
        playerFinished = false;
        deck = [];
        playerHand = [];
        dealerHand = [];
        doubleAvailable = true;
        document.getElementById('dealerArea').innerHTML = '';
        document.getElementById('playerArea').innerHTML = '';
        document.getElementById('dealerScore').textContent = '0';
        document.getElementById('playerScore').textContent = '0';
        updateGameState('Idle');
        if(!keepBet){
          betPlaced = false;
          betAmountPBJ = 0;
          document.getElementById('activeBetDisplay').textContent = '0';
        }
        showResult('', '');
        setButtons({deal:true, hit:false, stand:false, double:false, cancel:false});
      }

      async function deal(){
        if(gameActive) return;
        if(!provider || !signer){
          await connectFlow(isMobile());
          if(!provider) return;
        }
        if(!pbjContract){
          await afterConnected();
        }
        // Recuperar decimals una sola vez
        try { pbjDecimals = await pbjContract.decimals(); } catch{}

        const input = document.getElementById('betAmountPBJ');
        const val = parseInt(input.value,10);
        if(!val || val <= 0){
          document.getElementById('betStatus').textContent = 'Valor de apuesta inv√°lido';
          document.getElementById('betStatus').classList.add('error');
          return;
        }
        betAmountPBJ = val;
        document.getElementById('activeBetDisplay').textContent = betAmountPBJ.toString();

        // Verificar balance
        try {
          const rawBal = await pbjContract.balanceOf(userAddress);
          const balReadable = parseFloat(ethers.utils.formatUnits(rawBal, pbjDecimals));
          if(betAmountPBJ > balReadable){
            document.getElementById('betStatus').textContent = 'Saldo insuficiente PBJ';
            document.getElementById('betStatus').classList.add('error');
            return;
          }
        } catch{}

        // On-chain place bet
        const placed = await placeBetOnChain();
        if(!placed) return;

        betPlaced = true;
        buildDeck();
        playerHand = [drawCard(), drawCard()];
        dealerHand = [drawCard(), drawCard()];
        renderHands();
        gameActive = true;
        updateGameState('Playing');
        setButtons({deal:false, hit:true, stand:true, double:true, cancel:true});
        evaluateImmediate();
      }

      function evaluateImmediate(){
        const pScore = handScore(playerHand);
        const dScore = handScore(dealerHand);
        if(pScore === 21) {
          // Natural Blackjack simple (empate si dealer tambi√©n tiene 21)
          endGame();
        }
      }

      function playerHit(){
        if(!gameActive || playerFinished) return;
        playerHand.push(drawCard());
        renderHands();
        doubleAvailable = false;
        document.getElementById('doubleBtn').disabled = true;
        const pScore = handScore(playerHand);
        if(pScore > 21){
          endGame();
        }
      }

      async function playerStand(){
        if(!gameActive || playerFinished) return;
        playerFinished = true;
        dealerPlay();
        renderHands();
        await endGame();
      }

      function dealerPlay(){
        while(handScore(dealerHand) < 17){
          dealerHand.push(drawCard());
        }
      }

      async function playerDouble(){
        if(!gameActive || playerFinished || !doubleAvailable) return;
        doubleAvailable = false;
        // Doblar la apuesta: aprobar diferencia y placeBet extra NO implementado en contrato (asumimos UI add)
        // Si el contrato no soporta doblar, podemos simular y multiplicar resultado final.
        betAmountPBJ *= 2;
        document.getElementById('activeBetDisplay').textContent = betAmountPBJ.toString();
        // Hit auto + Stand auto
        playerHand.push(drawCard());
        renderHands();
        if(handScore(playerHand) > 21){
          endGame();
        } else {
          playerStand();
        }
      }

      async function endGame(){
        if(!betPlaced) return;
        setButtons({deal:false, hit:false, stand:false, double:false, cancel:false});
        const pScore = handScore(playerHand);
        const dScore = handScore(dealerHand);
        let resultType, resultMsg, playerWon=false;

        if(pScore > 21){
          resultType='lose'; resultMsg='Player Bust! Dealer Wins.'; playerWon=false;
        } else if(dScore > 21){
          resultType='win'; resultMsg='Dealer Bust! Player Wins.'; playerWon=true;
        } else if(pScore === dScore){
          resultType='push'; resultMsg='Push!';
          // En caso de push podr√≠as llamar finishGame(false) y luego reembolsar (depende del contrato). Supondremos false.
          playerWon = false;
        } else if(pScore === 21 && playerHand.length === 2 && dScore !== 21){
          resultType='win'; resultMsg='Blackjack! Player Wins.'; playerWon=true;
        } else if(pScore > dScore){
          resultType='win'; resultMsg='Player Wins.'; playerWon=true;
        } else {
          resultType='lose'; resultMsg='Dealer Wins.'; playerWon=false;
        }

        showResult(resultMsg, resultType);
        updateGameState('Finished');

        await finishBet(playerWon);
        gameActive = false;
        betPlaced = false;
        setTimeout(()=> resetGame(), 2500);
      }

      /* ================== NFT Compra (placeholder mantener previa l√≥gica) ================== */
      window.buyNFT = async function(rarity) {
        try {
          if(!provider || !signer){
            await connectFlow(isMobile());
          }
          if(!provider) return;
          const nftContract = new ethers.Contract(nftAddress, nftAbi, signer);
          const pbjErc20 = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);
          const nftInfo = await nftContract.nftTypes(rarity);
          const price = nftInfo.pricePBJ;
          const allowance = await pbjErc20.allowance(userAddress, nftAddress);
          if(allowance.lt(price)){
            const txApprove = await pbjErc20.approve(nftAddress, price);
            await txApprove.wait();
          }
          const txMint = await nftContract.mint(rarity);
            await txMint.wait();
          alert("‚úÖ NFT comprado con √©xito");
          // loadUserNFTs(); // si se desea
        } catch(e){
          console.error(e);
          alert("No se pudo comprar el NFT.");
        }
      };

      /* ================== Event Listeners ================== */
      function setupButtons(){
        document.getElementById('connectButton').addEventListener('click', ()=> connectFlow(false));
        document.getElementById('wcButton').addEventListener('click', ()=> connectFlow(true));
        document.getElementById('dealBtn').addEventListener('click', deal);
        document.getElementById('hitBtn').addEventListener('click', playerHit);
        document.getElementById('standBtn').addEventListener('click', playerStand);
        document.getElementById('doubleBtn').addEventListener('click', playerDouble);
        document.getElementById('cancelBtn').addEventListener('click', cancelBet);
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        setupButtons();
        resetGame();
      });
    </script>
  </body>
</html>
