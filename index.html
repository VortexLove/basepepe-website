<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>Pepe Blackjack (PBJ) - Premier Crypto Casino</title>
  <meta name="description" content="The #1 Meme Casino on Base. Play Blackjack, Slots, Plinko. Stake NFTs." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet" />

  <!-- Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --neon-green: #39ff14;
      --panel-bg: rgba(8, 12, 10, 0.92);
      --glass-border: rgba(57, 255, 20, 0.25);
    }

    /* Typography */
    h1, h2, h3, .nav-btn, .pixel-font { font-family: 'Press Start 2P', cursive; }
    body { font-family: 'Inter', sans-serif; background-color: #020202; color: #e0e0e0; overflow-x: hidden; }

    /* Backgrounds */
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background: radial-gradient(circle at 20% 50%, rgba(34, 197, 94, 0.08), transparent 40%),
                  radial-gradient(circle at 80% 20%, rgba(37, 99, 235, 0.08), transparent 40%);
    }
    body::after {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* Glass Panels */
    .glass-panel {
      background: var(--panel-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .glass-panel:hover {
      border-color: rgba(57, 255, 20, 0.6);
    }

    /* Blackjack Table Visuals */
    .table-felt {
      position: relative;
      background-color: #0e5c2f;
      background-image: radial-gradient(circle at 50% 50%, #137a3f 0%, #0b4624 100%);
      border: 12px solid #3d2314;
      border-radius: 40px 40px 150px 150px;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.6), 0 20px 60px rgba(0,0,0,0.8);
      padding: 2rem;
    }
    .table-felt::before {
      content: "PEPE CASINO";
      position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
      font-family: 'Press Start 2P'; color: rgba(0,0,0,0.15); font-size: 2rem; pointer-events: none; text-align: center;
      width: 100%;
    }
    .table-line {
      position: absolute; bottom: 30%; left: 10%; right: 10%; height: 2px;
      background: rgba(255,255,255,0.1); border-radius: 50%;
    }

    /* Buttons */
    .nav-btn { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s; cursor: pointer; }
    .nav-btn:hover { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); transform: translateY(-2px); }
    
    .action-btn {
      background: linear-gradient(135deg, #22c55e 0%, #166534 100%);
      box-shadow: 0 4px 0 #064e3b; transition: all 0.1s; text-shadow: 1px 1px 0 #000;
    }
    .action-btn:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
    .action-btn:disabled { background: #333; box-shadow: none; cursor: not-allowed; opacity: 0.6; filter: grayscale(1); }

    /* Game Cards */
    .game-card {
      position: relative; overflow: hidden; border-radius: 12px; cursor: pointer;
      border: 1px solid #222; transition: all 0.3s; display: block;
    }
    .game-card:hover { transform: translateY(-5px); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); }
    .game-card img { width: 100%; height: 160px; object-fit: cover; transition: transform 0.3s; }
    .game-card:hover img { transform: scale(1.05); }
    .play-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.2s;
    }
    .game-card:hover .play-overlay { opacity: 1; }

    /* Cards (Playing Cards) */
    .card {
      width: 70px; height: 100px; background: white; border-radius: 6px;
      position: relative; display: flex; align-items: center; justify-content: center;
      font-family: 'Inter', sans-serif; font-weight: bold; font-size: 20px;
      box-shadow: 2px 4px 10px rgba(0,0,0,0.4);
      transform: translateY(-30px) scale(0.8); opacity: 0;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
    }
    .card.reveal { transform: translateY(0) scale(1); opacity: 1; }
    .card.red { color: #ef4444; } .card.black { color: #171717; }
    .card .corner-val { position: absolute; font-size: 10px; line-height: 1; }
    .card .tl { top: 4px; left: 4px; }
    .card .br { bottom: 4px; right: 4px; transform: rotate(180deg); }
    @media(min-width: 640px){ .card { width: 90px; height: 130px; font-size: 28px; } }

    /* Toasts */
    #toast-container { position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      background: rgba(10, 10, 10, 0.95); border-left: 4px solid var(--neon-green);
      color: white; padding: 12px 20px; border-radius: 4px; font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5); animation: slideIn 0.3s forwards;
      pointer-events: auto; max-width: 100%;
    }
    .toast.error { border-left-color: #ef4444; }
    @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Pie Chart */
    .pie-chart {
      width: 180px; height: 180px; border-radius: 50%;
      background: conic-gradient(#22c55e 0% 40%, #3b82f6 40% 65%, #a855f7 65% 85%, #f59e0b 85% 95%, #ef4444 95% 100%);
      position: relative; box-shadow: 0 0 20px rgba(34, 197, 94, 0.1);
    }
    .pie-chart::after {
      content: "1B"; position: absolute; inset: 25%; background: #020202; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 14px; color: white; font-weight: bold;
    }
    
    /* Modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 9990; display: none; place-items: center; }
    .modal-content { background: #111; border: 1px solid var(--neon-green); padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }

    /* Purchase Counter Animation */
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(57, 255, 20, 0); } 100% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0); } }
    .live-dot { animation: pulse-green 2s infinite; }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

  <div id="toast-container"></div>

  <!-- TERMS & CONDITIONS MODAL -->
  <div id="termsModal" class="modal-backdrop">
    <div class="modal-content relative">
        <button onclick="closeTerms()" class="absolute top-4 right-4 text-gray-500 hover:text-white">X</button>
        <h2 class="text-xl pixel-font text-green-400 mb-4">AFFILIATE PROGRAM TERMS</h2>
        <div class="text-xs text-gray-300 space-y-4 font-mono">
            <p class="font-bold">1. COMMISSION STRUCTURE</p>
            <p>We offer up to 50% Revenue Share based on Net Gaming Revenue (NGR).</p>
            <ul class="list-disc pl-4 space-y-1 text-gray-400">
                <li><strong class="text-white">Tier 1 (Scout):</strong> 30% (0-10 Active Players)</li>
                <li><strong class="text-white">Tier 2 (Captain):</strong> 40% (11-50 Active Players)</li>
                <li><strong class="text-white">Tier 3 (Whale):</strong> 50% (51+ Active Players)</li>
            </ul>
            
            <p class="font-bold mt-4">2. CALCULATION OF NGR</p>
            <p>NGR = Bets - (Wins + Bonuses + Admin Fees).</p>

            <p class="font-bold mt-4 text-green-400">3. NO NEGATIVE CARRYOVER</p>
            <p>If your players win big and your balance is negative at month's end, <span class="text-white underline">we wipe the debt</span>. Your balance resets to $0 on the 1st of the next month.</p>

            <p class="font-bold mt-4">4. PAYMENTS</p>
            <p>Payments are processed weekly (Mondays) in $PBJ or ETH (Base Network). Minimum withdrawal: $10.</p>
        </div>
        <div class="mt-6 flex justify-end">
            <button onclick="closeTerms()" class="bg-gray-800 hover:bg-green-600 hover:text-black text-white px-4 py-2 rounded text-xs font-bold transition">UNDERSTOOD</button>
        </div>
    </div>
  </div>

  <!-- REGISTRATION MODAL -->
  <div id="regModal" class="modal-backdrop">
    <div class="modal-content text-center max-w-md">
        <h2 class="text-xl pixel-font text-white mb-2">WELCOME DEGEN</h2>
        <p class="text-xs text-gray-400 mb-6">Create your alias to start playing & earning.</p>
        <input type="text" id="regUsername" placeholder="Username..." class="w-full bg-black border border-gray-700 p-3 rounded text-white text-center mb-4 focus:border-green-500 outline-none uppercase">
        <button onclick="completeRegistration()" class="w-full action-btn text-white font-bold py-3 rounded pixel-font text-xs">CREATE ACCOUNT</button>
    </div>
  </div>

  <!-- HEADER -->
  <nav class="sticky top-0 z-50 bg-black/90 backdrop-blur-md border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]"></div>
        <span class="text-green-400 text-sm md:text-lg pixel-font">PBJ CASINO</span>
      </div>
      
      <div class="hidden lg:flex gap-6">
        <a href="#games" class="nav-btn text-gray-400">Lobby</a>
        <a href="#blackjack" class="nav-btn text-gray-400">Blackjack</a>
        <a href="#staking" class="nav-btn text-gray-400">Staking</a>
        <a href="#partners" class="nav-btn text-green-400 font-bold">PARTNERS</a>
        <a href="#presale" class="nav-btn text-gray-400">Buy PBJ</a>
      </div>

      <div class="flex items-center gap-3 ml-auto md:ml-0">
        <!-- Simulated Purchase Counter -->
        <div class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-gray-900 border border-gray-700 text-[10px] text-gray-300">
            <span class="w-2 h-2 bg-green-500 rounded-full live-dot"></span>
            <span id="purchases-counter" class="font-mono text-green-400 font-bold">102</span> purchases (1h)
        </div>

        <div id="walletDisplay" class="hidden items-center gap-2 px-3 py-1 rounded-full border border-green-800 bg-green-900/20 text-[10px] md:text-xs text-green-400">
            <span id="userNameDisplay" class="text-white font-bold mr-1 hidden">PLAYER</span> |
            <span id="pbjBalanceHeader">0</span> PBJ
        </div>
        <!-- Connect Button -->
        <button id="connectBtn" class="pixel-font bg-green-600 hover:bg-green-500 text-black text-[10px] px-4 py-2 rounded shadow-[0_0_10px_rgba(34,197,94,0.4)] transition-all">
          CONNECT
        </button>
      </div>
    </div>
    
    <!-- LIVE STATS BAR -->
    <div class="bg-green-900/20 border-b border-green-500/10 py-1">
      <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-[10px] font-mono">
        <div class="flex items-center gap-2 text-green-400">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          <span id="online-count">1,243</span> Online
        </div>
        <div id="winner-ticker" class="text-gray-400">Waiting for latest wins...</div>
      </div>
    </div>
  </nav>

  <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-8 space-y-20">

    <!-- HERO & BUY SECTION (PRESALE) -->
    <section id="presale" class="grid md:grid-cols-2 gap-12 items-center pt-4">
      <div class="space-y-6 text-center md:text-left">
        <div class="inline-block px-3 py-1 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-[10px] font-bold tracking-widest mb-2">
          OFFICIAL PRESALE
        </div>
        <h1 class="text-3xl md:text-5xl leading-tight text-white">
          Get <span class="text-green-500">PBJ</span> Tokens
        </h1>
        <p class="text-gray-400 leading-relaxed text-xs md:text-sm">
          The fuel for the entire Pepe Blackjack ecosystem. Buy now at fixed presale rate.
        </p>

        <!-- Swap UI -->
        <div class="glass-panel p-6 space-y-4 relative overflow-hidden max-w-md mx-auto md:mx-0 transition-all duration-300" id="swap-card">
          
          <!-- Mode Indicator -->
          <div class="flex justify-between items-center mb-2">
            <span id="swap-mode-text" class="text-xs font-bold text-green-400 tracking-widest">MODE: BUY</span>
            <div class="flex gap-1">
               <button onclick="setEth(0.05)" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-[10px] px-2 py-1 rounded text-white transition">0.05</button>
               <button onclick="setEth(0.1)" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-[10px] px-2 py-1 rounded text-white transition">0.1</button>
               <button onclick="setEth(0.5)" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-[10px] px-2 py-1 rounded text-white transition">0.5</button>
               <button onclick="setEth(1)" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-[10px] px-2 py-1 rounded text-white transition">1.0</button>
            </div>
          </div>
          
          <!-- Top Input -->
          <div class="bg-black/60 rounded-xl p-3 border border-gray-700 flex flex-col gap-1 relative group focus-within:border-green-500 transition-colors">
             <div class="flex justify-between text-[10px] text-gray-400">
                <span id="label-top">You Pay</span>
                <span>Bal: <span id="balance-top" class="text-white">0.00</span></span>
             </div>
             <div class="flex items-center gap-2">
                <input type="number" id="input-top" class="bg-transparent text-white text-lg w-full outline-none font-mono placeholder-gray-600" placeholder="0.0">
                <button id="maxBtn" class="text-[10px] bg-gray-700 px-2 py-1 rounded text-green-400 hover:bg-gray-600 transition">MAX</button>
                <span id="symbol-top" class="font-bold text-gray-300 text-sm">ETH</span>
             </div>
          </div>

          <!-- Swap Arrow -->
          <div class="flex justify-center -my-4 relative z-10">
             <button id="swapDirBtn" class="bg-gray-800 hover:bg-gray-700 rounded-full p-2 border-4 border-[#0e1512] text-gray-300 shadow-lg transition-transform active:rotate-180">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
             </button>
          </div>

          <!-- Bottom Input -->
          <div class="bg-black/60 rounded-xl p-3 border border-gray-700 flex flex-col gap-1 relative group focus-within:border-green-500 transition-colors">
             <div class="flex justify-between text-[10px] text-gray-400">
                <span id="label-bottom">You Receive</span>
                <span>Rate: <span class="text-green-400">1M/ETH</span></span>
             </div>
             <div class="flex items-center gap-2">
                <input type="number" id="input-bottom" class="bg-transparent text-white text-lg w-full outline-none font-mono placeholder-gray-600" placeholder="0">
                <span id="symbol-bottom" class="font-bold text-green-500 text-sm">PBJ</span>
             </div>
          </div>

          <button id="buyBtn" disabled class="w-full action-btn text-white font-bold py-4 rounded-xl pixel-font text-xs mt-2 tracking-widest shadow-lg active:scale-[0.98] transition-all">
            CONNECT TO BUY
          </button>

          <div class="text-center mt-2">
            <p class="text-[10px] text-gray-500 mb-1">Contract Address:</p>
            <code class="text-[9px] bg-gray-900 px-2 py-1 rounded text-gray-400 break-all select-all border border-gray-800 hover:border-green-500 cursor-pointer">0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5</code>
          </div>
        </div>
      </div>
      
      <div class="relative group hidden md:block">
        <img src="/prevent.png" alt="Pepe Swap" class="relative rounded-2xl shadow-2xl w-full border border-gray-800 opacity-90 hover:opacity-100 transition transform hover:scale-105 duration-500">
      </div>
    </section>

    <!-- PARTNERS SECTION (NEW) -->
    <section id="partners" class="border-t border-gray-800 pt-10 scroll-mt-24">
        <div class="text-center mb-10">
            <h2 class="text-2xl md:text-3xl text-white pixel-font mb-2">PARTNER PROGRAM</h2>
            <p class="text-sm text-gray-400">Earn up to <span class="text-green-500 font-bold">50% RevShare</span>. No Negative Carryover. Paid Weekly.</p>
        </div>

        <div class="grid md:grid-cols-12 gap-6">
            <!-- Left: Dashboard -->
            <div class="md:col-span-7 glass-panel p-6">
                <div id="partner-locked" class="text-center py-10">
                    <p class="text-gray-400 text-sm mb-4">Connect wallet to access your dashboard.</p>
                    <button onclick="modal.open()" class="action-btn px-6 py-2 rounded text-xs font-bold text-white">CONNECT WALLET</button>
                </div>

                <div id="partner-unlocked" class="hidden space-y-6">
                    <!-- Link Generator -->
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Your Referral Link</label>
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="refLinkInput" readonly class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white font-mono text-xs focus:border-green-500 outline-none">
                            <button onclick="copyRefLink()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 rounded font-bold text-xs border border-gray-600">COPY</button>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-black/40 p-3 rounded border border-gray-800">
                            <p class="text-[10px] text-gray-500">Tier</p>
                            <p class="text-lg text-white font-bold">Scout</p>
                            <p class="text-[9px] text-green-400">30% RevShare</p>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-gray-800">
                            <p class="text-[10px] text-gray-500">Referred</p>
                            <p class="text-lg text-white font-bold" id="refCount">0</p>
                            <p class="text-[9px] text-gray-500">Players</p>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-gray-800">
                            <p class="text-[10px] text-gray-500">Earnings</p>
                            <p class="text-lg text-green-400 font-bold font-mono">0.00</p>
                            <p class="text-[9px] text-gray-500">$PBJ</p>
                        </div>
                    </div>

                    <div class="bg-yellow-900/20 border border-yellow-600/30 p-4 rounded text-[10px] text-yellow-200">
                        Note: Stats update every 24h via backend sync. This is a simulation for the demo interface.
                    </div>
                </div>
            </div>

            <!-- Right: Info & Rules -->
            <div class="md:col-span-5 space-y-4">
                <!-- Tier Card -->
                <div class="bg-gradient-to-br from-gray-900 to-black border border-gray-800 rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-green-600 text-black text-[9px] font-bold px-2 py-1 rounded-bl">BEST OFFER</div>
                    <h3 class="text-white font-bold pixel-font text-sm mb-4">TIER SYSTEM</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs border-b border-gray-800 pb-2">
                            <span class="text-gray-400">Level 1 (Scout)</span>
                            <span class="text-white font-bold">30% Share</span>
                        </div>
                        <div class="flex justify-between text-xs border-b border-gray-800 pb-2">
                            <span class="text-gray-400">Level 2 (Captain)</span>
                            <span class="text-white font-bold">40% Share</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-400">Level 3 (Whale)</span>
                            <span class="text-green-400 font-bold">50% Share</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="openTerms()" class="flex-1 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white py-3 rounded text-xs font-bold transition">
                        READ TERMS
                    </button>
                    <a href="https://t.me/VortexDev21" target="_blank" class="flex-1 bg-[#229ED9] hover:bg-[#1d88bd] text-white py-3 rounded text-xs font-bold transition text-center flex items-center justify-center gap-2">
                        CONTACT ADMIN
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- GAMES LOBBY -->
    <section id="games">
      <h2 class="text-xl md:text-2xl text-white mb-6 flex items-center gap-2">
        <span class="text-green-500 pixel-font">GAMES LOBBY</span>
      </h2>
      
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- Blackjack (On Page) -->
        <a href="#blackjack" class="game-card group">
          <img src="games/media/blackjack.jpg" alt="Blackjack" onerror="this.src='https://placehold.co/400x300/064e3b/39ff14?text=Blackjack'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Blackjack</h3>
            <p class="text-[10px] text-gray-500">On-Chain Dealer</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">PLAY NOW</span></div>
        </a>

        <!-- Slots -->
        <a href="games/tragamonedas.html" class="game-card group">
          <img src="games/media/slots.jpg" alt="Slots" onerror="this.src='https://placehold.co/400x300/581c87/d8b4fe?text=Slots'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Pepe Slots</h3>
            <p class="text-[10px] text-gray-500">Spin & Win</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">SPIN</span></div>
        </a>

        <!-- Roulette -->
        <a href="games/ruleta.html" class="game-card group">
          <img src="games/media/ruleta.jpg" alt="Roulette" onerror="this.src='https://placehold.co/400x300/7f1d1d/fca5a5?text=Roulette'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Roulette</h3>
            <p class="text-[10px] text-gray-500">European Style</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">BET</span></div>
        </a>

        <!-- Plinko -->
        <a href="games/plinko.html" class="game-card group">
          <img src="games/media/plinko.jpg" alt="Plinko" onerror="this.src='https://placehold.co/400x300/be185d/f9a8d4?text=Plinko'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Plinko</h3>
            <p class="text-[10px] text-gray-500">High Volatility</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">DROP</span></div>
        </a>

        <!-- Poker -->
        <a href="games/poker.html" class="game-card group">
          <img src="games/media/poker.jpg" alt="Poker" onerror="this.src='https://placehold.co/400x300/1e3a8a/93c5fd?text=Poker'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Poker</h3>
            <p class="text-[10px] text-gray-500">Video Poker</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">DEAL</span></div>
        </a>

        <!-- Dice -->
        <a href="games/dados.html" class="game-card group">
          <img src="games/media/dados.jpg" alt="Dice" onerror="this.src='https://placehold.co/400x300/b45309/fcd34d?text=Dice'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Cyber Dice</h3>
            <p class="text-[10px] text-gray-500">Hi-Lo Game</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">ROLL</span></div>
        </a>
        
        <!-- Mines -->
        <a href="games/minas.html" class="game-card group">
          <img src="games/media/minas.jpg" alt="Mines" onerror="this.src='https://placehold.co/400x300/374151/9ca3af?text=Mines'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Pepe Mines</h3>
            <p class="text-[10px] text-gray-500">Avoid the Bombs</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">DIG</span></div>
        </a>

        <!-- Crash -->
        <a href="games/crash.html" class="game-card group">
          <img src="games/media/crash.jpg" alt="Crash" onerror="this.src='https://placehold.co/400x300/ef4444/111?text=Crash'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Pepe Crash</h3>
            <p class="text-[10px] text-gray-500">To the Moon</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">FLY</span></div>
        </a>
      </div>
    </section>

     <!-- Tower -->
        <a href="games/tower.html" class="game-card group">
          <img src="games/media/tower.jpg" alt="Tower" onerror="this.src='https://placehold.co/400x300/facc15/111?text=Tower'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Pepe Tower</h3>
            <p class="text-[10px] text-gray-500">Climb & Win</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">CLIMB</span></div>
        </a>

        <!-- Keno -->
        <a href="games/keno.html" class="game-card group">
          <img src="games/media/keno.jpg" alt="Keno" onerror="this.src='https://placehold.co/400x300/a855f7/111?text=Keno'">
          <div class="p-3 bg-gray-900 border-t border-gray-800">
            <h3 class="text-xs text-white font-bold pixel-font">Pepe Keno</h3>
            <p class="text-[10px] text-gray-500">Classic Lottery</p>
          </div>
          <div class="play-overlay"><span class="action-btn px-4 py-2 rounded text-xs font-bold text-white">PICK</span></div>
        </a>

    <!-- NFT MINTING SHOP -->
    <section id="shop" class="space-y-6 pt-10 border-t border-gray-800">
      <div class="text-center">
        <h2 class="text-2xl text-white pixel-font mb-2">MINT & STAKE</h2>
        <p class="text-xs text-gray-400">Buy NFTs with $PBJ. Stake them to earn passive income.</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <!-- Tier 0 -->
        <div class="glass-panel p-3 text-center card-nft">
          <img src="nft1.jpg" alt="Common NFT" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-700 shadow-lg" onerror="this.src='https://placehold.co/200x200?text=NFT1'">
          <h3 class="text-xs font-bold text-gray-300">COMMON</h3>
          <p class="text-[10px] text-green-400 my-2">Price: 5k PBJ<br>Earn: 50/day</p>
          <button onclick="mintNFT(0)" class="w-full bg-gray-800 hover:bg-green-600 hover:text-black text-[10px] py-2 rounded font-bold border border-gray-600 transition">MINT</button>
        </div>

        <!-- Tier 1 -->
        <div class="glass-panel p-3 text-center card-nft">
          <img src="nft2.jpg" alt="Uncommon NFT" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-700 shadow-lg" onerror="this.src='https://placehold.co/200x200?text=NFT2'">
          <h3 class="text-xs font-bold text-blue-300">UNCOMMON</h3>
          <p class="text-[10px] text-green-400 my-2">Price: 10k PBJ<br>Earn: 120/day</p>
          <button onclick="mintNFT(1)" class="w-full bg-gray-800 hover:bg-blue-600 hover:text-black text-[10px] py-2 rounded font-bold border border-gray-600 transition">MINT</button>
        </div>

        <!-- Tier 2 -->
        <div class="glass-panel p-3 text-center card-nft">
          <img src="nft3.jpg" alt="Rare NFT" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-700 shadow-lg" onerror="this.src='https://placehold.co/200x200?text=NFT3'">
          <h3 class="text-xs font-bold text-purple-300">RARE</h3>
          <p class="text-[10px] text-green-400 my-2">Price: 25k PBJ<br>Earn: 350/day</p>
          <button onclick="mintNFT(2)" class="w-full bg-gray-800 hover:bg-purple-600 hover:text-black text-[10px] py-2 rounded font-bold border border-gray-600 transition">MINT</button>
        </div>

        <!-- Tier 3 -->
        <div class="glass-panel p-3 text-center card-nft">
          <img src="nft4.jpg" alt="Epic NFT" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-700 shadow-lg" onerror="this.src='https://placehold.co/200x200?text=NFT4'">
          <h3 class="text-xs font-bold text-yellow-300">EPIC</h3>
          <p class="text-[10px] text-green-400 my-2">Price: 50k PBJ<br>Earn: 800/day</p>
          <button onclick="mintNFT(3)" class="w-full bg-gray-800 hover:bg-yellow-600 hover:text-black text-[10px] py-2 rounded font-bold border border-gray-600 transition">MINT</button>
        </div>

        <!-- Tier 4 -->
        <div class="glass-panel p-3 text-center card-nft border-red-500/30">
          <img src="nft5.png" alt="Legend NFT" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-700 shadow-lg" onerror="this.src='https://placehold.co/200x200?text=NFT5'">
          <h3 class="text-xs font-bold text-red-400">LEGEND</h3>
          <p class="text-[10px] text-green-400 my-2">Price: 100k PBJ<br>Earn: 2k/day</p>
          <button onclick="mintNFT(4)" class="w-full bg-gray-800 hover:bg-red-600 hover:text-black text-[10px] py-2 rounded font-bold border border-gray-600 transition">MINT</button>
        </div>
      </div>
    </section>

    <!-- STAKING DASHBOARD -->
    <section id="staking" class="grid md:grid-cols-2 gap-8">
      <!-- VAULT INFO -->
      <div class="glass-panel p-6 border-t-4 border-t-green-500">
        <h2 class="text-lg text-white pixel-font mb-6">YOUR VAULT</h2>
        
        <div class="flex justify-between items-center bg-black/40 p-4 rounded-lg mb-4 border border-gray-800">
          <div><p class="text-xs text-gray-400">Total Staked</p><p id="total-staked" class="text-xl text-white font-mono">0 NFT</p></div>
          <div><p class="text-xs text-gray-400">Daily Yield</p><p id="daily-yield" class="text-xl text-green-400 font-mono">0 PBJ</p></div>
        </div>
        
        <div class="text-center mb-6">
          <p class="text-xs text-gray-500 mb-1">Unclaimed Rewards</p>
          <p id="pending-rewards" class="text-3xl font-mono text-green-400 animate-pulse">0.0000</p>
          <p class="text-[10px] text-gray-600">Updates live</p>
        </div>
        
        <button id="claimBtn" onclick="claimRewards()" class="w-full action-btn text-white font-bold py-3 rounded pixel-font text-xs tracking-widest">
          CLAIM REWARDS
        </button>
      </div>

      <!-- INVENTORY -->
      <div class="glass-panel p-6 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg text-white pixel-font">INVENTORY</h2>
          <button onclick="loadUserData()" class="text-[10px] text-green-400 hover:text-white">↻ Refresh</button>
        </div>

        <div id="inventory-list" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
          <p class="text-xs text-gray-500 text-center mt-10">Connect wallet to view NFTs.</p>
        </div>
      </div>
    </section>

    <!-- BLACKJACK TABLE -->
    <section id="blackjack" class="space-y-6 pt-10 border-t border-gray-800">
      <div class="text-center space-y-2">
        <h2 class="text-xl md:text-2xl text-green-400 pixel-font">BLACKJACK TABLE</h2>
        <p class="text-xs text-gray-400">Status: <span id="gameState" class="text-white font-bold">Open</span></p>
      </div>

      <div class="relative max-w-4xl mx-auto">
        <div class="table-felt min-h-[450px] flex flex-col justify-between relative">
          <div class="table-line"></div>
          <div class="flex flex-col items-center gap-2 z-10">
            <div class="bg-black/60 text-white px-4 py-1 rounded-full border border-white/10 shadow-lg backdrop-blur-sm">
              <span class="text-[10px] text-gray-400 uppercase tracking-widest mr-2">DEALER</span>
              <span id="dealerScore" class="font-mono font-bold text-green-400">0</span>
            </div>
            <div id="dealerArea" class="flex justify-center gap-2 md:gap-4 min-h-[110px] perspective-500"></div>
          </div>
          <div id="resultMsg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none transition-all w-full text-center px-4"></div>
          <div class="flex flex-col items-center gap-4 z-10 pb-4">
            <div id="playerArea" class="flex justify-center gap-2 md:gap-4 min-h-[110px]"></div>
            <div class="bg-black/80 px-6 py-2 rounded-xl border border-green-500/50 shadow-[0_0_20px_rgba(34,197,94,0.3)] flex items-center gap-6 backdrop-blur-md">
               <div>
                 <p class="text-[10px] text-gray-400 uppercase">YOUR SCORE</p>
                 <p id="playerScore" class="text-white font-bold text-center text-lg">0</p>
               </div>
               <div class="h-8 w-px bg-gray-600"></div>
               <div>
                 <p class="text-[10px] text-gray-400 uppercase">CURRENT BET</p>
                 <p class="text-green-400 font-bold text-center text-lg"><span id="activeBetDisplay">0</span> PBJ</p>
               </div>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-panel p-4 max-w-xl mx-auto mt-4">
        <div class="flex flex-wrap items-center justify-center gap-4 mb-3">
          <span class="text-xs text-gray-400">Info:</span>
          <span id="betStatus" class="text-xs font-mono text-yellow-400">Place your bet to start</span>
        </div>
        <div class="flex flex-wrap items-center justify-center gap-3" id="bettingControls">
          <div class="flex items-center bg-black/40 rounded-lg border border-gray-700 overflow-hidden">
            <span class="px-3 text-gray-500 text-[10px] font-bold">BET</span>
            <input type="number" id="betAmount" value="1000" step="100" class="w-28 bg-transparent p-3 text-white outline-none font-mono text-sm font-bold">
            <span class="pr-3 text-gray-500 text-[10px]">PBJ</span>
          </div>
          <button id="btnDeal" class="action-btn text-white px-8 py-3 rounded-lg pixel-font text-xs tracking-wide">DEAL CARDS</button>
        </div>
        <div class="hidden flex-wrap items-center justify-center gap-2 md:gap-4" id="playControls">
          <button id="btnHit" class="bg-blue-600 hover:bg-blue-500 border-b-4 border-blue-800 active:border-0 active:translate-y-1 text-white px-5 py-3 rounded-lg pixel-font text-[10px] transition-all shadow-lg">HIT</button>
          <button id="btnStand" class="bg-red-600 hover:bg-red-500 border-b-4 border-red-800 active:border-0 active:translate-y-1 text-white px-5 py-3 rounded-lg pixel-font text-[10px] transition-all shadow-lg">STAND</button>
          <button id="btnDouble" class="bg-yellow-600 hover:bg-yellow-500 border-b-4 border-yellow-800 active:border-0 active:translate-y-1 text-white px-5 py-3 rounded-lg pixel-font text-[10px] transition-all shadow-lg">DOUBLE</button>
          <button id="btnCancel" class="bg-gray-600 hover:bg-gray-500 border-b-4 border-gray-800 active:border-0 active:translate-y-1 text-white px-5 py-3 rounded-lg pixel-font text-[10px] transition-all shadow-lg">GIVE UP</button>
        </div>
      </div>
    </section>

    <!-- TOKENOMICS -->
    <section id="tokenomics" class="grid md:grid-cols-2 gap-10 pt-10 pb-10 border-t border-gray-800">
      <div class="flex flex-col items-center justify-center">
        <h2 class="text-xl text-white mb-6 pixel-font">DISTRIBUTION</h2>
        <div class="pie-chart"></div>
      </div>
      <div class="flex flex-col justify-center space-y-4">
        <h2 class="text-xl text-white mb-4 pixel-font">ROADMAP</h2>
        <div class="border-l-2 border-green-900 pl-4 space-y-4">
          <div><h4 class="text-green-400 text-xs font-bold">Q1 2025</h4><p class="text-[10px] text-gray-500">Presale & Blackjack Launch</p></div>
          <div><h4 class="text-blue-400 text-xs font-bold">Q2 2025</h4><p class="text-[10px] text-gray-500">NFT Staking & Slots</p></div>
          <div><h4 class="text-purple-400 text-xs font-bold">Q3 2025</h4><p class="text-[10px] text-gray-500">Mobile App & CEX</p></div>
        </div>
      </div>
    </section>

  </main>

  <footer class="border-t border-white/10 bg-black/80 py-8 mt-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <div class="flex justify-center gap-4 text-gray-400 text-xs mb-4">
        <a href="#" class="hover:text-green-400">Smart Contract</a>
        <a href="#" class="hover:text-green-400">Twitter</a>
        <a href="#" class="hover:text-green-400">Telegram</a>
      </div>
      <p class="text-[10px] text-gray-700 font-mono">© 2025 PBJ CASINO. Not financial advice.</p>
    </div>
  </footer>

  <!-- LOGIC SCRIPT: Web3Modal v3 + Ethers v5 -->
  <script type="module">
    import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers5@3.5.7'
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    /* --- UI HELPERS & MODALS --- */
    const toast = (msg, type = 'success') => {
      const c = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = `toast ${type} show`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
    };
    const formatNum = (n) => new Intl.NumberFormat('en-US').format(n);

    // Expose global functions for Modals
    window.openTerms = () => { document.getElementById('termsModal').style.display = 'grid'; };
    window.closeTerms = () => { document.getElementById('termsModal').style.display = 'none'; };
    
    /* --- REFERRAL LOGIC (ON LOAD) --- */
    // Detect ?ref=WALLET in URL
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');
    if(refParam) {
        localStorage.setItem('referrer', refParam);
        console.log("Referred by:", refParam);
        // In a backend system, you would send this to API on connect
    }

    /* --- CONFIGURATION --- */
    const projectId = '06606e3b978574fe1fe67024c91c5aa3'; // Reemplazar en producción
    const mainnet = {
      chainId: 8453,
      name: 'Base',
      currency: 'ETH',
      explorerUrl: 'https://basescan.org',
      rpcUrl: 'https://mainnet.base.org'
    }
    const metadata = {
      name: 'PBJ Casino',
      description: 'Pepe Blackjack Casino on Base',
      url: window.location.href,
      icons: ['https://avatars.githubusercontent.com/u/37784886']
    }

    /* --- WEB3MODAL INIT --- */
    const modal = createWeb3Modal({
      ethersConfig: defaultConfig({ metadata }),
      chains: [mainnet],
      projectId,
      enableAnalytics: true
    });

    /* --- CONTRACTS --- */
    const rate = 1000000;
    const contractAddress='0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
    const pbjTokenAddress='0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
    const casinoAddress='0x79e617b64eae98bda7f8Cd4b1EdC05dE696E4B74';
    const nftAddress='0xDE05dAf2cbF59ce9094979d639393ADED494e920';

    const pbjAbi = ['function balanceOf(address) view returns (uint256)','function approve(address, uint256) returns (bool)','function allowance(address, address) view returns (uint256)'];
    const casinoAbi = ['function placeBet(uint256) external','function finishGame(bool) external','function cancelBet() external'];
    const presaleAbi = ['function buyTokens() payable'];
    const nftAbi = ["function mint(uint256 id, uint256 amount) external","function stake(uint256 id, uint256 amount) external","function unstake(uint256 id, uint256 amount) external","function claim() external","function getPendingRewards(address user) view returns (uint256)","function getStakedBalance(address user, uint256 id) view returns (uint256)","function balanceOf(address account, uint256 id) view returns (uint256)","function setApprovalForAll(address operator, bool approved) external","function isApprovedForAll(address account, address operator) view returns (bool)","function tierInfo(uint256 id) view returns (uint256 price, uint256 rewardPerSec, bool active)"];

    let userAddress, signer, provider;
    let pbjContract, casinoContract, presaleContract, nftContract;

    /* --- CONNECTION LOGIC --- */
    document.getElementById('connectBtn').addEventListener('click', () => modal.open());
    modal.subscribeProvider(handleProviderChange);

    async function handleProviderChange({ provider: walletProvider, address, chainId }) {
       if(walletProvider && address) {
           provider = new ethers.providers.Web3Provider(walletProvider);
           signer = provider.getSigner();
           userAddress = address;

           // Init Contracts
           pbjContract = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);
           casinoContract = new ethers.Contract(casinoAddress, casinoAbi, signer);
           presaleContract = new ethers.Contract(contractAddress, presaleAbi, signer);
           nftContract = new ethers.Contract(nftAddress, nftAbi, signer);

           // UI Updates
           const btn = document.getElementById('connectBtn');
           btn.textContent = address.substring(0,5) + "..." + address.substring(38);
           btn.classList.replace('bg-green-600','bg-gray-800');
           
           document.getElementById('walletDisplay').classList.remove('hidden');
           document.getElementById('walletDisplay').classList.add('flex');
           
           // Partner Dashboard Unlock
           document.getElementById('partner-locked').classList.add('hidden');
           document.getElementById('partner-unlocked').classList.remove('hidden');
           
           // Generate Referral Link for User
           const currentUrl = window.location.origin + window.location.pathname;
           document.getElementById('refLinkInput').value = `${currentUrl}?ref=${address}`;

           // Check Registration
           checkRegistration(address);

           await updateBalances();
           loadUserData();
           toast("Wallet Connected!");
           setInterval(simulateLiveRewards, 1000);
       } else {
           // Reset UI
           document.getElementById('partner-locked').classList.remove('hidden');
           document.getElementById('partner-unlocked').classList.add('hidden');
           document.getElementById('connectBtn').textContent = "CONNECT";
           document.getElementById('walletDisplay').classList.add('hidden');
           userAddress = null; signer = null;
       }
    }

    /* --- REGISTRATION SYSTEM (LocalStorage Simulation) --- */
    function checkRegistration(addr) {
        const storedName = localStorage.getItem(`user_${addr}`);
        const refName = document.getElementById('userNameDisplay');
        
        if(!storedName) {
            // New User - Show Modal
            document.getElementById('regModal').style.display = 'grid';
        } else {
            // Existing User
            refName.textContent = storedName;
            refName.classList.remove('hidden');
            // If they were referred, show welcome toast
            const referredBy = localStorage.getItem('referrer');
            if(referredBy) {
                toast(`Welcome! You were referred by ${referredBy.substring(0,6)}...`, "success");
            }
        }
    }

    window.completeRegistration = () => {
        const input = document.getElementById('regUsername');
        const name = input.value.trim().toUpperCase();
        if(name.length < 3) return toast("Name too short", "error");
        
        // Save locally (Simulating backend DB)
        localStorage.setItem(`user_${userAddress}`, name);
        
        // UI Update
        document.getElementById('userNameDisplay').textContent = name;
        document.getElementById('userNameDisplay').classList.remove('hidden');
        document.getElementById('regModal').style.display = 'none';
        toast("Account Created!", "success");
        if(window.confetti) confetti();
    };

    // Copy Function for Partners
    window.copyRefLink = () => {
        const copyText = document.getElementById("refLinkInput");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        toast("Link Copied!", "success");
    };

    /* --- BALANCE UPDATES --- */
    async function updateBalances() {
      if(!userAddress || !signer) return;
      try {
        if(pbjContract) {
             const pbj = await pbjContract.balanceOf(userAddress);
             const pbjFmt = formatNum(parseInt(ethers.utils.formatUnits(pbj, 18)));
             const pbjHeader = document.getElementById('pbjBalanceHeader');
             if(pbjHeader) pbjHeader.textContent = pbjFmt;
        }
      } catch(e) { console.error("PBJ Balance Error", e); }
    }

    /* --- SWAP LOGIC --- */
    const inputTop = document.getElementById('input-top');
    const inputBottom = document.getElementById('input-bottom');
    const swapBtn = document.getElementById('swapDirBtn');
    const buyBtn = document.getElementById('buyBtn');
    let isBuyMode = true;

    if(inputTop) inputTop.addEventListener('input', () => {
        const val = parseFloat(inputTop.value);
        if(!isNaN(val) && isBuyMode) inputBottom.value = (val * rate).toFixed(0);
    });

    window.setEth = function(amount) {
        if (!isBuyMode) { toast("Switch to BUY mode", "error"); return; }
        inputTop.value = amount;
        inputBottom.value = (amount * rate).toFixed(0);
    };

    if(swapBtn) swapBtn.addEventListener('click', () => {
        isBuyMode = !isBuyMode;
        document.getElementById('swap-mode-text').textContent = isBuyMode ? "MODE: BUY" : "MODE: SELL (LOCKED)";
        if(!isBuyMode) {
            buyBtn.disabled = true; buyBtn.classList.add('bg-red-900');
            buyBtn.textContent = "LIQUIDITY LOCKED";
        } else {
            buyBtn.disabled = false; buyBtn.classList.remove('bg-red-900');
            buyBtn.textContent = "BUY PBJ";
        }
    });

    if(buyBtn) buyBtn.addEventListener('click', async () => {
        if (!isBuyMode || !signer) { if(!signer) modal.open(); return; }
        const val = parseFloat(inputTop.value);
        if (!val || val <= 0) return toast("Invalid Amount", "error");
        
        buyBtn.textContent = "OPEN WALLET...";
        try {
            const tx = await presaleContract.buyTokens({ value: ethers.utils.parseEther(val.toString()), gasLimit: 500000 });
            buyBtn.textContent = "MINING...";
            await tx.wait();
            toast("Purchase Successful!", "success");
            if (window.confetti) confetti();
            updateBalances();
        } catch (e) { toast("Transaction Failed", "error"); } 
        finally { buyBtn.textContent = "BUY PBJ"; }
    });

    /* --- NFT/STAKING LOGIC --- */
    window.mintNFT = async (id) => {
        if(!signer) { modal.open(); return; }
        try {
            const info = await nftContract.tierInfo(id);
            const allowance = await pbjContract.allowance(userAddress, nftAddress);
            if(allowance.lt(info.price)) {
                toast("Approving PBJ...", "success");
                await (await pbjContract.approve(nftAddress, ethers.constants.MaxUint256)).wait();
            }
            toast("Minting...", "success");
            await (await nftContract.mint(id, 1, { gasLimit: 200000 })).wait();
            toast("Mint Successful!", "success");
            loadUserData(); updateBalances();
        } catch(e) { toast("Mint Failed", "error"); }
    };

    window.stakeNFT = async (id) => {
        if(!signer) return;
        try {
            const isApproved = await nftContract.isApprovedForAll(userAddress, nftAddress);
            if(!isApproved) await (await nftContract.setApprovalForAll(nftAddress, true)).wait();
            await (await nftContract.stake(id, 1, { gasLimit: 200000 })).wait();
            toast("Staked!", "success"); loadUserData();
        } catch(e) { toast("Stake Failed", "error"); }
    };

    window.unstakeNFT = async (id) => {
        if(!signer) return;
        try {
            await (await nftContract.unstake(id, 1, { gasLimit: 200000 })).wait();
            toast("Unstaked!", "success"); loadUserData();
        } catch(e) { toast("Unstake Failed", "error"); }
    };

    window.claimRewards = async () => {
        if(!signer) return;
        try {
            await (await nftContract.claim({ gasLimit: 200000 })).wait();
            toast("Rewards Claimed!", "success"); updateBalances(); loadUserData();
        } catch(e) { toast("Error Claiming", "error"); }
    };

    /* --- DASHBOARD DATA --- */
    let currentRewardRate = 0;
    window.loadUserData = async () => {
        if(!signer) return;
        const list = document.getElementById('inventory-list');
        list.innerHTML = '<p class="text-xs text-gray-500 text-center">Loading...</p>';
        
        let html = '', totalStaked = 0, dailyYield = 0;
        const tiers = ["COMMON", "UNCOMMON", "RARE", "EPIC", "LEGEND"];
        const rates = [50, 120, 350, 800, 2000];

        for(let i=0; i<5; i++) {
            const bal = parseInt(await nftContract.balanceOf(userAddress, i));
            const staked = parseInt(await nftContract.getStakedBalance(userAddress, i));
            totalStaked += staked; dailyYield += (staked * rates[i]);
            if(bal > 0) html += `<div class="bg-gray-900 p-3 rounded border border-gray-700 flex justify-between items-center mb-2"><div><p class="text-xs text-white font-bold">${tiers[i]} (${bal})</p></div><button onclick="stakeNFT(${i})" class="bg-green-600 text-black text-[10px] px-3 py-1 rounded font-bold">STAKE</button></div>`;
            if(staked > 0) html += `<div class="bg-green-900/20 p-3 rounded border border-green-600/50 flex justify-between items-center mb-2"><div><p class="text-xs text-green-300 font-bold">STAKED: ${tiers[i]} (${staked})</p></div><button onclick="unstakeNFT(${i})" class="bg-gray-700 text-white text-[10px] px-3 py-1 rounded">UNSTAKE</button></div>`;
        }
        list.innerHTML = html || '<p class="text-xs text-gray-500 text-center">No NFTs found.</p>';
        document.getElementById('total-staked').textContent = totalStaked + " NFT";
        document.getElementById('daily-yield').textContent = dailyYield + " PBJ/day";
        currentRewardRate = dailyYield / 86400;
        const pending = await nftContract.getPendingRewards(userAddress);
        document.getElementById('pending-rewards').dataset.val = parseFloat(ethers.utils.formatUnits(pending, 18));
    };

    function simulateLiveRewards() {
        if(!currentRewardRate) return;
        const el = document.getElementById('pending-rewards');
        let current = parseFloat(el.dataset.val || 0);
        current += currentRewardRate;
        el.dataset.val = current;
        el.textContent = current.toFixed(6);
    }

    /* --- BLACKJACK --- */
    const ui = { deal:document.getElementById('btnDeal'), hit:document.getElementById('btnHit'), stand:document.getElementById('btnStand'), double:document.getElementById('btnDouble'), cancel:document.getElementById('btnCancel') };
    let deck=[], pHand=[], dHand=[], gameActive=false;

    function buildDeck() { const s=['♠','♥','♦','♣'], v=['A','2','3','4','5','6','7','8','9','10','J','Q','K']; deck=[]; s.forEach(S=>v.forEach(V=>deck.push({s:S,v:V}))); deck.sort(()=>Math.random()-0.5); }
    function val(c){ if(c.v==='A')return 11; if(['K','Q','J'].includes(c.v))return 10; return parseInt(c.v); }
    function score(h){ let s=0,a=0; h.forEach(c=>{s+=val(c); if(c.v==='A')a++}); while(s>21&&a>0){s-=10;a--} return s; }
    function cardHTML(c,hide){
       if(hide) return `<div class="card bg-blue-900 border-2 border-white flex items-center justify-center text-white text-2xl reveal">?</div>`;
       const col = (c.s==='♥'||c.s==='♦')?'red':'black';
       return `<div class="card ${col} reveal"><span class="corner-val tl">${c.v}<br>${c.s}</span>${c.s}<span class="corner-val br">${c.v}<br>${c.s}</span></div>`;
    }
    function render(hideD=true){
       document.getElementById('dealerArea').innerHTML = dHand.map((c,i)=>cardHTML(c,hideD&&i===1)).join('');
       document.getElementById('playerArea').innerHTML = pHand.map(c=>cardHTML(c)).join('');
       document.getElementById('playerScore').textContent = score(pHand);
       document.getElementById('dealerScore').textContent = hideD ? "?" : score(dHand);
    }
    function toggleControls(on){
       document.getElementById('bettingControls').classList.toggle('hidden', on);
       document.getElementById('bettingControls').classList.toggle('flex', !on);
       document.getElementById('playControls').classList.toggle('hidden', !on);
       document.getElementById('playControls').classList.toggle('flex', on);
    }
    function msg(txt, type){
       const el = document.getElementById('resultMsg');
       const bg = type==='win'?'bg-green-600':type==='lose'?'bg-red-600':'bg-gray-600';
       el.innerHTML = `<div class="${bg} text-white px-6 py-3 rounded-full shadow-xl border-2 border-white animate-bounce font-bold tracking-wider">${txt}</div>`;
       if(type==='win') confetti();
       setTimeout(()=>el.innerHTML='', 3000);
    }

    ui.deal.addEventListener('click', async () => {
       if(!signer) { modal.open(); return; }
       const amt = document.getElementById('betAmount').value;
       ui.deal.textContent = "OPEN WALLET..."; ui.deal.disabled=true;
       try {
         const raw = ethers.utils.parseUnits(amt, 18);
         const allowance = await pbjContract.allowance(userAddress, casinoAddress);
         if(allowance.lt(raw)) await (await pbjContract.approve(casinoAddress, ethers.constants.MaxUint256, {gasLimit:100000})).wait();
         const tx = await casinoContract.placeBet(raw, {gasLimit: 300000});
         await tx.wait();
         buildDeck(); pHand=[deck.pop(),deck.pop()]; dHand=[deck.pop(),deck.pop()];
         gameActive=true; document.getElementById('activeBetDisplay').textContent=amt;
         render(true); toggleControls(true);
         if(score(pHand)===21) { msg("BLACKJACK!", "win"); await (await casinoContract.finishGame(true, {gasLimit:200000})).wait(); reset(); }
       } catch(e) { toast("Bet Failed", "error"); }
       finally { ui.deal.textContent="DEAL CARDS"; ui.deal.disabled=false; }
    });

    ui.hit.addEventListener('click', ()=>{
       pHand.push(deck.pop()); render(true);
       if(score(pHand)>21) { msg("BUST!", "lose"); end(false); }
    });

    ui.stand.addEventListener('click', async ()=>{
       while(score(dHand)<17) { await new Promise(r=>setTimeout(r,800)); dHand.push(deck.pop()); render(false); }
       const p=score(pHand), d=score(dHand);
       if(d>21 || p>d) { msg("YOU WIN!", "win"); end(true); }
       else if(p===d) { msg("PUSH", "push"); end(false); }
       else { msg("HOUSE WINS", "lose"); end(false); }
    });

    async function end(win){ try{ await (await casinoContract.finishGame(win, {gasLimit:200000})).wait(); reset(); }catch(e){} }
    function reset(){ gameActive=false; toggleControls(false); }
  </script>
</body>
</html>


