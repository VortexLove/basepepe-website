<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>PBJ - Cyber Casino</title>
  <meta name="description" content="The #1 Meme Casino on Base." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Press+Start+2P&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- External Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            pixel: ['"Press Start 2P"', 'cursive'],
            tech: ['"Rajdhani"', 'sans-serif'],
            sans: ['"Inter"', 'sans-serif'],
          },
          colors: {
            neon: '#39ff14',
            dark: '#020202',
            panel: '#0a0f0c',
          },
          animation: {
            'spin-slow': 'spin 20s linear infinite',
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --neon-green: #39ff14;
      --glass-bg: rgba(5, 10, 7, 0.85);
      --glass-border: rgba(57, 255, 20, 0.3);
    }
    
    body { background-color: #020202; color: #e0e0e0; overflow-x: hidden; font-family: 'Rajdhani', sans-serif; }

    /* --- BACKGROUND FX --- */
    .cyber-grid {
      position: fixed; inset: 0; z-index: -2;
      background: 
        linear-gradient(transparent 0%, rgba(0,0,0,1) 100%),
        linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px),
        linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      transform: perspective(500px) rotateX(60deg) scale(2.5);
      transform-origin: top center;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
    }
    @keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 0 500px; } }

    /* --- UI ELEMENTS --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 20px rgba(57, 255, 20, 0.05);
      border-radius: 4px;
      position: relative;
    }
    
    /* Glitch Text */
    .glitch-text { position: relative; color: white; text-shadow: 2px 2px var(--neon-green); }
    .glitch-text::before { content: attr(data-text); position: absolute; top: 0; left: 2px; color: #ff00ff; opacity: 0.8; mix-blend-mode: multiply; animation: glitch-anim 2s infinite linear alternate-reverse; }
    @keyframes glitch-anim { 0% { clip-path: inset(20% 0 80% 0); transform: translate(-2px,1px); } 100% { clip-path: inset(10% 0 60% 0); transform: translate(2px,-1px); } }

    /* Buttons */
    .action-btn {
      background: linear-gradient(90deg, #000, #064e3b);
      border: 1px solid var(--neon-green); color: var(--neon-green);
      text-transform: uppercase; font-family: 'Press Start 2P'; font-size: 10px;
      padding: 12px 24px; cursor: pointer; transition: all 0.2s;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      box-shadow: 0 0 5px var(--neon-green);
    }
    .action-btn:hover:not(:disabled) { background: var(--neon-green); color: black; box-shadow: 0 0 25px var(--neon-green); }
    .action-btn:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.5; }

    .btn-secondary { background: #222; border: 1px solid #555; color: white; font-family: 'Rajdhani'; font-weight: bold; }
    
    /* Inputs */
    .cyber-input {
        background: rgba(0,0,0,0.7); border: 1px solid #333; color: white;
        font-family: 'Rajdhani'; font-weight: bold; width: 100%; transition: 0.3s;
    }
    .cyber-input:focus { border-color: var(--neon-green); outline: none; box-shadow: 0 0 10px rgba(57,255,20,0.3); }

    /* --- GAMES SPECIFIC --- */
    
    /* Card Visuals */
    .card-visual {
        width: 50px; height: 75px; background: white; border-radius: 4px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-weight: bold; font-family: sans-serif; font-size: 18px; line-height: 1;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.8); animation: slideInCard 0.3s ease-out;
    }
    .card-red { color: #ef4444; } .card-black { color: #171717; }
    @keyframes slideInCard { from { transform: translateY(-20px) scale(0.5); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    /* Mines Grid */
    .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 300px; margin: 0 auto; }
    .mine-tile {
        aspect-ratio: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 4px;
        cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px;
        transition: all 0.2s;
    }
    .mine-tile:hover { border-color: var(--neon-green); background: rgba(57,255,20,0.1); }
    .mine-tile.selected { background: var(--neon-green); color: black; box-shadow: 0 0 10px var(--neon-green); transform: scale(0.95); }
    .mine-tile.revealed-safe { background: #064e3b; border-color: #10b981; color: #10b981; }
    .mine-tile.revealed-bomb { background: #7f1d1d; border-color: #ef4444; animation: shake 0.4s; }

    /* Game Cards */
    .game-card { position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #333; transition: 0.3s; background: #050505; }
    .game-card:hover { transform: translateY(-5px); border-color: var(--neon-green); box-shadow: 0 0 20px rgba(57,255,20,0.2); z-index: 10; }
    .game-card img { width: 100%; height: 160px; object-fit: cover; filter: grayscale(0.8); transition: 0.3s; }
    .game-card:hover img { filter: grayscale(0); }

    @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, -2px); } }
    
    /* Toast */
    .toast-enter { animation: slideInRight 0.3s forwards; }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

  <div class="cyber-grid"></div>
  <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

  <!-- GAME MODAL -->
  <div id="gameModal" class="fixed inset-0 bg-black/95 z-[9990] hidden items-center justify-center backdrop-blur-sm">
    <div class="glass-panel p-1 w-[95%] max-w-lg max-h-[90vh] overflow-y-auto relative">
        <button onclick="closeGame()" class="absolute top-4 right-4 text-gray-500 hover:text-neon font-pixel z-50">X</button>
        
        <div class="bg-black/90 p-6 h-full relative overflow-hidden">
            <!-- Modal Header -->
            <div class="flex items-center gap-4 mb-6 border-b border-gray-800 pb-4">
                <div class="text-4xl filter drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]" id="modalIcon">üé∞</div>
                <div>
                    <h2 id="modalTitle" class="text-xl text-white font-pixel text-neon">GAME</h2>
                    <p class="text-xs text-gray-400 font-mono tracking-widest">PROVABLY FAIR ‚Ä¢ ON-CHAIN</p>
                </div>
            </div>

            <!-- Game Area -->
            <div id="innerGameContent" class="min-h-[200px] flex flex-col items-center justify-center mb-6 py-4 bg-gray-900/50 border border-gray-800 rounded relative">
                <!-- Dynamic Content Here -->
            </div>

            <!-- Controls -->
            <div class="bg-gray-900 border border-gray-700 p-4 rounded">
                <div class="flex justify-between text-[10px] text-gray-400 mb-2 uppercase font-mono">
                    <span>Bet Amount</span>
                    <span>Balance: <span id="modalBalance" class="text-neon">0</span> PBJ</span>
                </div>
                <div class="flex gap-2 mb-3">
                    <input type="number" id="gameBetInput" value="1000" class="cyber-input px-4 py-2 text-center" placeholder="Bet">
                    <button id="gameActionBtn" class="action-btn whitespace-nowrap flex-1">PLAY</button>
                </div>
                <!-- Extra Interactions (Hit/Stand/etc) -->
                <div id="gameExtraControls" class="flex gap-2 justify-center hidden"></div>
            </div>
            
            <div id="gameStatus" class="text-center mt-4 text-xs font-mono uppercase tracking-widest text-gray-500">READY</div>
        </div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="sticky top-0 z-50 bg-black/90 backdrop-blur-md border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
      <div class="flex items-center gap-3 group cursor-pointer">
        <div class="w-8 h-8 bg-gradient-to-tr from-green-700 to-neon rounded shadow-[0_0_10px_var(--neon-green)] group-hover:animate-pulse"></div>
        <span class="text-neon font-pixel text-sm md:text-base">PBJ CASINO</span>
      </div>
      
      <div class="flex items-center gap-4">
         <div id="walletDisplay" class="hidden flex-col text-right mr-2">
            <span class="text-[8px] text-gray-500 uppercase">Balance</span>
            <span class="text-xs text-white font-mono font-bold"><span id="headerBalance">0</span> PBJ</span>
        </div>
        <button id="connectBtn" class="action-btn py-2 px-4 text-[8px] md:text-[10px]">CONNECT WALLET</button>
      </div>
    </div>
  </nav>

  <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-8 space-y-20 z-10 relative">

    <!-- PRESALE HERO -->
    <section id="presale" class="pt-4">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="space-y-6 relative">
            <div class="inline-flex items-center gap-2 px-3 py-1 border border-neon/50 bg-neon/5 rounded-full">
                <span class="w-2 h-2 bg-neon rounded-full animate-pulse"></span>
                <span class="text-[10px] text-neon font-bold tracking-widest">PRESALE LIVE</span>
            </div>
            
            <h1 class="text-4xl md:text-6xl font-pixel leading-tight glitch-text" data-text="PEPE BLACKJACK">PEPE BLACKJACK</h1>
            <p class="text-gray-400 font-tech text-lg border-l-4 border-neon pl-4">
                The ultimate GambleFi ecosystem on Base. <br>
                <span class="text-white font-bold">Play Games. Stake NFTs. Earn Yield.</span>
            </p>

            <!-- Presale Box -->
            <div class="glass-panel p-1 mt-8 max-w-md">
                <div class="bg-black/90 p-6 space-y-4">
                    <div class="flex justify-between items-center text-xs text-gray-400 font-mono">
                        <span>EXCHANGE RATE</span>
                        <span class="text-neon font-bold">1 ETH = 1.5M PBJ</span>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="relative">
                            <input type="number" id="buyInput" class="cyber-input p-3 pr-12 text-lg" placeholder="0.1">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-500">ETH</span>
                        </div>
                        <div class="flex justify-center text-gray-600 text-xs">‚¨á</div>
                        <div class="relative">
                            <input type="number" id="receiveInput" class="cyber-input p-3 pr-12 text-lg text-neon" readonly placeholder="0">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-bold text-neon">PBJ</span>
                        </div>
                    </div>

                    <button id="buyBtn" class="w-full action-btn font-bold text-xs py-3">BUY TOKENS</button>
                    <p id="presaleStatus" class="text-center text-[10px] text-gray-500 min-h-[15px]"></p>
                </div>
            </div>
        </div>
        
        <!-- Hero Image -->
        <div class="hidden md:flex justify-center relative">
            <div class="absolute inset-0 bg-neon blur-[150px] opacity-20"></div>
            <img src="/prevent.png" alt="Pepe Dealer" class="relative z-10 rounded-xl border border-gray-800 shadow-[0_0_50px_rgba(0,0,0,0.5)] grayscale hover:grayscale-0 transition duration-700" onerror="this.style.display='none'">
        </div>
      </div>
    </section>

    <!-- GAMES LOBBY -->
    <section id="games">
      <h2 class="text-2xl text-white font-pixel mb-6 flex items-center gap-3">
          <span class="text-neon">‚ñ∫</span> GAMES LOBBY
      </h2>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-5">
        <!-- Blackjack -->
        <div onclick="openGame('blackjack')" class="game-card group cursor-pointer">
            <div class="absolute top-2 right-2 bg-red-600 text-white text-[8px] font-bold px-2 py-1 rounded z-20">LIVE</div>
            <img src="games/media/blackjack.jpg" alt="Blackjack" onerror="this.src='https://placehold.co/400x300/111/333?text=BLACKJACK'">
            <div class="p-3 bg-gray-900 border-t border-gray-800">
                <h3 class="text-sm text-white font-bold font-pixel group-hover:text-neon transition">BLACKJACK</h3>
                <p class="text-[10px] text-gray-500 font-mono">Payout 1:1</p>
            </div>
        </div>

        <!-- Mines -->
        <div onclick="openGame('mines')" class="game-card group cursor-pointer">
             <img src="games/media/minas.jpg" alt="Mines" onerror="this.src='https://placehold.co/400x300/111/333?text=MINES'">
            <div class="p-3 bg-gray-900 border-t border-gray-800">
                <h3 class="text-sm text-white font-bold font-pixel group-hover:text-neon transition">MINES</h3>
                <p class="text-[10px] text-gray-500 font-mono">Strategy</p>
            </div>
        </div>

        <!-- Slots -->
        <div onclick="openGame('slots')" class="game-card group cursor-pointer">
             <img src="games/media/slots.jpg" alt="Slots" onerror="this.src='https://placehold.co/400x300/111/333?text=SLOTS'">
            <div class="p-3 bg-gray-900 border-t border-gray-800">
                <h3 class="text-sm text-white font-bold font-pixel group-hover:text-neon transition">SLOTS</h3>
                <p class="text-[10px] text-gray-500 font-mono">Jackpot 500x</p>
            </div>
        </div>

        <!-- Crash -->
        <div onclick="openGame('crash')" class="game-card group cursor-pointer">
             <img src="games/media/crash.jpg" alt="Crash" onerror="this.src='https://placehold.co/400x300/111/333?text=CRASH'">
            <div class="p-3 bg-gray-900 border-t border-gray-800">
                <h3 class="text-sm text-white font-bold font-pixel group-hover:text-neon transition">CRASH</h3>
                <p class="text-[10px] text-gray-500 font-mono">High Risk</p>
            </div>
        </div>
      </div>
    </section>

    <!-- NFT STAKING -->
    <section id="staking" class="grid md:grid-cols-2 gap-8 pt-8 border-t border-gray-800">
        <div class="glass-panel p-6">
            <h2 class="text-xl font-pixel text-white mb-4">YOUR VAULT</h2>
            <div class="bg-black/50 p-4 rounded border border-gray-800 mb-4 flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase">Staked</p>
                    <p id="total-staked" class="text-2xl font-mono text-white">0</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase">Rewards</p>
                    <p id="pending-rewards" class="text-2xl font-mono text-neon">0.00</p>
                </div>
            </div>
            <button onclick="claimRewards()" class="action-btn w-full">CLAIM REWARDS</button>
        </div>
        <div class="glass-panel p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-pixel text-white">INVENTORY</h2>
                <button onclick="loadUserData()" class="text-[10px] text-neon hover:text-white">[ REFRESH ]</button>
            </div>
            <div id="inventory-list" class="space-y-2 text-xs text-gray-500 font-mono text-center py-8">
                Connect Wallet to view NFTs
            </div>
        </div>
    </section>

  </main>

  <footer class="border-t border-gray-900 bg-black py-6 mt-12">
      <div class="text-center text-[10px] text-gray-600 font-mono">
          &copy; 2025 PBJ CASINO. ALL RIGHTS RESERVED.
      </div>
  </footer>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    // --- CONFIGURACI√ìN ---
    const ADDR = {
        TOKEN: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5",
        PRESALE: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", // Asumiendo que es el mismo o cambiar
        BLACKJACK: "0xbe0b8099B707e3c0bA278583C6b5561D82E77f3E", // Contrato de juego (usado para todos los juegos en demo)
        INSTANT: "0xbcF9DFfcDaDeC818F7B653aF1a7Ff287F3e7011f", 
        NFT: "0xDE05dAf2cbF59ce9094979d639393ADED494e920"
    };

    const ABIS = {
        TOKEN: [ "function approve(address spender, uint256 amount) external returns (bool)", "function allowance(address owner, address spender) external view returns (uint256)", "function balanceOf(address account) external view returns (uint256)" ],
        PRESALE: [ "function buyTokens() payable" ],
        GAME: [ 
            "function blackjackDeal(uint256 bet) external", 
            "function playMines(uint256 bet, uint256 mask) external",
            "function playSlots(uint256 bet) external",
            "function playCrash(uint256 bet, uint256 cashout) external"
        ], 
        NFT: [ "function balanceOf(address, uint256) view returns (uint256)", "function mint(uint256, uint256) external", "function stake(uint256, uint256) external", "function claim() external", "function getPendingRewards(address) view returns (uint256)", "function getStakedBalance(address, uint256) view returns (uint256)" ]
    };

    let provider, signer, address;
    let contracts = {};
    let gameState = { active: false, game: null, mines: [], bjPlayer: 0, bjDealer: 0 };

    // --- UTILS ---
    const toast = (msg, type='success') => {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast-enter p-3 border-l-4 ${type==='error'?'border-red-500 bg-red-900/80':'border-neon bg-gray-900/90'} text-white text-[10px] font-mono shadow-lg backdrop-blur`;
        t.innerText = `>> ${msg}`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    };

    function updateStatus(msg, color='text-gray-500') {
        document.getElementById('gameStatus').innerText = msg;
        document.getElementById('gameStatus').className = `text-center mt-4 text-xs font-mono uppercase tracking-widest ${color}`;
    }

    // --- WALLET ---
    document.getElementById('connectBtn').addEventListener('click', async () => {
        if(!window.ethereum) return alert("Install Metamask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            address = await signer.getAddress();
            
            contracts.token = new ethers.Contract(ADDR.TOKEN, ABIS.TOKEN, signer);
            contracts.presale = new ethers.Contract(ADDR.PRESALE, ABIS.PRESALE, signer);
            // Nota: Usamos contracts.game apuntando a INSTANT para Mines/Slots y BLACKJACK para BJ
            contracts.instant = new ethers.Contract(ADDR.INSTANT, ABIS.GAME, signer);
            contracts.blackjack = new ethers.Contract(ADDR.BLACKJACK, ABIS.GAME, signer);
            contracts.nft = new ethers.Contract(ADDR.NFT, ABIS.NFT, signer);

            updateUI();
            toast("SYSTEM ONLINE");
        } catch(e) { toast("Connection Error", "error"); }
    });

    async function updateUI() {
        document.getElementById('connectBtn').innerText = address.substring(0,6) + "...";
        try {
            const bal = await contracts.token.balanceOf(address);
            const fmt = Math.floor(parseFloat(ethers.utils.formatUnits(bal, 18)));
            document.getElementById('headerBalance').innerText = fmt.toLocaleString();
            document.getElementById('modalBalance').innerText = fmt.toLocaleString();
            document.getElementById('walletDisplay').style.display = 'flex';
            loadUserData();
        } catch(e) { console.log("Token load error (ignore if dev)"); }
    }

    // --- PRESALE LOGIC (FIXED) ---
    document.getElementById('buyInput').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('receiveInput').value = val ? (val * 1500000).toFixed(0) : 0;
    });

    document.getElementById('buyBtn').addEventListener('click', async () => {
        if(!signer) return toast("Connect Wallet", "error");
        const ethVal = document.getElementById('buyInput').value;
        if(!ethVal || ethVal <= 0) return toast("Invalid Amount", "error");
        
        const btn = document.getElementById('buyBtn');
        const status = document.getElementById('presaleStatus');
        
        try {
            btn.disabled = true; btn.innerText = "PROCESSING...";
            status.innerText = "Confirming Transaction...";
            
            // SOLUCI√ìN GAS LIMIT EN PREVENTA
            const tx = await contracts.presale.buyTokens({
                value: ethers.utils.parseEther(ethVal),
                gasLimit: 500000 // Seguridad
            });
            
            status.innerText = "Waiting for block...";
            await tx.wait();
            
            toast("PURCHASE SUCCESSFUL!");
            confetti();
            updateUI();
        } catch(e) {
            console.error(e);
            toast("Transaction Failed", "error");
        } finally {
            btn.disabled = false; btn.innerText = "BUY TOKENS";
            status.innerText = "";
        }
    });

    // --- GAME ENGINE ---
    window.openGame = (gameName) => {
        gameState.game = gameName;
        gameState.active = false;
        gameState.mines = [];
        
        const m = document.getElementById('gameModal');
        const content = document.getElementById('innerGameContent');
        const extra = document.getElementById('gameExtraControls');
        const btn = document.getElementById('gameActionBtn');

        m.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        document.getElementById('modalTitle').innerText = gameName.toUpperCase();
        extra.innerHTML = ''; extra.classList.add('hidden');
        btn.style.display = 'block'; btn.innerText = 'PLAY'; btn.disabled = false;
        updateStatus("READY");

        // Config UI Inicial
        if(gameName === 'blackjack') {
            content.innerHTML = `
                <div class="flex flex-col gap-4 w-full p-2">
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 mb-1">DEALER</p>
                        <div id="bjDealer" class="h-[80px] flex justify-center gap-2"><div class="card-visual card-black bg-gray-800 border border-gray-600">?</div></div>
                    </div>
                    <div class="text-center">
                        <div id="bjPlayer" class="h-[80px] flex justify-center gap-2"><div class="text-xs text-gray-600 flex items-center">Waiting Deal...</div></div>
                        <p class="text-[10px] text-gray-500 mt-1">YOU</p>
                    </div>
                </div>`;
        } else if (gameName === 'mines') {
            btn.innerText = "BET & REVEAL";
            updateStatus("SELECT 1-5 TILES", "text-neon");
            let grid = '<div class="mines-grid">';
            for(let i=0; i<25; i++) grid += `<div class="mine-tile" id="tile-${i}" onclick="toggleMine(${i})"></div>`;
            grid += '</div>';
            content.innerHTML = grid;
        } else {
            content.innerHTML = `<div class="text-4xl text-gray-600 font-pixel">READY</div>`;
        }
        
        btn.onclick = startGameTransaction;
    };

    window.closeGame = () => {
        document.getElementById('gameModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    };

    // --- GAME LOGIC & GAS FIX ---
    window.toggleMine = (idx) => {
        if(gameState.active) return;
        const tile = document.getElementById(`tile-${idx}`);
        if(gameState.mines.includes(idx)) {
            gameState.mines = gameState.mines.filter(i => i !== idx);
            tile.classList.remove('selected'); tile.innerText = '';
        } else {
            if(gameState.mines.length >= 5) return toast("Max 5 Tiles", "error");
            gameState.mines.push(idx);
            tile.classList.add('selected'); tile.innerText = 'üéØ';
        }
    };

    async function startGameTransaction() {
        if(!signer) return toast("Connect Wallet", "error");
        const betVal = document.getElementById('gameBetInput').value;
        const bet = ethers.utils.parseUnits(betVal, 18);
        const btn = document.getElementById('gameActionBtn');

        // Validaciones
        if(gameState.game === 'mines' && gameState.mines.length === 0) return toast("Select tiles first", "error");

        try {
            btn.disabled = true; btn.innerText = "APPROVING...";
            updateStatus("CHECKING ALLOWANCE...");

            // 1. APROBACI√ìN
            const spender = gameState.game === 'blackjack' ? ADDR.BLACKJACK : ADDR.INSTANT;
            const allow = await contracts.token.allowance(address, spender);
            if(allow.lt(bet)) {
                const txApp = await contracts.token.approve(spender, ethers.constants.MaxUint256, { gasLimit: 100000 });
                await txApp.wait();
            }

            btn.innerText = "SENDING...";
            updateStatus("CONFIRM IN WALLET...");
            let tx;

            // 2. LLAMADA AL CONTRATO CON GAS LIMIT MANUAL (SOLUCI√ìN AL ERROR)
            if(gameState.game === 'blackjack') {
                tx = await contracts.blackjack.blackjackDeal(bet, { gasLimit: 500000 });
                // Simular UI localmente para la demo mientras se mina la TX real
                startBjRoundVisual(); 
            } 
            else if (gameState.game === 'mines') {
                // Crear m√°scara simple para demo
                tx = await contracts.instant.playMines(bet, 123, { gasLimit: 500000 });
                await tx.wait();
                revealMinesVisual();
            }
            else if (gameState.game === 'slots') {
                tx = await contracts.instant.playSlots(bet, { gasLimit: 500000 });
                await tx.wait();
                playSlotsAnim();
            }
            else if (gameState.game === 'crash') {
                tx = await contracts.instant.playCrash(bet, 200, { gasLimit: 500000 }); // 2.00x hardcoded demo
                await tx.wait();
                toast("Crash Logic executed");
                endGame(true, "CASHED OUT @ 2.00x");
            }

            if(gameState.game !== 'blackjack') updateUI();

        } catch(e) {
            console.error(e);
            const err = e.message || JSON.stringify(e);
            if(err.includes("user rejected")) toast("User Rejected", "error");
            else toast("Transaction Failed", "error");
            
            btn.disabled = false; btn.innerText = "PLAY";
            updateStatus("ERROR", "text-red-500");
        }
    }

    // --- VISUAL SIMULATIONS (INTERACTIVIDAD) ---
    
    // Blackjack Interactivo
    function startBjRoundVisual() {
        const btn = document.getElementById('gameActionBtn');
        btn.style.display = 'none'; 
        
        const extra = document.getElementById('gameExtraControls');
        extra.classList.remove('hidden');
        extra.innerHTML = `
            <button onclick="bjHit()" class="action-btn flex-1 bg-blue-900 border-blue-500 text-white">HIT</button>
            <button onclick="bjStand()" class="action-btn flex-1 bg-red-900 border-red-500 text-white">STAND</button>
        `;

        document.getElementById('bjPlayer').innerHTML = '';
        document.getElementById('bjDealer').innerHTML = '';
        
        gameState.bjPlayer = 0;
        gameState.bjDealer = 0;

        // Cartas Iniciales
        addCard('bjDealer', getRandomCard());
        addCard('bjPlayer', getRandomCard());
        addCard('bjPlayer', getRandomCard());
        
        updateStatus("YOUR TURN: HIT OR STAND?", "text-white");
    }

    window.bjHit = () => {
        addCard('bjPlayer', getRandomCard());
        if(gameState.bjPlayer > 21) endGame(false, "BUSTED! > 21");
    };

    window.bjStand = () => {
        document.getElementById('gameExtraControls').innerHTML = ''; // Disable buttons
        updateStatus("DEALER TURN...", "text-yellow-500");
        
        const interval = setInterval(() => {
            if(gameState.bjDealer < 17) {
                addCard('bjDealer', getRandomCard());
            } else {
                clearInterval(interval);
                if(gameState.bjDealer > 21) endGame(true, "DEALER BUST! YOU WIN");
                else if (gameState.bjDealer >= gameState.bjPlayer) endGame(false, "DEALER WINS");
                else endGame(true, "YOU WIN!");
            }
        }, 800);
    };

    function addCard(id, card) {
        const div = document.getElementById(id);
        const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
        div.innerHTML += `<div class="card-visual ${isRed?'card-red':'card-black'}"><span>${card.val}</span><span class="text-xs">${card.suit}</span></div>`;
        
        let num = parseInt(card.val);
        if(isNaN(num)) num = card.val === 'A' ? 11 : 10;
        
        if(id === 'bjPlayer') gameState.bjPlayer += num;
        else gameState.bjDealer += num;
    }

    // Mines Visual
    function revealMinesVisual() {
        const bombs = [Math.floor(Math.random()*25), Math.floor(Math.random()*25)]; // Simulado
        let hit = false;
        gameState.mines.forEach(idx => {
            const tile = document.getElementById(`tile-${idx}`);
            tile.classList.remove('selected');
            if(bombs.includes(idx)) {
                tile.classList.add('revealed-bomb'); tile.innerText = 'üí£'; hit = true;
            } else {
                tile.classList.add('revealed-safe'); tile.innerText = 'üíé';
            }
        });
        endGame(!hit, hit ? "BOOM! GAME OVER" : "NICE! GEMS FOUND");
    }

    // Slots Visual
    function playSlotsAnim() {
        const content = document.getElementById('innerGameContent');
        const emojis = ['üçí','7Ô∏è‚É£','üíé','üçã'];
        let interval = setInterval(() => {
            content.innerHTML = `<div class="text-5xl text-white font-mono">${emojis[Math.floor(Math.random()*4)]} ${emojis[Math.floor(Math.random()*4)]} ${emojis[Math.floor(Math.random()*4)]}</div>`;
        }, 100);
        
        setTimeout(() => {
            clearInterval(interval);
            const win = Math.random() > 0.5;
            const res = win ? ['7Ô∏è‚É£','7Ô∏è‚É£','7Ô∏è‚É£'] : ['üçí','üçã','üíé'];
            content.innerHTML = `<div class="text-5xl text-white font-mono ${win?'animate-bounce':''}">${res.join(' ')}</div>`;
            endGame(win, win ? "JACKPOT!" : "NO LUCK");
        }, 2000);
    }

    // Common End Game
    function endGame(won, msg) {
        updateStatus(msg, won ? 'text-neon' : 'text-red-500');
        const btn = document.getElementById('gameActionBtn');
        btn.style.display = 'block';
        btn.disabled = false;
        btn.innerText = "PLAY AGAIN";
        document.getElementById('gameExtraControls').classList.add('hidden');
        if(won) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }

    // --- HELPERS ---
    function getRandomCard() {
        const s = ['‚ô†','‚ô•','‚ô¶','‚ô£']; const v = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        return { val: v[Math.floor(Math.random()*v.length)], suit: s[Math.floor(Math.random()*s.length)] };
    }
    
    // NFT Loader (Dummy for now)
    window.loadUserData = async () => {
        if(!signer) return;
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        // Simulaci√≥n visual para la UI
        list.innerHTML = `
            <div class="flex justify-between bg-gray-900 p-2 rounded mb-1 border border-gray-700"><span class="text-white">Common Card</span><button class="text-[10px] text-neon">STAKE</button></div>
            <div class="flex justify-between bg-gray-900 p-2 rounded mb-1 border border-gray-700"><span class="text-white">Rare Card</span><button class="text-[10px] text-neon">STAKE</button></div>
        `;
    };
    window.claimRewards = async () => { toast("Claiming..."); setTimeout(()=>toast("Rewards Claimed!"), 1000); };
  </script>
</body>
</html>
