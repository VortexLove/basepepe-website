<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>PBJ - Premium Crypto Casino</title>
  <meta name="description" content="The #1 DeFi Casino on Base." />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- External Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Inter"', 'sans-serif'],
            mono: ['"Rajdhani"', 'monospace'],
          },
          colors: {
            bg: '#0F212E',       
            sidebar: '#1A2C38',  
            surface: '#213743',  
            surfaceHover: '#2C4454',    
            primary: '#00E701', 
            accent: '#1475E1',   
            danger: '#FF4949',
          },
          animation: {
            'marquee': 'marquee 30s linear infinite',
            'bounce-short': 'bounce-short 0.5s infinite',
          },
          keyframes: {
            marquee: { '0%': { transform: 'translateX(0%)' }, '100%': { transform: 'translateX(-100%)' } },
            'bounce-short': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #0F212E; color: #b1bad3; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0F212E; }
    ::-webkit-scrollbar-thumb { background: #2C4454; border-radius: 10px; }

    /* UI Components */
    .casino-input { background: #0F212E; border: 2px solid #2C4454; color: white; font-family: 'Rajdhani'; font-weight: 700; transition: all 0.2s; }
    .casino-input:focus { border-color: #00E701; outline: none; }
    .btn-primary { background: #00E701; color: #0b1820; font-weight: 800; transition: all 0.2s; border-radius: 0.25rem; }
    .btn-primary:hover:not(:disabled) { background: #1aff1b; transform: translateY(-1px); box-shadow: 0 0 15px rgba(0,231,1,0.4); }
    .btn-primary:disabled { background: #2C4454; color: #55657e; cursor: not-allowed; }

    /* Animations */
    .blur-anim { filter: blur(3px); transform: translateY(-2px); transition: filter 0.1s; }
    .shaking { animation: shake 0.1s infinite; }
    @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
    
    .card-visual {
        width: 60px; height: 90px; background: white; border-radius: 8px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-weight: 800; font-family: 'Inter', sans-serif; font-size: 20px; line-height: 1;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.5); margin: 0 4px; border: 2px solid #ddd;
    }
    .card-red { color: #e53e3e; } .card-black { color: #1a202c; }

    /* NFT Cards */
    .nft-card { transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1); }
    .nft-card:hover { transform: translateY(-5px); border-color: var(--border-color); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    
    /* Ticker & Flying Money */
    .ticker-wrap { width: 100%; overflow: hidden; background: #1A2C38; border-bottom: 1px solid #2C4454; height: 40px; }
    .ticker { display: flex; height: 100%; align-items: center; white-space: nowrap; animation: marquee 30s linear infinite; }
    .ticker-item { display: inline-flex; align-items: center; padding: 0 2rem; color: #b1bad3; font-size: 0.75rem; font-family: 'Rajdhani'; font-weight: 600; }

    .fly-money {
        position: fixed; pointer-events: none; z-index: 10000;
        color: #00E701; font-family: 'Rajdhani', monospace; font-weight: 800; font-size: 1.5rem;
        text-shadow: 0 0 10px rgba(0, 231, 1, 0.8);
        transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
    }
    
    /* Game Grids */
    .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; max-width: 280px; }
    .mine-cell { aspect-ratio: 1; background: #2C4454; border-radius: 4px; cursor: default; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: 0.3s; box-shadow: inset 0 -3px 0 rgba(0,0,0,0.3); }
    .mine-cell.safe { background: #00E701; color: black; box-shadow: 0 0 10px #00E701; }
    .mine-cell.boom { background: #FF4949; color: white; box-shadow: 0 0 10px #FF4949; }
    
    .slot-reel { background: #1A2C38; border: 2px solid #2C4454; border-radius: 8px; width: 80px; height: 100px; display: flex; align-items: center; justify-content: center; font-size: 3rem; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
  </style>
</head>
<body class="flex h-screen text-sm antialiased font-sans selection:bg-primary selection:text-black">

  <!-- ASSETS: AUDIO -->
  <div id="audio-container" class="hidden">
      <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
      <audio id="sfx-spin" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" preload="auto"></audio>
      <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
      <audio id="sfx-lose" src="https://assets.mixkit.co/active_storage/sfx/203/203-preview.mp3" preload="auto"></audio>
  </div>

  <div id="toast-container" class="fixed bottom-5 right-5 z-[10000] flex flex-col gap-2"></div>

  <!-- GAME MODAL -->
  <div id="gameModal" class="fixed inset-0 bg-black/85 backdrop-blur-sm z-[9990] hidden items-center justify-center p-4">
    <div class="bg-sidebar w-full max-w-xl rounded-2xl shadow-2xl border border-gray-700 overflow-hidden flex flex-col max-h-[90vh] relative">
        
        <!-- Tutorial Overlay -->
        <div id="tutorialOverlay" class="absolute inset-0 bg-black/95 z-50 hidden flex-col p-8 items-center justify-center text-center">
            <i class="fas fa-book-open text-4xl text-primary mb-4"></i>
            <h3 class="text-2xl font-bold text-white mb-2" id="tutTitle">GAME RULES</h3>
            <p class="text-gray-300 mb-6 max-w-md leading-relaxed" id="tutText">...</p>
            <button onclick="toggleTutorial()" class="btn-primary px-6 py-2">GOT IT</button>
        </div>

        <!-- Header -->
        <div class="bg-[#15222b] p-4 flex justify-between items-center border-b border-gray-800">
            <div class="flex items-center gap-3">
                <span id="modalIcon" class="text-2xl drop-shadow-[0_0_5px_rgba(255,255,255,0.3)]">üé∞</span>
                <div>
                    <h2 id="modalTitle" class="text-white font-bold text-lg uppercase tracking-wide font-mono">GAME</h2>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTutorial()" class="text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded transition border border-gray-700"><i class="fas fa-question-circle mr-1"></i> RULES</button>
                <button onclick="closeGame()" class="text-gray-500 hover:text-white transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-800"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <!-- Visual Stage -->
        <div class="flex-1 bg-[#0b1820] relative p-8 flex flex-col items-center justify-center overflow-y-auto min-h-[320px] shadow-inner">
             <!-- Background Grid Effect -->
            <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#2C4454 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div id="innerGameContent" class="w-full flex flex-col items-center justify-center transition-all duration-300 relative z-10">
                <!-- Content Injected Here -->
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="bg-[#0b1820] py-2 border-t border-gray-800">
             <div id="gameStatus" class="text-center text-xs font-mono font-bold uppercase tracking-[0.2em] text-gray-500">READY TO PLAY</div>
        </div>

        <!-- Controls -->
        <div class="bg-sidebar p-5 border-t border-gray-700 shadow-[0_-5px_20px_rgba(0,0,0,0.3)]">
            <div class="flex flex-col gap-4">
                <!-- Extra Controls (Difficulty, etc) -->
                <div id="gameExtraControls" class="hidden flex gap-2 w-full justify-center"></div>

                <div class="grid grid-cols-[1.5fr_1fr] gap-4">
                    <div class="bg-[#0F212E] p-2 rounded-lg border border-gray-600 focus-within:border-primary transition flex flex-col justify-center">
                        <div class="flex justify-between px-2 text-[10px] text-gray-400 uppercase font-bold">
                            <span>Bet Amount</span>
                            <span class="text-primary font-mono cursor-pointer" onclick="setMaxBet()">MAX</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-coins text-primary ml-2"></i>
                            <input type="number" id="gameBetInput" value="100" class="bg-transparent w-full text-white font-mono font-bold text-lg focus:outline-none" placeholder="0.00">
                        </div>
                    </div>
                    <button id="gameActionBtn" class="btn-primary w-full h-full text-lg shadow-[0_0_15px_rgba(0,231,1,0.2)]">PLAY</button>
                </div>
                
                <div class="flex justify-between text-[10px] text-gray-500 uppercase font-bold px-1">
                    <span>Wallet Balance:</span>
                    <span><span id="modalBalance" class="text-white font-mono text-sm">0</span> PBJ</span>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- SIDEBAR (Desktop) -->
  <aside class="hidden md:flex w-64 flex-col bg-sidebar border-r border-gray-800 flex-shrink-0 z-20">
    <div class="h-16 flex items-center px-6 border-b border-gray-800">
      <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center mr-3 text-black font-bold text-lg transform rotate-3">P</div>
      <span class="text-white font-bold text-xl tracking-tight">PBJ<span class="text-primary">.BET</span></span>
    </div>

    <div class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
      <div class="px-3 mb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Casino</div>
      <a href="#games" class="flex items-center px-3 py-2.5 bg-surface text-white rounded-lg transition border-l-2 border-primary"><i class="fas fa-dice w-6 text-primary"></i> <span class="font-medium">Lobby</span></a>
      <a href="#presale" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-surfaceHover rounded-lg transition"><i class="fas fa-rocket w-6"></i> <span class="font-medium">Presale</span> <span class="ml-auto bg-primary text-black text-[9px] font-bold px-1.5 py-0.5 rounded">HOT</span></a>
      <a href="#minting" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-surfaceHover rounded-lg transition"><i class="fas fa-images w-6"></i> <span class="font-medium">NFT Collection</span></a>
      <a href="#staking" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-surfaceHover rounded-lg transition"><i class="fas fa-vault w-6"></i> <span class="font-medium">Staking</span></a>
      <a href="#partners" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-surfaceHover rounded-lg transition"><i class="fas fa-handshake w-6"></i> <span class="font-medium">Affiliates</span></a>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
    
    <!-- NAVBAR -->
    <header class="h-16 bg-sidebar/90 backdrop-blur border-b border-gray-800 flex items-center justify-between px-4 sticky top-0 z-30">
      <div class="md:hidden flex items-center gap-3"><div class="w-8 h-8 bg-primary rounded flex items-center justify-center font-bold text-black">P</div></div>
      <div class="flex items-center gap-6">
          <div class="hidden md:flex items-center gap-2 bg-[#0F212E] border border-gray-700 px-3 py-1.5 rounded-full">
              <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
              <span class="text-xs font-mono font-bold text-gray-300">1,420 Online</span>
          </div>
      </div>
      <div class="flex items-center gap-3">
         <div id="walletDisplay" class="hidden flex-col items-end mr-1">
            <div class="bg-[#0F212E] px-3 py-1 rounded border border-gray-700 flex items-center gap-2">
                <span id="headerBalance" class="text-white font-mono font-bold text-sm">0</span>
                <span class="text-primary text-xs font-bold">PBJ</span>
            </div>
        </div>
        <button id="connectBtn" class="btn-primary px-4 py-2 text-xs md:text-sm shadow-[0_0_10px_rgba(0,231,1,0.2)]"><i class="fas fa-wallet mr-1"></i> CONNECT</button>
      </div>
    </header>

    <!-- MAIN SCROLL -->
    <main class="flex-1 overflow-y-auto bg-bg relative">
      
      <!-- PRESALE HERO -->
      <div id="presale" class="p-4 md:p-8 pb-0">
          <section class="relative rounded-2xl overflow-hidden bg-gradient-to-r from-[#0b1d2e] to-[#162b3b] shadow-2xl border border-white/5">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div class="absolute top-0 left-0 w-full bg-primary/20 border-b border-primary/50 text-center py-1 z-20">
                <p class="text-[10px] md:text-xs font-bold text-primary animate-pulse">‚ö° SPECIAL OFFER: +25% BONUS TOKENS ENDS IN <span id="bonusTimer" class="font-mono text-white">01:59:59</span> ‚ö°</p>
            </div>
            <div class="relative z-10 grid md:grid-cols-2 gap-8 p-6 md:p-10 pt-12 items-center">
                <div class="space-y-5">
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight">Presale Ends In:</h1>
                    <div class="flex gap-4 font-mono text-center">
                        <div class="bg-black/40 p-3 rounded-lg border border-primary/30 min-w-[70px]"><span id="d" class="text-2xl md:text-3xl font-bold text-primary">5</span><div class="text-[10px] text-gray-500">DAYS</div></div>
                        <div class="bg-black/40 p-3 rounded-lg border border-primary/30 min-w-[70px]"><span id="h" class="text-2xl md:text-3xl font-bold text-white">00</span><div class="text-[10px] text-gray-500">HRS</div></div>
                        <div class="bg-black/40 p-3 rounded-lg border border-primary/30 min-w-[70px]"><span id="m" class="text-2xl md:text-3xl font-bold text-white">00</span><div class="text-[10px] text-gray-500">MINS</div></div>
                        <div class="bg-black/40 p-3 rounded-lg border border-primary/30 min-w-[70px]"><span id="s" class="text-2xl md:text-3xl font-bold text-white">00</span><div class="text-[10px] text-gray-500">SECS</div></div>
                    </div>
                </div>
                <div class="bg-sidebar p-1 rounded-xl shadow-2xl max-w-sm mx-auto w-full border border-gray-700 mt-6 md:mt-0">
                    <div class="bg-[#0F212E] p-5 rounded-lg space-y-4">
                        <div class="flex justify-between text-xs text-gray-400 font-bold mb-1"><span>YOU PAY</span></div>
                        <div class="relative"><input type="number" id="buyInput" class="casino-input w-full p-3 pr-16 rounded-lg text-lg" placeholder="0.1"><div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2"><i class="fab fa-ethereum text-gray-300"></i> <span class="font-bold text-white text-sm">ETH</span></div></div>
                        <div class="relative pt-1"><input type="number" id="receiveInput" readonly class="bg-sidebar border border-transparent w-full p-3 pr-16 rounded-lg text-lg text-primary font-mono font-bold" placeholder="0"><div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2"><span class="font-bold text-white text-sm">PBJ</span></div></div>
                        <button id="buyBtn" class="w-full btn-primary py-3.5 mt-2 uppercase tracking-wider text-xs font-bold">Buy Tokens</button>
                    </div>
                </div>
            </div>
          </section>
      </div>

      <!-- TICKER -->
      <div class="mt-8 border-y border-gray-800 bg-sidebar/50 backdrop-blur-sm">
          <div class="ticker-wrap">
              <div class="ticker">
                  <div class="ticker-item"><span class="text-primary mr-2">WIN</span> User 0x...4a won 500 PBJ on Slots</div>
                  <div class="ticker-item"><span class="text-primary mr-2">WIN</span> User 0x...b2 won 2000 PBJ on Blackjack</div>
                  <div class="ticker-item"><span class="text-primary mr-2">WIN</span> PepeKing just minted a Legendary NFT</div>
                  <div class="ticker-item"><span class="text-primary mr-2">WIN</span> User 0x...ff won 150 PBJ on Mines</div>
              </div>
          </div>
      </div>

      <!-- GAMES -->
      <section id="games" class="p-4 md:p-8">
        <h2 class="text-xl font-bold text-white flex items-center gap-2 mb-6"><i class="fas fa-gamepad text-primary"></i> Casino Lobby</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <div onclick="openGame('blackjack')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1605870445919-838d190e8e1b?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Blackjack</h3></div></div>
            <div onclick="openGame('slots')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1596838132731-3301c3fd4317?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Slots</h3></div></div>
            <div onclick="openGame('dice')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1563941402622-4e7a488bc294?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Dice</h3></div></div>
            <div onclick="openGame('roulette')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1606167668584-78701c57f13d?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Roulette</h3></div></div>
            <div onclick="openGame('plinko')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1622312685799-a3597379d39c?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Plinko</h3></div></div>
            <div onclick="openGame('crash')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Crash</h3></div></div>
            <div onclick="openGame('keno')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1518623489648-a173ef7824f3?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Keno</h3></div></div>
            <div onclick="openGame('tower')" class="group cursor-pointer bg-surface rounded-xl overflow-hidden aspect-[3/4] hover:-translate-y-1 transition shadow-lg relative"><img src="https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=400" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"><div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4"><h3 class="text-white font-bold">Tower</h3></div></div>
        </div>
      </section>

      <!-- NFT COLLECTION -->
      <section id="minting" class="p-4 md:p-8 bg-[#0b1820] border-y border-gray-800">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i class="fas fa-images text-primary"></i> Dealer NFT Collection</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 mb-10">
              <div class="nft-card bg-surface rounded-xl p-3 flex flex-col items-center text-center" style="--border-color: #A0AEC0;">
                  <div class="w-full aspect-square bg-gray-700 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden group"><div class="absolute inset-0 bg-gray-500 opacity-20"></div><i class="fas fa-user text-5xl text-gray-400 group-hover:scale-110 transition"></i></div>
                  <h3 class="text-white font-bold uppercase text-sm">Common</h3><div class="text-[10px] text-gray-400 mb-2">APY: 50%</div><div class="mt-auto w-full"><div class="text-white font-mono font-bold text-sm mb-2">5,000 PBJ</div><button onclick="mintNFT(0)" class="w-full bg-gray-600 hover:bg-gray-500 text-white py-2 rounded text-xs font-bold transition">MINT</button></div>
              </div>
              <div class="nft-card bg-surface rounded-xl p-3 flex flex-col items-center text-center" style="--border-color: #48BB78;">
                  <div class="w-full aspect-square bg-green-900/30 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden group"><div class="absolute inset-0 bg-green-500 opacity-10"></div><i class="fas fa-user-ninja text-5xl text-green-400 group-hover:scale-110 transition"></i></div>
                  <h3 class="text-green-400 font-bold uppercase text-sm">Uncommon</h3><div class="text-[10px] text-gray-400 mb-2">APY: 120%</div><div class="mt-auto w-full"><div class="text-white font-mono font-bold text-sm mb-2">15,000 PBJ</div><button onclick="mintNFT(1)" class="w-full bg-green-700 hover:bg-green-600 text-white py-2 rounded text-xs font-bold transition">MINT</button></div>
              </div>
              <div class="nft-card bg-surface rounded-xl p-3 flex flex-col items-center text-center" style="--border-color: #4299E1;">
                  <div class="w-full aspect-square bg-blue-900/30 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden group"><div class="absolute inset-0 bg-blue-500 opacity-10"></div><i class="fas fa-user-astronaut text-5xl text-blue-400 group-hover:scale-110 transition"></i></div>
                  <h3 class="text-blue-400 font-bold uppercase text-sm">Rare</h3><div class="text-[10px] text-gray-400 mb-2">APY: 350%</div><div class="mt-auto w-full"><div class="text-white font-mono font-bold text-sm mb-2">40,000 PBJ</div><button onclick="mintNFT(2)" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-2 rounded text-xs font-bold transition">MINT</button></div>
              </div>
              <div class="nft-card bg-surface rounded-xl p-3 flex flex-col items-center text-center" style="--border-color: #9F7AEA;">
                  <div class="w-full aspect-square bg-purple-900/30 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden group"><div class="absolute inset-0 bg-purple-500 opacity-10"></div><i class="fas fa-user-secret text-5xl text-purple-400 group-hover:scale-110 transition"></i></div>
                  <h3 class="text-purple-400 font-bold uppercase text-sm">Epic</h3><div class="text-[10px] text-gray-400 mb-2">APY: 800%</div><div class="mt-auto w-full"><div class="text-white font-mono font-bold text-sm mb-2">100,000 PBJ</div><button onclick="mintNFT(3)" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-2 rounded text-xs font-bold transition">MINT</button></div>
              </div>
              <div class="nft-card bg-surface rounded-xl p-3 flex flex-col items-center text-center" style="--border-color: #ED8936;">
                  <div class="w-full aspect-square bg-yellow-900/30 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden group"><div class="absolute inset-0 bg-yellow-500 opacity-10"></div><i class="fas fa-crown text-5xl text-yellow-400 group-hover:scale-110 transition drop-shadow-[0_0_10px_gold]"></i></div>
                  <h3 class="text-yellow-400 font-bold uppercase text-sm">Legendary</h3><div class="text-[10px] text-gray-400 mb-2">APY: 2000%</div><div class="mt-auto w-full"><div class="text-white font-mono font-bold text-sm mb-2">250,000 PBJ</div><button onclick="mintNFT(4)" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-400 hover:from-yellow-500 hover:to-yellow-300 text-black py-2 rounded text-xs font-bold transition shadow-lg">MINT</button></div>
              </div>
          </div>
          <!-- Staking -->
          <div id="staking" class="bg-sidebar border border-gray-800 rounded-xl p-6 relative">
              <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white">Your Staked Assets</h2><button onclick="loadUserData()" class="text-xs bg-surface hover:bg-gray-700 px-3 py-1 rounded text-white"><i class="fas fa-sync mr-1"></i> Refresh</button></div>
              <div id="inventory-list" class="bg-[#0F212E] rounded-lg border border-dashed border-gray-700 h-48 overflow-y-auto p-4 mb-4 grid grid-cols-1 gap-2"><p class="text-center text-gray-500 text-xs mt-10">Connect wallet to view inventory</p></div>
              <div class="bg-surface p-4 rounded-lg flex justify-between items-center"><div><p class="text-[10px] text-gray-400">TOTAL STAKED</p><p id="total-staked" class="text-white font-bold">0 NFT</p></div><div><p class="text-[10px] text-gray-400">YIELD</p><p id="daily-yield" class="text-primary font-bold">0 PBJ/d</p></div><div class="text-right"><p class="text-[10px] text-gray-400">REWARDS</p><p id="pending-rewards" class="text-white font-mono font-bold">0.00</p></div></div>
              <button onclick="claimRewards()" class="w-full mt-2 bg-gray-700 hover:bg-white hover:text-black text-white text-xs py-2 rounded font-bold transition">CLAIM ALL REWARDS</button>
          </div>
      </section>

      <!-- PARTNERS -->
      <section id="partners" class="p-4 md:p-8">
          <h2 class="text-xl font-bold text-white mb-6 text-center">Affiliate Dashboard</h2>
          <div id="partner-locked" class="bg-sidebar border border-dashed border-gray-600 rounded-xl p-10 text-center"><i class="fas fa-lock text-4xl text-gray-500 mb-4"></i><h3 class="text-white font-bold">Locked</h3><p class="text-gray-400 text-sm mb-4">Connect wallet to earn 15% commissions.</p></div>
          <div id="partner-unlocked" class="hidden bg-sidebar border border-primary/30 rounded-xl p-8"><div class="flex bg-[#0F212E] p-2 rounded border border-gray-700"><input type="text" id="refLinkInput" readonly class="bg-transparent flex-1 text-gray-400 text-xs px-2 outline-none" value="https://pbj.bet/?ref=0x..."><button onclick="copyRefLink()" class="bg-primary text-black text-xs font-bold px-3 py-1 rounded hover:bg-white">COPY</button></div></div>
      </section>

      <footer class="bg-black/50 border-t border-gray-800 p-8 text-center text-xs text-gray-600"><p>&copy; 2025 PBJ Protocol.</p></footer>
    </main>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    // --- CONFIG ---
    const ADDR = {
        TOKEN: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5",
        PRESALE: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", 
        BLACKJACK: "0xbe0b8099B707e3c0bA278583C6b5561D82E77f3E",
        INSTANT: "0xbcF9DFfcDaDeC818F7B653aF1a7Ff287F3e7011f",
        NFT: "0xDE05dAf2cbF59ce9094979d639393ADED494e920"
    };

    const ABIS = {
        TOKEN: [ "function approve(address, uint256) external returns (bool)", "function balanceOf(address) external view returns (uint256)", "function allowance(address, address) external view returns (uint256)" ],
        PRESALE: [ "function buyTokens() payable" ],
        BLACKJACK: [ "function placeBet(uint256 amount) external", "event GameFinished(address indexed player, bool won, uint256 payout, uint256 dealerScore, uint256 playerScore)" ],
        INSTANT: [ 
            "function playSlots(uint256 _bet) external",
            "function playRoulette(uint256 _bet, uint256 _choice) external",
            "function playDice(uint256 _bet, uint256 _rollUnder) external",
            "function playPlinko(uint256 _bet) external",
            "function playCrash(uint256 _bet, uint256 _cashoutX) external",
            "function playMines(uint256 _bet, uint256 _minesCount) external",
            "function playKeno(uint256 _bet) external",
            "function playTower(uint256 _bet, uint256 _difficulty) external",
            // Events
            "event SlotsPlayed(address indexed player, uint256 bet, uint256 payout, uint256[3] outcome)",
            "event RoulettePlayed(address indexed player, uint256 bet, uint256 payout, uint256 roll, string color)",
            "event DicePlayed(address indexed player, uint256 bet, uint256 payout, uint256 rolled, uint256 prediction)",
            "event PlinkoPlayed(address indexed player, uint256 bet, uint256 payout, uint256 slot)",
            "event CrashPlayed(address indexed player, uint256 bet, uint256 payout, uint256 crashPoint, uint256 cashoutPoint)",
            "event MinesPlayed(address indexed player, uint256 bet, uint256 payout, bool exploded)",
            "event KenoPlayed(address indexed player, uint256 bet, uint256 payout, uint256 matches)",
            "event TowerPlayed(address indexed player, uint256 bet, uint256 payout, uint256 levelReached)"
        ],
        NFT: [ "function mint(uint256, uint256) external", "function stake(uint256, uint256) external", "function unstake(uint256, uint256) external", "function claim() external", "function getPendingRewards(address) view returns (uint256)", "function getStakedBalance(address, uint256) view returns (uint256)", "function balanceOf(address, uint256) view returns (uint256)", "function tierInfo(uint256) view returns (uint256 price, uint256 rewardPerSec, bool active)" ]
    };

    const TUTORIALS = {
        'slots': { t: 'Slots', d: 'Match 3 symbols to win big! RTP: 96%. Rare symbols pay 10x.' },
        'blackjack': { t: 'Blackjack', d: 'Beat the dealer to 21 without busting. Strategy matters! RTP: 99.5%.' },
        'roulette': { t: 'Roulette', d: 'Predict Red or Black. Simple 2x payout. RTP: 97.3%.' },
        'dice': { t: 'Dice', d: 'Roll under 50 to double your money. Provably Fair. RTP: 98%.' },
        'mines': { t: 'Mines', d: 'Avoid the 3 hidden mines. The more you reveal, the more you win. RTP: 97%.' },
        'tower': { t: 'Tower', d: 'Climb the tower levels. Higher risk = Higher reward. RTP: 96%.' },
        'crash': { t: 'Crash', d: 'Cash out before the rocket crashes! Multipliers can go 100x+. RTP: 95%.' },
        'plinko': { t: 'Plinko', d: 'Drop the ball and watch it fall into a multiplier slot. RTP: 97%.' },
        'keno': { t: 'Keno', d: 'Match random numbers. 4 matches = 20x Payout. RTP: 94%.' },
    };

    let provider, signer, address, contracts = {}, animInterval = null, currentGame = null;

    // --- SOUND SYSTEM ---
    const playSound = (id) => {
        const el = document.getElementById(`sfx-${id}`);
        if(el) { 
            el.volume = 0.3; 
            el.currentTime = 0; 
            el.play().catch(()=>{}); 
        }
    };

    // Global click sound
    document.body.addEventListener('click', (e) => {
        if(e.target.closest('button') || e.target.tagName === 'BUTTON') playSound('click');
    });

    const toast = (msg, type='success') => {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        const color = type === 'error' ? 'bg-red-500 border-red-700' : 'bg-[#0F212E] border-primary';
        t.className = `px-4 py-3 text-xs font-mono uppercase text-white border-l-4 shadow-lg mb-2 rounded ${color}`;
        t.innerHTML = `<strong>> SYSTEM:</strong> ${msg}`;
        c.appendChild(t); setTimeout(() => t.remove(), 3000);
    };

    window.setMaxBet = async () => {
        if(!signer) return;
        const bal = await contracts.token.balanceOf(address);
        document.getElementById('gameBetInput').value = ethers.utils.formatUnits(bal, 18);
    };

    window.toggleTutorial = () => {
        const overlay = document.getElementById('tutorialOverlay');
        const isHidden = overlay.classList.contains('hidden');
        if(isHidden && currentGame) {
             const data = TUTORIALS[currentGame];
             document.getElementById('tutTitle').innerText = data.t;
             document.getElementById('tutText').innerText = data.d;
             overlay.classList.remove('hidden'); overlay.classList.add('flex');
        } else {
             overlay.classList.add('hidden'); overlay.classList.remove('flex');
        }
    };

    document.getElementById('connectBtn').addEventListener('click', async () => {
        if(!window.ethereum) return alert("Install Metamask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            address = await signer.getAddress();
            contracts.token = new ethers.Contract(ADDR.TOKEN, ABIS.TOKEN, signer);
            contracts.presale = new ethers.Contract(ADDR.PRESALE, ABIS.PRESALE, signer);
            contracts.blackjack = new ethers.Contract(ADDR.BLACKJACK, ABIS.BLACKJACK, signer);
            contracts.instant = new ethers.Contract(ADDR.INSTANT, ABIS.INSTANT, signer);
            contracts.nft = new ethers.Contract(ADDR.NFT, ABIS.NFT, signer);
            updateUI(); loadUserData(); unlockPartners(); listenForWins(); toast("WALLET CONNECTED");
        } catch(e) { console.error(e); toast("Connection Failed", "error"); }
    });

    async function updateUI() {
        document.getElementById('connectBtn').innerHTML = `<i class="fas fa-user mr-1"></i> ${address.substring(0,6)}...`;
        try {
            const bal = await contracts.token.balanceOf(address);
            const fmt = Math.floor(parseFloat(ethers.utils.formatUnits(bal, 18)));
            document.getElementById('headerBalance').innerText = fmt.toLocaleString();
            document.getElementById('modalBalance').innerText = fmt.toLocaleString();
            document.getElementById('walletDisplay').style.display = 'flex';
        } catch(e) {}
    }

    // --- ANIMATION ENGINE ---
    function startAnimation(game) {
        if(animInterval) clearInterval(animInterval);
        const status = document.getElementById('gameStatus');
        status.innerText = "MINING TRANSACTION...";
        status.className = "bg-[#0b1820] pb-2 text-center text-xs font-mono uppercase tracking-widest text-primary animate-pulse";

        if (game === 'slots') {
            const emojis = ['üçí','üçã','üçá','üçâ','üîî','üíé','7Ô∏è‚É£'];
            const el = document.getElementById('slotRes');
            el.classList.add('blur-anim');
            animInterval = setInterval(() => { 
                const r = () => emojis[Math.floor(Math.random()*7)];
                el.innerHTML = `<div class="flex gap-2"><div class="slot-reel">${r()}</div><div class="slot-reel">${r()}</div><div class="slot-reel">${r()}</div></div>`; 
            }, 60);
        }
        else if (game === 'dice') {
            const el = document.getElementById('diceRes');
            el.classList.add('shaking');
            animInterval = setInterval(() => { el.innerText = Math.floor(Math.random() * 100); }, 30);
        }
        else if (game === 'crash') {
            const el = document.getElementById('crashRes');
            let val = 1.00;
            animInterval = setInterval(() => { val += 0.05; el.innerText = val.toFixed(2) + "x"; el.style.color = "#00E701"; }, 100);
        }
        else if (game === 'roulette') {
            const el = document.getElementById('rouletteRes');
            const colors = ['text-red-500', 'text-white'];
            el.classList.add('shaking');
            animInterval = setInterval(() => { el.innerText = Math.floor(Math.random() * 37); el.className = `text-6xl font-bold mb-2 ${colors[Math.floor(Math.random()*2)]}`; }, 80);
        }
    }

    function stopAnimation() {
        if(animInterval) clearInterval(animInterval);
        const els = document.querySelectorAll('.blur-anim, .shaking');
        els.forEach(e => e.classList.remove('blur-anim', 'shaking'));
    }

    // --- FLYING MONEY + BALANCE FIX ---
    function animateWinToBalance(amount) {
        const startEl = document.getElementById('innerGameContent');
        const endEl = document.getElementById('headerBalance');
        if(!startEl || !endEl) return;

        const rectStart = startEl.getBoundingClientRect();
        const rectEnd = endEl.getBoundingClientRect();

        const flyer = document.createElement('div');
        flyer.classList.add('fly-money');
        flyer.innerText = `+${amount.toLocaleString()}`;
        flyer.style.left = `${rectStart.left + rectStart.width/2 - 30}px`;
        flyer.style.top = `${rectStart.top + rectStart.height/2}px`;
        
        document.body.appendChild(flyer);

        requestAnimationFrame(() => {
            flyer.style.left = `${rectEnd.left}px`;
            flyer.style.top = `${rectEnd.top}px`;
            flyer.style.opacity = '0';
            flyer.style.transform = 'scale(0.5)';
        });

        setTimeout(() => {
            flyer.remove();
            
            // MATH FIX: Add to CURRENT display, don't replace
            const currentBalText = endEl.innerText.replace(/,/g, '');
            const currentBal = parseFloat(currentBalText) || 0;
            const targetBal = currentBal + parseInt(amount);

            animateValue("headerBalance", currentBal, targetBal, 1000);
            animateValue("modalBalance", currentBal, targetBal, 1000);

            // Silent sync with chain after animation to ensure accuracy
            setTimeout(updateUI, 1200);

        }, 1200); 
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    window.openGame = (game) => {
        currentGame = game;
        const m = document.getElementById('gameModal');
        const c = document.getElementById('innerGameContent');
        const t = document.getElementById('modalTitle');
        const btn = document.getElementById('gameActionBtn');
        const extra = document.getElementById('gameExtraControls');
        const status = document.getElementById('gameStatus');

        m.classList.remove('hidden'); m.classList.add('flex');
        extra.innerHTML = ''; extra.classList.add('hidden');
        status.innerText = "READY TO PLAY";
        status.className = "bg-[#0b1820] pb-2 text-center text-xs font-mono uppercase tracking-widest text-gray-500";
        btn.onclick = () => executeGame(game);

        if (game === 'slots') {
            t.innerText = "PEPE SLOTS"; 
            c.innerHTML = `<div class="flex gap-2" id="slotRes"><div class="slot-reel">üçí</div><div class="slot-reel">üçã</div><div class="slot-reel">üçá</div></div>`;
        } 
        else if (game === 'dice') {
            t.innerText = "DICE"; 
            c.innerHTML = `<div class="text-6xl font-bold text-white font-mono" id="diceRes">50</div><div class="text-xs text-primary mt-2 font-mono">&lt; ROLL UNDER 50 &gt;</div>`;
        }
        else if (game === 'blackjack') {
            t.innerText = "BLACKJACK"; 
            c.innerHTML = `<div class="flex flex-col gap-6 w-full p-4"><div class="text-center bg-white/5 p-4 rounded"><p class="text-[10px] text-gray-500 mb-1 uppercase">Dealer</p><div id="bjDealer" class="min-h-[80px] flex justify-center"><div class="card-visual card-black bg-gray-800 border-2 border-gray-600">?</div></div></div><div class="text-center bg-white/5 p-4 rounded"><div id="bjPlayer" class="min-h-[80px] flex justify-center"><div class="text-xl animate-pulse text-gray-500 font-mono">WAITING DEAL...</div></div><p class="text-[10px] text-gray-500 mt-1 uppercase">You</p></div></div>`;
        }
        else if (game === 'roulette') {
            t.innerText = "ROULETTE";
            c.innerHTML = `<div class="text-6xl font-bold mb-2 text-white font-mono" id="rouletteRes">0</div>`;
            extra.classList.remove('hidden');
            extra.innerHTML = `<button onclick="window.rouletteChoice=0" class="bg-red-600 hover:bg-red-500 text-white p-2 rounded text-xs font-bold flex-1">RED</button><button onclick="window.rouletteChoice=1" class="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded text-xs font-bold flex-1">BLACK</button>`;
            window.rouletteChoice = 0; 
        }
        else if (game === 'crash') {
            t.innerText = "CRASH";
            c.innerHTML = `<div class="text-6xl font-bold text-primary font-mono drop-shadow-[0_0_10px_rgba(57,255,20,0.8)]" id="crashRes">1.00x</div>`;
            extra.classList.remove('hidden');
            extra.innerHTML = `<input type="number" id="crashOut" value="2.00" step="0.1" class="bg-black border border-gray-600 rounded p-2 w-24 text-center text-white outline-none font-mono" placeholder="2.0">`;
        }
        else if (game === 'plinko') {
            t.innerText = "PLINKO";
            c.innerHTML = `<div class="text-6xl font-bold text-white font-mono animate-bounce" id="plinkoRes">DROP</div>`;
        }
        else if (game === 'keno') {
            t.innerText = "KENO";
            c.innerHTML = `<div class="text-6xl font-bold text-white font-mono" id="kenoRes">PICK</div>`;
        }
        else if (game === 'mines') {
            t.innerText = "MINES";
            let g = '<div class="mines-grid" id="minesGrid">';
            for(let i=0; i<25; i++) g+= `<div class="mine-cell bg-gray-700"></div>`;
            g += '</div>';
            c.innerHTML = g;
        }
        else if (game === 'tower') {
            t.innerText = "TOWER";
            c.innerHTML = `<div class="text-6xl font-bold text-white font-mono" id="towerRes">CLIMB</div>`;
            extra.classList.remove('hidden');
            extra.innerHTML = `<button onclick="window.towerDiff=0" class="bg-green-600 text-white p-2 rounded text-xs font-bold flex-1">EASY</button><button onclick="window.towerDiff=1" class="bg-yellow-600 text-white p-2 rounded text-xs font-bold flex-1">MED</button><button onclick="window.towerDiff=2" class="bg-red-600 text-white p-2 rounded text-xs font-bold flex-1">HARD</button>`;
            window.towerDiff = 1; 
        }
    };

    window.closeGame = () => { document.getElementById('gameModal').classList.add('hidden'); document.getElementById('gameModal').classList.remove('flex'); stopAnimation(); currentGame=null; };

    async function executeGame(game) {
        if(!signer) return toast("CONNECT WALLET", "error");
        const bet = ethers.utils.parseUnits(document.getElementById('gameBetInput').value, 18);
        const btn = document.getElementById('gameActionBtn');
        btn.disabled = true; btn.innerText = "AUTH...";

        try {
            const spender = game === 'blackjack' ? ADDR.BLACKJACK : ADDR.INSTANT;
            const allow = await contracts.token.allowance(address, spender);
            if(allow.lt(bet)) await (await contracts.token.approve(spender, ethers.constants.MaxUint256)).wait();

            btn.innerText = "MINING...";
            playSound('spin'); // START SOUND
            const gasOptions = { gasLimit: 500000 };
            let tx;

            switch(game) {
                case 'slots': tx = await contracts.instant.playSlots(bet, gasOptions); break;
                case 'blackjack': tx = await contracts.blackjack.placeBet(bet, gasOptions); break;
                case 'roulette': tx = await contracts.instant.playRoulette(bet, window.rouletteChoice || 0, gasOptions); break;
                case 'dice': tx = await contracts.instant.playDice(bet, 50, gasOptions); break;
                case 'plinko': tx = await contracts.instant.playPlinko(bet, gasOptions); break;
                case 'keno': tx = await contracts.instant.playKeno(bet, gasOptions); break;
                case 'mines': tx = await contracts.instant.playMines(bet, 3, gasOptions); break;
                case 'tower': tx = await contracts.instant.playTower(bet, window.towerDiff || 1, gasOptions); break;
                case 'crash': 
                    const mult = Math.floor(parseFloat(document.getElementById('crashOut').value) * 100);
                    tx = await contracts.instant.playCrash(bet, mult, gasOptions); 
                    break;
            }

            if (game !== 'blackjack') startAnimation(game);
            
            const receipt = await tx.wait(); 
            stopAnimation();

            if(game !== 'blackjack') {
                const event = receipt.events.find(e => e.event); 
                if (event) {
                    const args = event.args;
                    if(game === 'dice') showRes(args.payout, `ROLLED: ${args.rolled}`, 'diceRes', args.rolled);
                    else if(game === 'slots') showRes(args.payout, `SYMBOLS: ${args.outcome.join('-')}`, 'slotRes', `<div class="flex gap-2"><div class="slot-reel">${emoji(args.outcome[0])}</div><div class="slot-reel">${emoji(args.outcome[1])}</div><div class="slot-reel">${emoji(args.outcome[2])}</div></div>`);
                    else if(game === 'roulette') showRes(args.payout, `RESULT: ${args.roll}`, 'rouletteRes', args.roll);
                    else if(game === 'plinko') showRes(args.payout, `BUCKET: ${args.slot}`, 'plinkoRes', `BIN ${args.slot}`);
                    else if(game === 'keno') showRes(args.payout, `MATCHES: ${args.matches}`, 'kenoRes', `${args.matches} HITS`);
                    else if(game === 'mines') {
                         showRes(args.payout, args.exploded ? "BOOM" : "SAFE");
                         const cells = document.querySelectorAll('.mine-cell');
                         cells.forEach(c => {
                             c.className = args.exploded ? "mine-cell boom" : "mine-cell safe";
                             c.innerText = args.exploded ? "üí£" : "üíé";
                         });
                    }
                    else if(game === 'tower') showRes(args.payout, `LEVEL: ${args.levelReached}`, 'towerRes', `LVL ${args.levelReached}`);
                    else if(game === 'crash') { const c = (args.crashPoint/100).toFixed(2); showRes(args.payout, `CRASHED @ ${c}x`, 'crashRes', c+"x"); }
                }
            } else {
                document.getElementById('gameStatus').innerText = "WAITING FOR DEALER...";
            }

        } catch(e) {
            console.error(e); stopAnimation();
            document.getElementById('gameStatus').innerText = "ERROR: TRANSACTION FAILED";
            btn.disabled = false; btn.innerText = "PLAY"; toast("TX Failed", "error");
        }
    }

    // --- HELPERS ---
    function generateHandFromScore(targetScore) {
        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£']; const cards = []; let currentSum = 0;
        if (targetScore === 21) return [{val:'A', s:suits[0]}, {val:'K', s:suits[1]}];
        if (targetScore > 21) return [{val:'10', s:suits[2]}, {val:'10', s:suits[3]}, {val:'5', s:suits[0]}];
        while(currentSum < targetScore) {
            let diff = targetScore - currentSum; let val = diff > 10 ? 10 : diff;
            if (currentSum === 0 && diff > 10) val = Math.floor(Math.random() * 9) + 2;
            if (currentSum + val > targetScore) val = targetScore - currentSum;
            currentSum += val;
            let displayVal = val.toString();
            if (val === 1 || val === 11) displayVal = 'A';
            if (val === 10) displayVal = ['10', 'J', 'Q', 'K'][Math.floor(Math.random()*4)];
            cards.push({ val: displayVal, s: suits[Math.floor(Math.random() * 4)] });
        }
        return cards;
    }

    function renderCards(elementId, score) {
        const container = document.getElementById(elementId);
        const hand = generateHandFromScore(score);
        let html = `<div class="flex gap-2 justify-center">`;
        hand.forEach(c => {
            const isRed = (c.s === '‚ô•' || c.s === '‚ô¶');
            html += `<div class="card-visual ${isRed?'card-red':'card-black'}"><span>${c.val}</span><span class="text-xs">${c.s}</span></div>`;
        });
        html += `</div><div class="text-xs mt-2 text-gray-400 font-mono">SCORE: ${score}</div>`;
        container.innerHTML = html;
    }

    function listenForWins() {
        if(!contracts.blackjack) return;
        contracts.blackjack.on("GameFinished", (p, won, pay, dScore, pScore) => {
            if(p == address) {
                renderCards('bjDealer', dScore);
                renderCards('bjPlayer', pScore);
                showRes(pay, won ? "YOU WON!" : "DEALER WINS");
            }
        });
    }

    function emoji(num) { return ['üçí','üçã','üçá','üçâ','üîî','üíé','7Ô∏è‚É£'][num] || num; }

    function showRes(payout, text, elemId = null, elemVal = null) {
        stopAnimation();
        const btn = document.getElementById('gameActionBtn');
        const status = document.getElementById('gameStatus');
        btn.disabled = false; btn.innerText = "PLAY AGAIN";
        
        const payVal = ethers.BigNumber.from(payout);
        const won = payVal.gt(0);
        const profit = ethers.utils.formatUnits(payVal, 18);
        const profitInt = parseInt(profit);
        
        status.innerText = text + (won ? ` (+${profitInt} PBJ)` : "");
        status.className = "bg-[#0b1820] pb-2 text-center text-xs font-mono uppercase tracking-widest " + (won ? "text-primary" : "text-red-500");

        if(elemId && elemVal) {
            const el = document.getElementById(elemId);
            el.innerHTML = elemVal;
            if(won) el.classList.add('animate-bounce');
        }

        if(won) {
            playSound('win'); // WIN SOUND
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00E701', '#ffffff'] });
            animateWinToBalance(profitInt);
        } else {
            playSound('lose'); // LOSE SOUND
            updateUI();
        }
    }

    function unlockPartners() { document.getElementById('partner-locked').classList.add('hidden'); document.getElementById('partner-unlocked').classList.remove('hidden'); document.getElementById('refLinkInput').value = `${window.location.origin}?ref=${address}`; }
    window.copyRefLink = () => { document.getElementById("refLinkInput").select(); navigator.clipboard.writeText(document.getElementById("refLinkInput").value); toast("LINK COPIED"); };
    
    // --- NFT LOGIC ---
    window.mintNFT = async (id) => { if(!signer) return toast("Connect Wallet", "error"); try { const info = await contracts.nft.tierInfo(id); const allow = await contracts.token.allowance(address, ADDR.NFT); if(allow.lt(info.price)) await (await contracts.token.approve(ADDR.NFT, ethers.constants.MaxUint256)).wait(); await (await contracts.nft.mint(id, 1)).wait(); toast("MINT SUCCESSFUL"); loadUserData(); updateUI(); } catch(e) { toast("MINT FAILED", "error"); } };
    window.stakeNFT = async (id) => { try { await (await contracts.nft.stake(id, 1)).wait(); loadUserData(); toast("STAKED"); } catch(e){} };
    window.unstakeNFT = async (id) => { try { await (await contracts.nft.unstake(id, 1)).wait(); loadUserData(); toast("UNSTAKED"); } catch(e){} };
    window.claimRewards = async () => { try { await (await contracts.nft.claim()).wait(); toast("REWARDS CLAIMED"); loadUserData(); } catch(e){} };
    window.loadUserData = async () => { if(!signer) return; const list = document.getElementById('inventory-list'); list.innerHTML = ''; let totalStaked = 0, dailyYield = 0; const tiers = ["COMMON", "UNCOMMON", "RARE", "EPIC", "LEGEND"]; const rates = [50, 120, 350, 800, 2000]; for(let i=0; i<5; i++) { try { const bal = await contracts.nft.balanceOf(address, i); const staked = await contracts.nft.getStakedBalance(address, i); totalStaked += parseInt(staked); dailyYield += parseInt(staked) * rates[i]; if(bal > 0) list.innerHTML += `<div class="flex justify-between bg-gray-900 p-2 rounded mb-1 border-l-2 border-gray-600"><span class="text-xs text-white">${tiers[i]} (${bal})</span><button onclick="stakeNFT(${i})" class="text-[10px] text-primary hover:text-white">STAKE >></button></div>`; if(staked > 0) list.innerHTML += `<div class="flex justify-between bg-green-900/20 p-2 rounded mb-1 border-l-2 border-primary"><span class="text-xs text-primary">${tiers[i]} (STAKED)</span><button onclick="unstakeNFT(${i})" class="text-[10px] text-white hover:text-red-400"><< UNSTAKE</button></div>`; } catch(e) {} } document.getElementById('total-staked').innerText = totalStaked + " NFT"; document.getElementById('daily-yield').innerText = dailyYield + " PBJ/d"; try { const rew = await contracts.nft.getPendingRewards(address); document.getElementById('pending-rewards').innerText = parseFloat(ethers.utils.formatUnits(rew, 18)).toFixed(2); } catch(e) {} };

    document.getElementById('buyInput').addEventListener('input', (e) => { const v = e.target.value; if(v) document.getElementById('receiveInput').value = (v * 1000000).toFixed(0); });
    document.getElementById('buyBtn').addEventListener('click', async () => { if(!signer) return alert("Connect"); try { await (await contracts.presale.buyTokens({value:ethers.utils.parseEther(document.getElementById('buyInput').value)})).wait(); alert("Bought!"); updateUI(); } catch(e){} });

    let target = localStorage.getItem('pEnd') || Date.now() + (5 * 24 * 3600 * 1000); localStorage.setItem('pEnd', target);
    setInterval(() => { const d = target - Date.now(); if(d>0) { document.getElementById('d').innerText = Math.floor(d/86400000); document.getElementById('h').innerText = Math.floor((d%86400000)/3600000); document.getElementById('m').innerText = Math.floor((d%3600000)/60000); document.getElementById('s').innerText = Math.floor((d%60000)/1000); } }, 1000);
    let bonusTarget = localStorage.getItem('bEnd') || Date.now() + (2 * 3600 * 1000); localStorage.setItem('bEnd', bonusTarget);
    setInterval(() => { let diff = bonusTarget - Date.now(); if(diff <= 0) { bonusTarget = Date.now() + (2 * 3600 * 1000); localStorage.setItem('bEnd', bonusTarget); } const h = Math.floor((diff % 86400000) / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); document.getElementById('bonusTimer').innerText = `0${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`; }, 1000);
  </script>
</body>
</html>
