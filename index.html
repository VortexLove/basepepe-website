<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pepe Blackjack (PBJ) - DApp</title>

    <!-- Ethers & web3 (keep for compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

    <!-- Web3Modal v1 + WalletConnect provider (CDN) -->
    <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

    <script src="./cdn.tailwindcss.js"></script>
    <!-- tsParticles for animated background -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <!-- Pixel Art Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
      html, body, * {
        font-family: 'Press Start 2P', cursive !important;
      }
      /* Remove arrows from number inputs */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      #tsparticles {
        position: fixed;
        z-index: -1;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
      .card {
        position: relative;
        width: 120px;
        height: 160px;
        background: white;
        border: 2px solid #222;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }
      .card.deal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .card .corner {
        position: absolute;
        font-size: 0.8rem;
      }
      .card .top-left {
        top: 4px;
        left: 6px;
      }
      .card .bottom-right {
        bottom: 4px;
        right: 6px;
        transform: rotate(180deg);
      }
      .red-suit { color: red; }
      .black-suit { color: black; }
      .form-presale.input {
          width: 70%;
      }
      .w-100 {
        width: 100%;
      }
      .top-45 {
        top: 10.5rem;
      }
      .bottom-45 {
        bottom: 10.5rem;
      }
      .image-pepe-preventa {
        height: 25rem;
        width: auto;
        margin-right: auto;
        margin-left: auto;
      }
      @media (max-width: 500px) {
        .cartas-blackjack {
          height: 25rem !important;
        }
      }
      /* NEW: Style for NFT card text */
      .nft-card h2,
      .nft-card p {
        color: #22c55e;
        font-size: 18px;
      }
      .nft-card p {
        font-size: 15px;
      }

      /* NFT list styles */
      .nft-section {
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 20px;
        max-width: 100%;
        scroll-snap-type: x mandatory;
        scroll-padding-left: 0;
        scroll-behavior: smooth;
      }

      .nft-card {
        flex: 0 0 240px;
        padding: 10px;
        border-radius: 8px;
        background: transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        scroll-snap-align: start;
      }

      .nft-card img {
        width: 100%;
        max-width: 250px;
        margin-bottom: 25px;
      }

      .pixel-button {
        background: #00FF00;
        border: 2px solid #003300;
        color: #000;
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
        padding: 8px 12px;
        cursor: pointer;
        box-shadow: 2px 2px 0 #003300;
        transition: transform 0.1s;
      }

      .pixel-button:hover {
        transform: scale(1.05);
      }

      @media (max-width: 500px) {
      .nft-section {
        gap: 10px;
        padding: 8px;
      }
      .nft-card {
        flex: 0 0 170px;
        padding: 4px;
      }
      .nft-card img {
        max-width: 140px;
      }
    }

    /* user/staked containers */
    #userNFTsAvailable, #userNFTsStaked {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }
    #userNFTsAvailable > div, #userNFTsStaked > div {
      flex: 0 0 220px;
      background: #111;
      border: 2px solid #22c55e; /* green */
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      color: #a6f4a6;
      box-shadow: 0 0 8px #22c55e88;
    }
    #userNFTsAvailable img, #userNFTsStaked img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      image-rendering: pixelated;
    }
    #userNFTsAvailable button, #userNFTsStaked button {
      margin-top: 10px;
      background-color: #00ff00;
      color: #000;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      padding: 6px 10px;
      border: 2px solid #003300;
      cursor: pointer;
      box-shadow: 2px 2px 0 #003300;
      border-radius: 4px;
      transition: transform 0.1s;
    }
    #userNFTsAvailable button:hover, #userNFTsStaked button:hover {
      transform: scale(1.05);
    }
    </style>
  </head>
  <body class="bg-gray-950 text-white min-h-screen">
    <div id="tsparticles"></div>
    <div class="max-w-4xl mx-auto p-4 space-y-8">

      <!-- Header -->
      <header class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700">
        <h1 class="text-2xl sm:text-3xl font-bold text-green-400 mb-4 md:mb-0">Pepe Blackjack (PBJ)</h1>
        <button
          id="connectButton"
          class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-white w-full sm:w-auto text-center"
        >Connect Wallet</button>
        
        <div id="pbjDisplay" style="display: flex; align-items: center; gap: 8px; font-family: 'Press Start 2P', cursive; font-size: 20px; color: #39ff14; background: transparent; padding: 10px 20px;">
          <img src="./Coin.png" alt="PBJ Coin" width="48" height="48" style="image-rendering: pixelated; border-radius: 50%; border: none;">
          <span id="pbjBalanceHeader">0</span> PBJ
        </div>
        
      </header>
      <div id="status" class="text-center text-base sm:text-lg"></div>

      <!-- PRESALE BLOCK: IMAGE + BARS + VOTING -->
<div class="flex flex-col md:flex-row items-center md:items-stretch gap-6 my-8">
  <!-- Presale image -->
  <div class="flex-shrink-0 flex justify-center items-center md:justify-start md:items-start">
    <img
      src="./preventa.png"
      alt="presale"
      class="image-pepe-preventa rounded-lg border-0 border-gray-700 shadow-inner max-h-80 md:max-h-none"
      style="height: 28rem; width: auto; margin:0;"
    />
  </div>
  
  <!-- Sections: time bar, ETH bar, voting -->
  <div class="flex flex-col gap-4 flex-1">
    <!-- Presale time bar -->
    <div id="presale-timer" class="w-full max-w-md mx-auto my-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center">
      <div class="w-full mb-2">
        <div class="h-4 w-full bg-gray-700 rounded-full overflow-hidden">
          <div id="presale-progress" class="h-4 bg-green-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
        </div>
      </div>
      <div class="text-green-400 font-semibold text-lg" id="presale-countdown">Loading...</div>
      <div class="text-xs text-gray-400 mt-1">Presale time left (7 days)</div>
    </div>

    <!-- ETH collected bar -->
    <div id="eth-collected-bar" class="w-full max-w-md mx-auto my-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center">
      <div class="w-full mb-2">
        <div class="h-4 w-full bg-gray-700 rounded-full overflow-hidden">
          <div id="eth-collected-progress" class="h-4 bg-blue-500 rounded-full transition-all duration-500" style="width: 10%;"></div>
        </div>
      </div>
      <div class="text-blue-400 font-semibold text-lg" id="eth-collected-count">2 ETH collected of 20</div>
      <div class="text-xs text-gray-400 mt-1">Presale goal: 20 ETH</div>
    </div>

    <!-- Presale voting with emojis -->
    <div id="presale-vote" class="w-full max-w-md mx-auto mb-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center">
      <div class="font-semibold text-gray-200 mb-2">What do you think about the presale?</div>
      <div class="flex gap-4 mb-2">
        <button class="emoji-vote-btn text-2xl" data-emoji="üëç">üëç</button>
        <button class="emoji-vote-btn text-2xl" data-emoji="üî•">üî•</button>
        <button class="emoji-vote-btn text-2xl" data-emoji="ü§©">ü§©</button>
        <button class="emoji-vote-btn text-2xl" data-emoji="üíé">üíé</button>
        <button class="emoji-vote-btn text-2xl" data-emoji="üòÇ">üòÇ</button>
      </div>
      <div id="vote-results" class="flex gap-3 mt-2 text-lg"></div>
    </div>
  </div>
</div>
<!-- END PRESALE BLOCK -->

      <!-- NFT showcase (static shop) -->
<div class="nft-section">
  <div class="nft-card">
    <img src="nft1.png" alt="Common NFT">
    <h2>üü¢ Common</h2>
    <p>5000 $PBJ - Reward: 200 $PBJ/day</p>
    <button class="pixel-button" onclick="buyNFT(0)">Buy NFT üü¢ Common</button>
  </div>

  <div class="nft-card">
    <img src="nft2.png" alt="Rare NFT">
    <h2>üîµ Rare</h2>
    <p>10000 $PBJ - Reward: 500 $PBJ/day</p>
    <button class="pixel-button" onclick="buyNFT(1)">Buy NFT üîµ Rare</button>
  </div>

  <div class="nft-card">
    <img src="nft3.png" alt="Legendary NFT">
    <h2>üü£ Legendary</h2>
    <p>25000 $PBJ - Reward: 1500 $PBJ/day</p>
    <button class="pixel-button" onclick="buyNFT(2)">Buy NFT üü£ Legendary</button>
  </div>
</div>

      <section id="nftSection" style="text-align:center; margin-top: 40px;">
  <h2 style="font-family: monospace; font-size: 24px; margin-bottom: 20px;">Your PepeBlackjack NFTs</h2>

  <h3 style="font-size:12px; color:#9ae6b4; text-align:center;">Available to Stake</h3>
  <div id="userNFTsAvailable" style="min-height:80px;">
    <!-- NFTs owned by user (not staked) will be inserted here -->
  </div>

  <h3 style="font-size:12px; color:#9ae6b4; text-align:center; margin-top:18px;">Your Staked NFTs</h3>
  <div id="userNFTsStaked" style="min-height:80px;">
    <!-- Staked NFTs (from staking contract) will be inserted here -->
  </div>
</section>

      <section id="staking-section" class="bg-gray-900 p-6 rounded-xl shadow-xl mt-8">
  <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-6">ü™ô Stake your PepeBlackjack NFTs</h2>

  <div>
    <h3 class="text-green-400 font-semibold mb-2">Your NFTs available for staking</h3>
    <div id="userNFTs" class="flex gap-6 overflow-x-auto py-2" style="display:none;">
      <!-- kept for backward compatibility but not used -->
    </div>
  </div>

  <div class="mt-8">
    <h3 class="text-green-400 font-semibold mb-2">Your staked NFTs</h3>
    <div id="stakedNFTs" class="flex gap-6 overflow-x-auto py-2" style="display:none;">
      <!-- kept for backward compatibility but not used -->
    </div>
  </div>

  <div class="mt-6">
    <button id="refreshStaking" class="pixel-button">Refresh Staking Data</button>
  </div>
</section>

      <!-- BUY COMPONENT -->
      <section class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full sm:max-w-md mx-auto">
        <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-6">Token Purchase</h2>

        <!-- Balance -->
        <div class="flex justify-between text-xs sm:text-sm text-gray-400 mb-4">
          <span>ETH Balance</span>
          <span id="ethBalance" class="font-mono text-white">0.0000 ETH</span>
        </div>

        <!-- Inputs -->
        <div class="space-y-4 mb-6 form-presale">
          <!-- ETH ‚Üí PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="ethAmount"
              min="0.01"
              step="0.0001"
              value="0.01"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0.0 ETH"
            />
            <span class="text-gray-300 font-medium text-sm">ETH</span>
          </div>

          <!-- Arrow SVG -->
          <div class="flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="pbjAmount"
              min="10000"
              step="10000"
              value="10000"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0 PBJ"
            />
            <span class="text-gray-300 font-medium text-sm">PBJ</span>
          </div>
        </div>

        <!-- Main button -->
        <button
          id="buyButton"
          disabled
          class="w-full py-2 sm:py-3 rounded-lg bg-gradient-to-r from-green-500 to-green-700 text-white font-semibold hover:from-green-600 hover:to-green-800 disabled:opacity-50 text-sm sm:text-base"
        >Buy</button>
      </section>

      <!-- Blackjack Game -->
      <section id="blackjackGame" class="bg-gray-900 p-4 sm:p-6 rounded-xl shadow-xl">
        <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-4">üÉè Blackjack Game</h2>
        <div class="mb-4 text-xs sm:text-sm flex flex-col sm:flex-row sm:items-center sm:space-x-8 space-y-2 sm:space-y-0">
       <div class="flex items-center space-x-2">
  <div class="text-xs text-green-400" style="font-family: 'Press Start 2P', cursive;">
    Balance: <span id="pbjBalanceGame">0</span> PBJ
  </div>
  <label for="betAmount" class="text-sm ml-4">Bet:</label>
  <input
    type="number"
    id="betAmount"
    min="1"
    step="1"
    value="1000"
    class="w-20 px-2 py-1 rounded bg-gray-800 text-white text-sm"
  />
</div>
        </div>

        <div class="relative h-64 sm:h-96 cartas-blackjack mb-4">
          <div id="dealerArea" class="absolute top-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"></div>
          <div class="absolute top-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center">
            Dealer Points: <span id="dealerScore">0</span>
          </div>

          <div id="playerArea" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"></div>
          <div class="absolute bottom-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center">
            Player Points: <span id="playerScore">0</span>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
          <button id="dealBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded flex-1">Deal</button>
          <button id="hitBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>Hit</button>
          <button id="standBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>Stand</button>
        </div>

        <div id="resultMsg" class="mt-4 text-base sm:text-lg font-semibold text-center"></div>
      </section>

      <!-- Lore -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <!-- Image -->
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <!-- Make sure Carta.png is next to this HTML -->
    <img
      src="./carta.png"
      alt="BasePepe Card"
      class="w-full h-auto rounded-lg border-0 border-gray-700 shadow-inner"
    />
  </div>

  <!-- Text -->
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Lore</h2>
    <p class="text-gray-300 leading-relaxed text-sm sm:text-base">
      Pepe Blackjack (PBJ) arises from the legendary frog table of the cyber-casino.
      This token mixes meme humor with the thrill of blackjack, offering a
      unique risk and reward experience on the Base Blockchain.
    </p>
  </div>
</section>

      <!-- Roadmap, Tokenomics, Team, FAQ etc... (unchanged sections below) -->
<section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <img
      src="./logo.png"
      alt="logo"
      class="w-full h-auto rounded-lg border-2 border-gray-700 shadow-inner"
    />
  </div>
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Roadmap</h2>
    <ul class="text-gray-300 leading-relaxed text-sm sm:text-base">
          <li><strong>Q2 2025:</strong> PBJ presale on Base and official launch.</li>
          <li><strong>Q3 2025:</strong> Listed on DEX, staking features.</li>
          <li><strong>Q4 2025:</strong> Web3 Blackjack platform with NFT integration.</li>
          <li><strong>Q1 2026:</strong> Metaverse expansion and rewards for holders.</li>
    </ul>
  </div>
</section>

<section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <img
      src="./pepe_crupier.png"
      alt="pepe"
      class="w-full h-auto rounded-lg border-2 border-gray-700 shadow-inner"
    />
  </div>
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Tokenomics</h2>
    <ul class="text-gray-300 space-y-1">
          <li><strong>Symbol:</strong> PBJ</li>
          <li><strong>Network:</strong> Base</li>
          <li><strong>Total supply:</strong> 1,000,000,000 PBJ</li>
          <li><strong>Price (Presale):</strong> 1 ETH = 1,000,000 PBJ</li>
          <li><strong>Contract:</strong> <a href="https://basescan.org/address/0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5" class="text-blue-400 underline" target="_blank">0xff4b4...44E5</a></li>
        </ul>
  </div>
</section>

      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">üë• Team and Links</h2>
        <ul class="text-gray-300 space-y-2">
          <li><strong>Team:</strong> Vortex (Development), John Smith (Marketing), CryptoFrogDAO (Community)</li>
          <li><strong>Official website:</strong> <a href="#" class="text-blue-400 underline">www.pepeblackjack.online</a></li>
          <li><strong>Twitter:</strong> <a href="https://twitter.com/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a></li>
          <li><strong>Telegram:</strong> <a href="https://t.me/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a></li>
        </ul>
      </section>

      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">‚ùì FAQ</h2>
        <div class="text-gray-300 space-y-4">
          <div>
            <h3 class="font-semibold">How do I buy PBJ?</h3>
            <p>Connect your wallet, enter the amount in ETH or PBJ and press "Buy".</p>
          </div>
          <div>
            <h3 class="font-semibold">What happens when the presale ends?</h3>
            <p>The <code>endPresale()</code> function disables purchases; you will only be able to trade on DEX afterwards.</p>
          </div>
        </div>
      </section>

      </div>
    </div>

<script>
/* tsParticles Background */
tsParticles.load("tsparticles", {
  background: { color: { value: "#000" } },
  fpsLimit: 60,
  interactivity: {
    events: { onHover: { enable: true, mode: "repulse" }, resize: true },
    modes: { repulse: { distance: 100, duration: 0.4 } }
  },
  particles: {
    color: { value: "#00ff99" },
    links: { enable: true, color: "#00ff99", distance: 150 },
    move: { enable: true, speed: 2 },
    number: { value: 60 },
    opacity: { value: 0.5 },
    shape: { type: "circle" },
    size: { value: { min: 1, max: 3 } }
  },
  detectRetina: true
});
</script>

<script>
/*
  Integraci√≥n de staking frontend:
  - Contrato staking: 0xdCd0fe15Da1b7466886237e7984F1deB8aac49CB
  - Hooks para stake/unstake/claim y mostrar NFTs staked/owned.
  - Normalizaci√≥n de tokenURI ipfs:// -> https://ipfs.io/ipfs/
*/

/* ---------------------------
   Globals & Config
   --------------------------- */
let provider;        // ethers provider (ethers.providers.Web3Provider)
let signer;          // ethers signer
let userAddress;
let pbjContract, casinoContract, contract;
let nftContractInstance;
let stakingContract;

const stakingAddress = '0xdCd0fe15Da1b7466886237e7984F1deB8aac49CB'; // provided by you
const nftAddress = "0x4AabC024D719240e98e82930EAC04bD49CB86E31"; // NFT contract (same as before)
const pbjTokenAddress = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5'; // token (PBJ)
const casinoAddress = '0x79e617b64eae98bda7f8Cd4b1EdC05dE696E4B74';

const pbjAbi = [
  'function balanceOf(address) view returns (uint256)',
  'function decimals() view returns (uint8)',
  'function approve(address spender, uint256 amount) returns (bool)',
  'function allowance(address owner, address spender) view returns (uint256)'
];

const nftMinimalAbi = [
  "function balanceOf(address owner) view returns (uint256)",
  "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
  "function tokenURI(uint256 tokenId) view returns (string)",
  "function approve(address to, uint256 tokenId) external",
  "function getApproved(uint256 tokenId) view returns (address)",
  "function ownerOf(uint256 tokenId) view returns (address)"
];

const stakingAbi = [
  "function stake(uint256 tokenId) external",
  "function stakeBatch(uint256[] calldata tokenIds) external",
  "function unstake(uint256 tokenId) external",
  "function unstakeBatch(uint256[] calldata tokenIds) external",
  "function claim(uint256 tokenId) external",
  "function claimBatch(uint256[] calldata tokenIds) external",
  "function earned(uint256 tokenId) external view returns (uint256)",
  "function stakedTokensOf(address owner) external view returns (uint256[] memory)",
  "function stakedCount(address owner) external view returns (uint256)"
];

/* ---------------------------
   Web3Modal + WalletConnect
   --------------------------- */
const providerOptions = {
  walletconnect: {
    package: window.WalletConnectProvider.default,
    options: {
      rpc: {
        8453: 'https://mainnet.base.org'
      },
      bridge: 'https://bridge.walletconnect.org',
      qrcode: true
    }
  }
};

const web3Modal = new window.Web3Modal.default({
  cacheProvider: true,
  providerOptions,
  theme: "dark"
});

/* ---------------------------
   Utils: IPFS / data URI handling
   --------------------------- */
function ipfsToHttp(uri) {
  if (!uri) return uri;
  if (uri.startsWith('ipfs://')) {
    // remove ipfs:// and map to ipfs gateway
    return uri.replace(/^ipfs:\/\//, 'https://ipfs.io/ipfs/');
  }
  return uri;
}

function decodeBase64Json(uri) {
  const prefix = 'data:application/json;base64,';
  if (typeof uri === 'string' && uri.startsWith(prefix)) {
    try {
      const json = atob(uri.slice(prefix.length));
      return JSON.parse(json);
    } catch (e) {
      console.error('decodeBase64Json error', e);
      return null;
    }
  }
  return null;
}

async function fetchMetadataFromURI(uri) {
  const inline = decodeBase64Json(uri);
  if (inline) return inline;
  const url = ipfsToHttp(uri);
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('fetch status ' + res.status);
    return await res.json();
  } catch (e) {
    console.warn('fetchMetadataFromURI failed for', uri, e);
    return null;
  }
}

/* ---------------------------
   Connect / init
   --------------------------- */
async function connectWallet() {
  try {
    const externalProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(externalProvider);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    // subscribe events
    if (externalProvider.on) {
      externalProvider.on("accountsChanged", (accounts) => {
        if (accounts.length === 0) {
          disconnectWallet();
        } else {
          userAddress = accounts[0];
          updatePBJBalance();
          loadUserNFTs();
        }
      });
      externalProvider.on("chainChanged", async (chainId) => {
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          alert('Cambia a la red Base (Mainnet) para usar esta dApp.');
        } else {
          updatePBJBalance();
        }
      });
      externalProvider.on("disconnect", (code, reason) => {
        disconnectWallet();
      });
    }

    const network = await provider.getNetwork();
    if (network.chainId !== 8453) {
      alert('Por favor, cambia la red a Base (Mainnet).');
    }

    // Init contracts with signer
    pbjContract = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);
    nftContractInstance = new ethers.Contract(nftAddress, nftMinimalAbi, signer);
    stakingContract = new ethers.Contract(stakingAddress, stakingAbi, signer);

    document.getElementById('status').innerText = '‚úÖ Wallet conectada: ' + shorten(userAddress);
    document.getElementById('buyButton').disabled = false;

    const balance = await provider.getBalance(userAddress);
    document.getElementById('ethBalance').innerText = `${parseFloat(ethers.utils.formatEther(balance)).toFixed(4)} ETH`;

    // Load NFTs & balances
    await loadUserNFTs();
    await updatePBJBalance();

  } catch (err) {
    console.error("connectWallet error:", err);
    document.getElementById('status').innerText = '‚ùå Error al conectar wallet';
  }
}

function disconnectWallet() {
  try {
    web3Modal.clearCachedProvider();
    provider = null;
    signer = null;
    userAddress = null;
    document.getElementById('status').innerText = 'Wallet desconectada';
    document.getElementById('pbjBalanceHeader').innerText = '0';
    document.getElementById('pbjBalanceGame').innerText = '0';
    document.getElementById('ethBalance').innerText = '0.0000 ETH';
    document.getElementById('buyButton').disabled = true;
    // Clear UI
    document.getElementById('userNFTsAvailable').innerHTML = '';
    document.getElementById('userNFTsStaked').innerHTML = '';
  } catch (e) {
    console.error("disconnect error", e);
  }
}

function shorten(addr) {
  if (!addr) return '';
  return addr.slice(0,6) + '...' + addr.slice(-4);
}

/* ---------------------------
   Load NFTs (owned + staked)
   --------------------------- */
async function loadUserNFTs() {
  const availableContainer = document.getElementById("userNFTsAvailable");
  const stakedContainer = document.getElementById("userNFTsStaked");
  availableContainer.innerHTML = '';
  stakedContainer.innerHTML = '';

  if (!provider || !userAddress) {
    availableContainer.innerHTML = `<p class="text-gray-400">Conecta tu wallet para ver NFTs.</p>`;
    stakedContainer.innerHTML = `<p class="text-gray-400">Conecta tu wallet para ver NFTs staked.</p>`;
    return;
  }

  try {
    // Get list of tokens staked by user from staking contract
    let staked = [];
    try {
      staked = await stakingContract.stakedTokensOf(userAddress);
    } catch (e) {
      console.warn('stakedTokensOf failed', e);
      staked = [];
    }
    const stakedSet = new Set(staked.map(t => t.toString()));

    // Get owned NFTs via ERC-721 enumeration
    const balanceBN = await nftContractInstance.balanceOf(userAddress);
    const balanceNum = Number(balanceBN.toString());

    // If user owns zero NFTs, still check if they have staked NFTs
    if (balanceNum === 0) {
      availableContainer.innerHTML = `<p class="text-gray-400">No tienes NFTs disponibles.</p>`;
    } else {
      for (let i = 0; i < balanceNum; i++) {
        const tokenIdBN = await nftContractInstance.tokenOfOwnerByIndex(userAddress, i);
        const tokenId = tokenIdBN.toString();
        // fetch tokenURI & metadata
        let tokenURI;
        try { tokenURI = await nftContractInstance.tokenURI(tokenId); } catch(e) { tokenURI = null; }
        const metadata = tokenURI ? (await fetchMetadataFromURI(tokenURI)) : null;
        const image = metadata && metadata.image ? (metadata.image.startsWith('ipfs://') ? ipfsToHttp(metadata.image) : metadata.image) : './nft-placeholder.png';
        const name = metadata && metadata.name ? metadata.name : `NFT #${tokenId}`;

        // If token is staked, it will appear in staked container (stakedSet may include it)
        if (stakedSet.has(tokenId)) {
          // We'll show it in staked container after we iterate staked tokens (to also show tokens staked but not owned)
          continue;
        }

        const card = document.createElement("div");
        card.innerHTML = `
          <img src="${image}" alt="NFT ${tokenId}" />
          <div class="text-white font-semibold text-lg mb-2">${name}</div>
          <div style="font-size:12px; color:#9ae6b4;">Token ID: ${tokenId}</div>
          <button onclick="stakeNFT(${tokenId})">Stake</button>
        `;
        availableContainer.appendChild(card);
      }
    }

    // Show staked tokens (these belong to user but are held by staking contract)
    if (staked.length === 0) {
      stakedContainer.innerHTML = `<p class="text-gray-400">No tienes NFTs staked.</p>`;
    } else {
      // For each staked token, fetch metadata and earned
      const decimals = pbjContract ? Number(await pbjContract.decimals()) : 18;
      for (let i = 0; i < staked.length; i++) {
        const tokenId = staked[i].toString();
        // Attempt to fetch metadata via tokenURI (the NFT contract still holds metadata)
        let tokenURI = null;
        try { tokenURI = await nftContractInstance.tokenURI(tokenId); } catch(e) { tokenURI = null; }
        const metadata = tokenURI ? (await fetchMetadataFromURI(tokenURI)) : null;
        const image = metadata && metadata.image ? (metadata.image.startsWith('ipfs://') ? ipfsToHttp(metadata.image) : metadata.image) : './nft-placeholder.png';
        const name = metadata && metadata.name ? metadata.name : `NFT #${tokenId}`;

        // Get pending rewards
        let earnedRaw = ethers.BigNumber.from(0);
        try {
          earnedRaw = await stakingContract.earned(tokenId);
        } catch (e) {
          console.warn('earned call failed for', tokenId, e);
          earnedRaw = ethers.BigNumber.from(0);
        }
        const earnedFormatted = ethers.utils.formatUnits(earnedRaw, decimals);

        const card = document.createElement("div");
        card.innerHTML = `
          <img src="${image}" alt="NFT ${tokenId}" />
          <div class="text-white font-semibold text-lg mb-2">${name}</div>
          <div style="font-size:12px; color:#9ae6b4;">Token ID: ${tokenId}</div>
          <div style="font-size:12px; color:#39ff14; margin-top:6px;">Pending: ${parseFloat(earnedFormatted).toFixed(4)} PBJ</div>
          <div style="display:flex; gap:6px; justify-content:center; margin-top:8px;">
            <button onclick="claimNFT(${tokenId})">Claim</button>
            <button onclick="unstakeNFT(${tokenId})">Unstake</button>
          </div>
        `;
        stakedContainer.appendChild(card);
      }
    }

  } catch (err) {
    console.error("Error al cargar NFTs:", err);
    document.getElementById('userNFTsAvailable').innerHTML = `<p class="text-red-500">Error al cargar tus NFTs.</p>`;
    document.getElementById('userNFTsStaked').innerHTML = `<p class="text-red-500">Error al cargar tus NFTs staked.</p>`;
  }
}

/* ---------------------------
   Staking actions
   --------------------------- */
async function stakeNFT(tokenId) {
  if (!provider || !signer || !userAddress) return alert("Conecta tu wallet primero.");
  try {
    // Ensure approval
    const nft = new ethers.Contract(nftAddress, nftMinimalAbi, signer);
    const approved = await nft.getApproved(tokenId);
    if (approved.toLowerCase() !== stakingAddress.toLowerCase()) {
      const txApp = await nft.approve(stakingAddress, tokenId);
      document.getElementById('status').innerText = 'Aprobando NFT...';
      await txApp.wait();
    }
    // Call stake
    const tx = await stakingContract.stake(tokenId);
    document.getElementById('status').innerText = 'Staking en progreso...';
    await tx.wait();
    document.getElementById('status').innerText = '‚úÖ NFT staked';
    await loadUserNFTs();
    await updatePBJBalance();
  } catch (e) {
    console.error('stakeNFT error', e);
    alert('Error al stakear NFT: ' + (e && e.message ? e.message : e));
  }
}

async function claimNFT(tokenId) {
  if (!provider || !signer || !userAddress) return alert("Conecta tu wallet primero.");
  try {
    const tx = await stakingContract.claim(tokenId);
    document.getElementById('status').innerText = 'Claim en progreso...';
    await tx.wait();
    document.getElementById('status').innerText = '‚úÖ Recompensa reclamada';
    await loadUserNFTs();
    await updatePBJBalance();
  } catch (e) {
    console.error('claimNFT error', e);
    alert('Error al reclamar reward: ' + (e && e.message ? e.message : e));
  }
}

async function unstakeNFT(tokenId) {
  if (!provider || !signer || !userAddress) return alert("Conecta tu wallet primero.");
  try {
    const tx = await stakingContract.unstake(tokenId);
    document.getElementById('status').innerText = 'Unstaking en progreso...';
    await tx.wait();
    document.getElementById('status').innerText = '‚úÖ NFT unstaked';
    await loadUserNFTs();
    await updatePBJBalance();
  } catch (e) {
    console.error('unstakeNFT error', e);
    alert('Error al unstakear: ' + (e && e.message ? e.message : e));
  }
}

/* ---------------------------
   PBJ balance
   --------------------------- */
async function updatePBJBalance() {
  if (!pbjContract || !userAddress) return;
  try {
    const raw = await pbjContract.balanceOf(userAddress);
    const dec = await pbjContract.decimals();
    const balance = ethers.utils.formatUnits(raw, dec);
    const formatted = parseFloat(balance).toFixed(2);
    document.getElementById('pbjBalanceHeader').innerText = formatted;
    document.getElementById('pbjBalanceGame').innerText = formatted;
  } catch (err) {
    console.error("Error al obtener PBJ balance:", err);
  }
}

/* ---------------------------
   Presale timer / UI (unchanged)
   --------------------------- */
const PRESALE_DURATION_MS = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as en ms
const presaleStartDate = new Date('2025-10-24T00:00:00Z');
const presaleEndDate = new Date(presaleStartDate.getTime() + PRESALE_DURATION_MS);

function updatePresaleTimer() {
  const now = new Date();
  const total = presaleEndDate - presaleStartDate;
  const left = Math.max(presaleEndDate - now, 0);
  const percent = 100 - Math.floor((left / total) * 100);

  document.getElementById('presale-progress').style.width = percent + '%';

  const d = Math.floor(left / (1000 * 60 * 60 * 24));
  const h = Math.floor((left / (1000 * 60 * 60)) % 24);
  const m = Math.floor((left / (1000 * 60)) % 60);
  const s = Math.floor((left / 1000) % 60);

  document.getElementById('presale-countdown').innerText =
    left > 0
      ? `Faltan ${d}d ${h}h ${m}m ${s}s`
      : '¬°Preventa finalizada!';

  if (left <= 0) {
    document.getElementById('buyButton').disabled = true;
    document.getElementById('status').innerText = 'Preventa finalizada';
  }
}

setInterval(updatePresaleTimer, 1000);
updatePresaleTimer();

function updateEthCollectedBar(ethCollected = 2, ethGoal = 20) {
  const percent = Math.min(100, Math.floor((ethCollected / ethGoal) * 100));
  document.getElementById('eth-collected-progress').style.width = percent + '%';
  document.getElementById('eth-collected-count').innerText = `${ethCollected} ETH recolectados de ${ethGoal}`;
}
updateEthCollectedBar(2, 20);

// Voting (unchanged)
const voteResults = {};
const emojis = ['üëç','üî•','ü§©','üíé','üòÇ'];

function loadVotes() {
  emojis.forEach(e => voteResults[e] = parseInt(localStorage.getItem('vote_' + e) || '0'));
  renderVotes();
}
function renderVotes() {
  document.getElementById('vote-results').innerHTML =
    emojis.map(e => `<span>${e} <b>${voteResults[e]}</b></span>`).join(' ');
}
document.querySelectorAll('.emoji-vote-btn').forEach(btn => {
  btn.onclick = () => {
    const emoji = btn.getAttribute('data-emoji');
    voteResults[emoji]++;
    localStorage.setItem('vote_' + emoji, voteResults[emoji]);
    renderVotes();
    btn.disabled = true;
    setTimeout(() => btn.disabled = false, 3000);
  }
});
loadVotes();

/* ---------------------------
   Blackjack logic (unchanged)
   --------------------------- */
const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'], vals = [2,3,4,5,6,7,8,9,10,'J','Q','K','A'];
let deck = [], dealerHand = [], playerHand = [];

function shuffle() {
  deck = [];
  suits.forEach(s => vals.forEach(v => deck.push({ s, v })));
  deck.sort(() => Math.random() - 0.5);
}

function dealCard(hand, area, index) {
  const card = deck.pop();
  hand.push(card);
  const isRed = card.s === '‚ô•' || card.s === '‚ô¶';
  const el = document.createElement('div');
  el.className = `card ${isRed ? 'red-suit' : 'black-suit'}`;
  el.innerHTML = `
    <div class="corner top-left">${card.v}${card.s}</div>
    <div class="corner bottom-right">${card.v}${card.s}</div>
    ${card.v}${card.s}
  `;
  area.appendChild(el);
  setTimeout(() => el.classList.add('deal'), index * 150);
}

function calc(hand) {
  let sum = 0, aces = 0;
  hand.forEach(c => {
    if (c.v === 'A') { aces++; sum += 11; }
    else if (['J','Q','K'].includes(c.v)) sum += 10;
    else sum += c.v;
  });
  while (sum > 21 && aces) { sum -= 10; aces--; }
  return sum;
}

function updateScores() {
  const p = calc(playerHand);
  const d = calc(dealerHand);
  document.getElementById('playerScore').innerText = p;
  document.getElementById('dealerScore').innerText = d;
  if (p > 21) {
    document.getElementById('resultMsg').innerText = 'Has perdido';
    disableGameButtons();
  }
}

function disableGameButtons() {
  document.getElementById('hitBtn').disabled = true;
  document.getElementById('standBtn').disabled = true;
}

function showDemoBlackjack() {
  shuffle();
  dealerHand = [];
  playerHand = [];
  const dArea = document.getElementById('dealerArea');
  const pArea = document.getElementById('playerArea');
  dArea.innerHTML = '';
  pArea.innerHTML = '';
  dealCard(dealerHand, dArea, 0);
  dealCard(playerHand, pArea, 1);
  dealCard(playerHand, pArea, 2);
  updateScores();
}
document.addEventListener('DOMContentLoaded', showDemoBlackjack);

/* ---------------------------
   UI bindings
   --------------------------- */
document.getElementById('connectButton').addEventListener('click', async () => {
  await connectWallet();
});
document.getElementById('refreshStaking').addEventListener('click', async () => {
  if (!provider || !userAddress) return alert('Conecta wallet');
  await loadUserNFTs();
});

/* Quick auto-refresh for staking/metadata while page open */
setInterval(async () => {
  try {
    if (provider && userAddress) await loadUserNFTs();
  } catch (e) { /* swallow */ }
}, 30_000);

/* ---------------------------
   Buy NFT logic (kept from original, minimal)
   --------------------------- */
window.buyNFT = async function(rarity) {
  if (!provider || !signer || !userAddress) {
    alert("Conecta tu wallet primero.");
    return;
  }
  try {
    const nftContract = new ethers.Contract(nftAddress, ["function mint(uint8) external"], signer);
    const pbjContractLocal = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);

    // Here we assume nftTypes(rarity).pricePBJ on-chain etc
    const nftAbiFull = [
      {
        "inputs": [
          {
            "internalType": "enum PepeBlackjackNFT.Rarity",
            "name": "_rarity",
            "type": "uint8"
          }
        ],
        "name": "mint",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      "function nftTypes(uint8) view returns (uint256 pricePBJ, uint256 totalSupply, uint256 minted)"
    ];
    const nftContractFull = new ethers.Contract(nftAddress, nftAbiFull, signer);
    const nftInfo = await nftContractFull.nftTypes(rarity);
    const price = nftInfo.pricePBJ;
    const allowance = await pbjContractLocal.allowance(userAddress, nftAddress);
    if (allowance.lt(price)) {
      const txApprove = await pbjContractLocal.approve(nftAddress, price);
      await txApprove.wait();
    }
    const txMint = await nftContractFull.mint(rarity);
    await txMint.wait();
    alert("‚úÖ NFT comprado con √©xito");
    await loadUserNFTs();
    await updatePBJBalance();
  } catch (err) {
    console.error("buyNFT error:", err);
    alert("Error al comprar NFT.");
  }
};

</script>
  </body>
</html>
