<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Pepe Blackjack (PBJ) - DApp</title>

    <!-- Ethers -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- Web3 (legacy, if needed) -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <!-- Tailwind (local) -->
    <script src="./cdn.tailwindcss.js"></script>
    <!-- tsParticles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <!-- WalletConnect v2 Ethereum Provider + Web3Modal Standalone (for QR modal) -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3modal/standalone@2/dist/index.umd.js"></script>

    <style>
      html,
      body,
      * {
        font-family: "Press Start 2P", cursive !important;
      }
      /* Remove arrows from number inputs */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      #tsparticles {
        position: fixed;
        z-index: -1;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
      .card {
        position: relative;
        width: 120px;
        height: 160px;
        background: white;
        border: 2px solid #222;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }
      .card.deal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .card .corner {
        position: absolute;
        font-size: 0.8rem;
      }
      .card .top-left {
        top: 4px;
        left: 6px;
      }
      .card .bottom-right {
        bottom: 4px;
        right: 6px;
        transform: rotate(180deg);
      }
      .red-suit {
        color: red;
      }
      .black-suit {
        color: black;
      }
      .form-presale.input {
        width: 70%;
      }
      .w-100 {
        width: 100%;
      }
      .top-45 {
        top: 10.5rem;
      }
      .bottom-45 {
        bottom: 10.5rem;
      }
      .image-pepe-preventa {
        height: 25rem;
        width: auto;
        margin-right: auto;
        margin-left: auto;
      }
      @media (max-width: 500px) {
        .cartas-blackjack {
          height: 25rem !important;
        }
      }
      /* NEW: Style for NFT card text */
      .nft-card h2,
      .nft-card p {
        color: #22c55e;
        font-size: 18px;
      }
      .nft-card p {
        font-size: 15px;
      }

      /* Tokenomics (nuevo estilo pizza) */
      .tokenomics-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-radius: 10px;
        color: #000;
        font-weight: 700;
        text-transform: uppercase;
        box-shadow: 3px 3px 0 #00000066;
        border: 3px solid #111;
      }
      .tokenomics-bar .label {
        letter-spacing: 0.5px;
      }
      .tokenomics-bar .pct {
        background: #000;
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
      }
      .bar-purple {
        background: #b69cff;
      }
      .bar-green {
        background: #39ff14;
      }
      .bar-blue {
        background: #76c7ff;
      }
      .bar-orange {
        background: #ffa726;
      }
      .bar-yellow {
        background: #fcd34d;
      }
      .pizza-box {
        position: relative;
      }
      .pizza-lid {
        background: #f0c27b;
        border: 4px solid #7a4e1b;
        border-bottom: 0;
        padding: 10px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        text-shadow: 1px 1px 0 #00000033;
      }
      .pizza-base {
        background: #e2b47a;
        border: 4px solid #7a4e1b;
        border-top: 0;
        padding: 18px;
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
        display: flex;
        justify-content: center;
      }
      .pizza-chart {
        width: 260px;
        height: 260px;
        max-width: 80vw;
        max-height: 80vw;
        border-radius: 50%;
        position: relative;
        box-shadow: inset 0 0 0 8px #7a4e1b, 2px 2px 0 #00000055;
      }
      .pizza-chart::after {
        content: "";
        position: absolute;
        inset: 20%;
        background: #d9a36a;
        border-radius: 50%;
        box-shadow: inset 0 0 0 4px #7a4e1b;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #111827;
        border: 1px solid #1f2937;
        padding: 8px 10px;
        border-radius: 8px;
      }
      .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        box-shadow: 1px 1px 0 #00000055;
      }

      /* NFT horizontal sections */
      .nft-section {
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 20px;
        max-width: 100%;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
      }
      .nft-card {
        flex: 0 0 240px;
        padding: 10px;
        border-radius: 8px;
        background: transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        scroll-snap-align: start;
      }
      .nft-card img {
        width: 100%;
        max-width: 250px;
        margin-bottom: 25px;
      }
      .pixel-button {
        background: #00ff00;
        border: 2px solid #003300;
        color: #000;
        font-family: "Press Start 2P", cursive;
        font-size: 10px;
        padding: 8px 12px;
        cursor: pointer;
        box-shadow: 2px 2px 0 #003300;
        transition: transform 0.1s;
      }
      .pixel-button:hover {
        transform: scale(1.05);
      }
      @media (max-width: 500px) {
        .nft-section {
          gap: 10px;
          padding: 8px;
        }
        .nft-card {
          flex: 0 0 170px;
          padding: 4px;
        }
        .nft-card img {
          max-width: 140px;
        }
      }

      /* Stake sections */
      #userNFTs,
      #stakedNFTs {
        scroll-snap-type: x mandatory;
      }
      #userNFTs > div,
      #stakedNFTs > div {
        scroll-snap-align: start;
        flex: 0 0 220px;
        background: #111;
        border: 2px solid #22c55e; /* green */
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        color: #a6f4a6;
        box-shadow: 0 0 8px #22c55e88;
      }
      #userNFTs img,
      #stakedNFTs img {
        width: 100%;
        height: auto;
        border-radius: 6px;
        image-rendering: pixelated;
      }
      #userNFTs button,
      #stakedNFTs button,
      .wallet-option-btn {
        margin-top: 10px;
        background-color: #00ff00;
        color: #000;
        font-family: "Press Start 2P", cursive;
        font-size: 10px;
        padding: 6px 10px;
        border: 2px solid #003300;
        cursor: pointer;
        box-shadow: 2px 2px 0 #003300;
        border-radius: 4px;
        transition: transform 0.1s;
      }
      #userNFTs button:hover,
      #stakedNFTs button:hover,
      .wallet-option-btn:hover {
        transform: scale(1.05);
      }

      /* Modal selecci√≥n de wallet inyectada */
      #walletSelectModal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      #walletSelectModal .modal-content {
        background: #111;
        border: 2px solid #22c55e;
        border-radius: 12px;
        padding: 18px;
        width: 90%;
        max-width: 420px;
      }
      #walletSelectModal h3 {
        color: #22c55e;
        margin-bottom: 12px;
        font-size: 16px;
      }
      .wallet-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .wallet-option-btn {
        width: 100%;
        text-align: center;
      }
      .close-modal-btn {
        background: #ff4444;
        border: 2px solid #660000;
        color: #fff;
      }
      .close-modal-btn:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body class="bg-gray-950 text-white min-h-screen">
    <div id="tsparticles"></div>
    <div class="max-w-4xl mx-auto p-4 space-y-8">
      <!-- Header -->
      <header
        class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700"
      >
        <h1 class="text-2xl sm:text-3xl font-bold text-green-400 mb-4 md:mb-0">
          Pepe Blackjack (PBJ)
        </h1>
        <button
          id="connectButton"
          class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-white w-full sm:w-auto text-center"
        >
          Connect Wallet
        </button>

        <div
          id="pbjDisplay"
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            color: #39ff14;
            background: transparent;
            padding: 10px 20px;
          "
        >
          <img
            src="./Coin.png"
            alt="PBJ Coin"
            width="48"
            height="48"
            style="image-rendering: pixelated; border-radius: 50%; border: none"
          />
          <span id="pbjBalanceHeader">0</span> PBJ
        </div>
      </header>
      <div id="status" class="text-center text-base sm:text-lg"></div>

      <!-- PRESALE BLOCK: IMAGE + BARS + VOTING -->
      <div class="flex flex-col md:flex-row items-center md:items-stretch gap-6 my-8">
        <!-- Presale image -->
        <div class="flex-shrink-0 flex justify-center items-center md:justify-start md:items-start">
          <img
            src="./preventa.png"
            alt="presale"
            class="image-pepe-preventa rounded-lg border-0 border-gray-700 shadow-inner max-h-80 md:max-h-none"
            style="height: 28rem; width: auto; margin: 0"
          />
        </div>

        <!-- Sections: time bar, ETH bar, voting -->
        <div class="flex flex-col gap-4 flex-1">
          <!-- Presale time bar -->
          <div
            id="presale-timer"
            class="w-full max-w-md mx-auto my-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center"
          >
            <div class="w-full mb-2">
              <div class="h-4 w-full bg-gray-700 rounded-full overflow-hidden">
                <div
                  id="presale-progress"
                  class="h-4 bg-green-500 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div
              class="text-green-400 font-semibold text-lg"
              id="presale-countdown"
            >
              Loading...
            </div>
            <div class="text-xs text-gray-400 mt-1">Presale time left (7 days)</div>
          </div>

          <!-- ETH collected bar -->
          <div
            id="eth-collected-bar"
            class="w-full max-w-md mx-auto my-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center"
          >
            <div class="w-full mb-2">
              <div class="h-4 w-full bg-gray-700 rounded-full overflow-hidden">
                <div
                  id="eth-collected-progress"
                  class="h-4 bg-blue-500 rounded-full transition-all duration-500"
                  style="width: 10%"
                ></div>
              </div>
            </div>
            <div
              class="text-blue-400 font-semibold text-lg"
              id="eth-collected-count"
            >
              2 ETH collected of 20
            </div>
            <div class="text-xs text-gray-400 mt-1">Presale goal: 20 ETH</div>
          </div>

          <!-- Presale voting with emojis -->
          <div
            id="presale-vote"
            class="w-full max-w-md mx-auto mb-0 p-4 bg-gray-900 rounded-xl shadow flex flex-col items-center"
          >
            <div class="font-semibold text-gray-200 mb-2">
              What do you think about the presale?
            </div>
            <div class="flex gap-4 mb-2">
              <button class="emoji-vote-btn text-2xl" data-emoji="üëç">üëç</button>
              <button class="emoji-vote-btn text-2xl" data-emoji="üî•">üî•</button>
              <button class="emoji-vote-btn text-2xl" data-emoji="ü§©">ü§©</button>
              <button class="emoji-vote-btn text-2xl" data-emoji="üíé">üíé</button>
              <button class="emoji-vote-btn text-2xl" data-emoji="üòÇ">üòÇ</button>
            </div>
            <div id="vote-results" class="flex gap-3 mt-2 text-lg"></div>
          </div>
        </div>
      </div>
      <!-- END PRESALE BLOCK -->

      <!-- NFT PRODUCTS -->
      <div class="nft-section">
        <div class="nft-card">
          <img src="nft1.png" alt="Common NFT" />
          <h2>üü¢ Common</h2>
          <p>5000 $PBJ - Reward: 200 $PBJ/day</p>
          <button class="pixel-button" onclick="buyNFT(0)">Buy NFT üü¢ Common</button>
        </div>

        <div class="nft-card">
          <img src="nft2.png" alt="Rare NFT" />
          <h2>üîµ Rare</h2>
          <p>10000 $PBJ - Reward: 500 $PBJ/day</p>
          <button class="pixel-button" onclick="buyNFT(1)">Buy NFT üîµ Rare</button>
        </div>

        <div class="nft-card">
          <img src="nft3.png" alt="Legendary NFT" />
          <h2>üü£ Legendary</h2>
          <p>25000 $PBJ - Reward: 1500 $PBJ/day</p>
          <button class="pixel-button" onclick="buyNFT(2)">Buy NFT üü£ Legendary</button>
        </div>
      </div>

      <!-- Your NFTs -->
      <section id="nftSection" style="text-align: center; margin-top: 40px">
        <h2 style="font-family: monospace; font-size: 24px; margin-bottom: 20px">
          Your PepeBlackjack NFTs
        </h2>
        <div
          id="userNFTs"
          style="
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
          "
        >
          <!-- NFTs will be dynamically inserted here -->
        </div>
      </section>

      <!-- Staking -->
      <section id="staking-section" class="bg-gray-900 p-6 rounded-xl shadow-xl mt-8">
        <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-6">
          ü™ô Stake your PepeBlackjack NFTs
        </h2>

        <div>
          <h3 class="text-green-400 font-semibold mb-2">
            Your NFTs available for staking
          </h3>
          <div id="userNFTsStake" class="flex gap-6 overflow-x-auto py-2">
            <!-- NFT cards with Stake button could be loaded here (optional) -->
          </div>
        </div>

        <div class="mt-8">
          <h3 class="text-green-400 font-semibold mb-2">Your staked NFTs</h3>
          <div id="stakedNFTs" class="flex gap-6 overflow-x-auto py-2">
            <!-- Staked NFT cards with Claim and Unstake buttons -->
          </div>
        </div>
      </section>

      <!-- BUY COMPONENT -->
      <section class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full sm:max-w-md mx-auto">
        <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-6">
          Token Purchase
        </h2>

        <!-- Balance -->
        <div class="flex justify-between text-xs sm:text-sm text-gray-400 mb-4">
          <span>ETH Balance</span>
          <span id="ethBalance" class="font-mono text-white">0.0000 ETH</span>
        </div>

        <!-- Inputs -->
        <div class="space-y-4 mb-6 form-presale">
          <!-- ETH ‚Üí PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="ethAmount"
              min="0.0001"
              step="0.0001"
              value="0.01"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0.0 ETH"
            />
            <span class="text-gray-300 font-medium text-sm">ETH</span>
          </div>

          <!-- Arrow SVG -->
          <div class="flex justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 text-gray-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </div>

          <!-- PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="pbjAmount"
              min="1"
              step="1"
              value="10000"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0 PBJ"
            />
            <span class="text-gray-300 font-medium text-sm">PBJ</span>
          </div>
        </div>

        <!-- Main button -->
        <button
          id="buyButton"
          disabled
          class="w-full py-2 sm:py-3 rounded-lg bg-gradient-to-r from-green-500 to-green-700 text-white font-semibold hover:from-green-600 hover:to-green-800 disabled:opacity-50 text-sm sm:text-base"
        >
          Buy
        </button>
      </section>

      <!-- Blackjack Game -->
      <section id="blackjackGame" class="bg-gray-900 p-4 sm:p-6 rounded-xl shadow-xl">
        <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-4">
          üÉè Blackjack Game
        </h2>
        <div
          class="mb-4 text-xs sm:text-sm flex flex-col sm:flex-row sm:items-center sm:space-x-8 space-y-2 sm:space-y-0"
        >
          <div class="flex items-center space-x-2">
            <div
              class="text-xs text-green-400"
              style="font-family: 'Press Start 2P', cursive"
            >
              Balance: <span id="pbjBalanceGame">0</span> PBJ
            </div>
            <label for="betAmount" class="text-sm ml-4">Bet:</label>
            <input
              type="number"
              id="betAmount"
              min="1"
              step="1"
              value="1000"
              class="w-20 px-2 py-1 rounded bg-gray-800 text-white text-sm"
            />
          </div>
        </div>

        <div class="relative h-64 sm:h-96 cartas-blackjack mb-4">
          <div
            id="dealerArea"
            class="absolute top-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"
          ></div>
          <div
            class="absolute top-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center"
          >
            Dealer Points: <span id="dealerScore">0</span>
          </div>

          <div
            id="playerArea"
            class="absolute bottom-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"
          ></div>
          <div
            class="absolute bottom-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center"
          >
            Player Points: <span id="playerScore">0</span>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
          <button id="dealBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded flex-1">
            Deal
          </button>
          <button id="hitBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>
            Hit
          </button>
          <button id="standBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>
            Stand
          </button>
        </div>

        <div id="resultMsg" class="mt-4 text-base sm:text-lg font-semibold text-center"></div>
      </section>

      <!-- Lore -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
        <!-- Image -->
        <div class="w-full md:w-1/3 mb-4 md:mb-0">
          <img
            src="./carta.png"
            alt="BasePepe Card"
            class="w-full h-auto rounded-lg border-0 border-gray-700 shadow-inner"
          />
        </div>

        <!-- Text -->
        <div class="w-full md:w-2/3 md:pl-6">
          <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Lore</h2>
          <p class="text-gray-300 leading-relaxed text-sm sm:text-base">
            Pepe Blackjack (PBJ) arises from the legendary frog table of the cyber-casino.
            This token mixes meme humor with the thrill of blackjack, offering a
            unique risk and reward experience on the Base Blockchain.
          </p>
        </div>
      </section>

      <!-- Roadmap -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
        <!-- Image -->
        <div class="w-full md:w-1/3 mb-4 md:mb-0">
          <img
            src="./logo.png"
            alt="logo"
            class="w-full h-auto rounded-lg border-2 border-gray-700 shadow-inner"
          />
        </div>

        <!-- Text -->
        <div class="w-full md:w-2/3 md:pl-6">
          <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Roadmap</h2>
          <ul class="text-gray-300 leading-relaxed text-sm sm:text-base">
            <li><strong>Q2 2025:</strong> PBJ presale on Base and official launch.</li>
            <li><strong>Q3 2025:</strong> Listed on DEX, staking features.</li>
            <li><strong>Q4 2025:</strong> Web3 Blackjack platform with NFT integration.</li>
            <li><strong>Q1 2026:</strong> Metaverse expansion and rewards for holders.</li>
          </ul>
        </div>
      </section>

      <!-- Tokenomics (Nuevo estilo pizza) -->
      <section
        id="tokenomics"
        class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-start gap-8"
      >
        <!-- Columna izquierda: t√≠tulo + barras -->
        <div class="w-full md:w-1/2">
          <h2 class="text-2xl font-bold text-green-400 mb-4">TOKENOMICS</h2>

          <div id="tokenomics-bars" class="space-y-3">
            <!-- Example bars -->
            <div class="tokenomics-bar bar-purple">
              <span class="label">Liquidity</span>
              <span class="pct">40%</span>
            </div>
            <div class="tokenomics-bar bar-green">
              <span class="label">Presale</span>
              <span class="pct">30%</span>
            </div>
            <div class="tokenomics-bar bar-blue">
              <span class="label">Staking</span>
              <span class="pct">15%</span>
            </div>
            <div class="tokenomics-bar bar-orange">
              <span class="label">Marketing</span>
              <span class="pct">10%</span>
            </div>
            <div class="tokenomics-bar bar-yellow">
              <span class="label">Team</span>
              <span class="pct">5%</span>
            </div>
          </div>

          <!-- Datos b√°sicos del token -->
          <div class="mt-6 bg-gray-800 rounded-lg p-4 text-xs sm:text-sm space-y-1">
            <div><span class="text-green-400">Symbol:</span> PBJ</div>
            <div><span class="text-green-400">Network:</span> Base</div>
            <div><span class="text-green-400">Total Supply:</span> 1,000,000,000 PBJ</div>
            <div><span class="text-green-400">Presale Price:</span> 1 ETH = 1,000,000 PBJ</div>
            <div>
              <span class="text-green-400">Contract:</span>
              <a
                href="https://basescan.org/address/0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5"
                class="text-blue-400 underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5
              </a>
            </div>
          </div>
        </div>

        <!-- Columna derecha: pizza + utilidades -->
        <div class="w-full md:w-1/2 flex flex-col items-center gap-4">
          <!-- Caja de pizza -->
          <div class="pizza-box w-full max-w-xs sm:max-w-sm">
            <div class="pizza-lid text-center">
              <div class="font-bold text-yellow-300 text-lg">$PBJ UTILITY</div>
            </div>

            <div class="pizza-base">
              <div class="pizza-chart" id="pizzaChart"></div>
            </div>
          </div>

          <!-- Leyenda -->
          <div id="tokenomics-legend" class="grid grid-cols-1 gap-2 w-full">
            <div class="legend-item">
              <div class="legend-dot" style="background:#B69CFF"></div>
              <div>Liquidity</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:#39FF14"></div>
              <div>Presale</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:#76C7FF"></div>
              <div>Staking</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:#FFA726"></div>
              <div>Marketing</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:#FCD34D"></div>
              <div>Team</div>
            </div>
          </div>

          <!-- Lista de utilidades -->
          <ul class="bg-gray-800 w-full rounded-lg p-4 space-y-2 text-sm">
            <li class="text-gray-200">‚Ä¢ Staking ‚Äì pool de recompensas PBJ con distribuci√≥n autom√°tica por smart contract.</li>
            <li class="text-gray-200">‚Ä¢ Blackjack ‚Äì premios del juego, rakeback para stakers y jackpots tem√°ticos.</li>
            <li class="text-gray-200">‚Ä¢ Activaciones de comunidad ‚Äì concursos, torneos y leaderboards semanales.</li>
            <li class="text-gray-200">‚Ä¢ Alianzas ‚Äì integraciones con plataformas y eventos gamificados.</li>
          </ul>
        </div>
      </section>

      <!-- Team and Links -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">üë• Team and Links</h2>
        <ul class="text-gray-300 space-y-2">
          <li><strong>Team:</strong> Vortex (Development), John Smith (Marketing), CryptoFrogDAO (Community)</li>
          <li>
            <strong>Official website:</strong>
            <a href="#" class="text-blue-400 underline">www.pepeblackjack.online</a>
          </li>
          <li>
            <strong>Twitter:</strong>
            <a href="https://twitter.com/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a>
          </li>
          <li>
            <strong>Telegram:</strong>
            <a href="https://t.me/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a>
          </li>
        </ul>
      </section>

      <!-- FAQ -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">‚ùì FAQ</h2>
        <div class="text-gray-300 space-y-4">
          <div>
            <h3 class="font-semibold">How do I buy PBJ?</h3>
            <p>Connect your wallet, enter the amount in ETH or PBJ and press "Buy".</p>
          </div>
          <div>
            <h3 class="font-semibold">What happens when the presale ends?</h3>
            <p>
              The <code>endPresale()</code> function disables purchases; you will only be able to
              trade on DEX afterwards.
            </p>
          </div>
        </div>
      </section>
    </div>

    <!-- Background particles -->
    <script>
      tsParticles.load("tsparticles", {
        background: { color: { value: "#000" } },
        fpsLimit: 60,
        interactivity: {
          events: { onHover: { enable: true, mode: "repulse" }, resize: true },
          modes: { repulse: { distance: 100, duration: 0.4 } },
        },
        particles: {
          color: { value: "#00ff99" },
          links: { enable: true, color: "#00ff99", distance: 150 },
          move: { enable: true, speed: 2 },
          number: { value: 60 },
          opacity: { value: 0.5 },
          shape: { type: "circle" },
          size: { value: { min: 1, max: 3 } },
        },
        detectRetina: true,
      });
    </script>

    <!-- DApp logic -->
    <script>
      // ----------------- VARIABLES GLOBALES -----------------
      let provider, signer, userAddress;
      let pbjContract, casinoContract, contract;
      const rate = 1000000; // 1 ETH = 1,000,000 PBJ

      // Direcciones (Base mainnet: 8453)
      const contractAddress = "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5"; // preventa
      const pbjContractAddress = "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5"; // token
      const pbjTokenAddress = "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5";
      const casinoAddress = "0x79e617b64eae98bda7f8Cd4b1EdC05dE696E4B74";
      const nftAddress = "0x4AabC024D719240e98e82930EAC04bD49CB86E31"; // contrato NFT

      // ABIs
      const pbjAbi = [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)",
      ];
      const nftAbi = [
        {
          inputs: [{ internalType: "enum PepeBlackjackNFT.Rarity", name: "_rarity", type: "uint8" }],
          name: "mint",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "pbjToken",
          outputs: [{ internalType: "contract IERC20", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [{ internalType: "enum PepeBlackjackNFT.Rarity", name: "", type: "uint8" }],
          name: "nftTypes",
          outputs: [
            { internalType: "uint256", name: "pricePBJ", type: "uint256" },
            { internalType: "uint256", name: "totalSupply", type: "uint256" },
            { internalType: "uint256", name: "minted", type: "uint256" },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];
      const casinoAbi = [
        "function placeBet(uint256 amount) external",
        "function finishGame(bool playerWon) external",
        "function cancelBet() external",
      ];
      const abi = ["function buyTokens() payable"];

      // ----------------- MULTI WALLET SUPPORT -----------------
      // WalletConnect Project ID (del usuario)
      const WALLETCONNECT_PROJECT_ID = "06606e3b978574fe1fe67024c91c5aa3";

      // Chain Base (8453)
      const baseChainData = {
        chainId: 8453,
        name: "Base",
        currency: "ETH",
        explorerUrl: "https://basescan.org",
        rpcUrl: "https://mainnet.base.org",
      };

      // Estado del provider actual
      let currentExternalProvider = null;

      // Modal helpers
      function showWalletModal() {
        buildInjectedOptions();
        document.getElementById("walletSelectModal").style.display = "flex";
      }
      function hideWalletModal() {
        document.getElementById("walletSelectModal").style.display = "none";
      }
      document.getElementById("closeWalletModal")?.addEventListener("click", hideWalletModal);

      // Construye lista de proveedores inyectados
      function buildInjectedOptions() {
        const container = document.getElementById("walletOptionsContainer");
        container.innerHTML = "";
        const eth = window.ethereum;
        let providers = [];

        // EIP-6963 (eth.providers) o fallback
        if (eth && Array.isArray(eth.providers)) {
          providers = eth.providers;
        } else if (eth) {
          providers = [eth];
        }

        providers.forEach((prov, idx) => {
          const name =
            prov.isMetaMask
              ? "MetaMask"
              : prov.isBraveWallet
              ? "Brave"
              : prov.isCoinbaseWallet
              ? "Coinbase"
              : prov.isOkxWallet
              ? "OKX"
              : prov.isRabby
              ? "Rabby"
              : prov.isTrust
              ? "Trust Wallet"
              : prov.isFrame
              ? "Frame"
              : prov.isXDEFI
              ? "XDEFI"
              : prov.isTally
              ? "Tally"
              : "Wallet " + (idx + 1);

          const btn = document.createElement("button");
          btn.className = "wallet-option-btn";
          btn.textContent = name;
          btn.onclick = async () => {
            currentExternalProvider = prov;
            hideWalletModal();
            await connectWithInjectedProvider(prov);
          };
          container.appendChild(btn);
        });

        if (providers.length === 0) {
          const fallback = document.createElement("div");
          fallback.style.fontSize = "12px";
          fallback.textContent = "No se detectaron billeteras inyectadas.";
          container.appendChild(fallback);
        }
      }

      async function connectWithInjectedProvider(injectedProv) {
        try {
          await injectedProv.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(injectedProv);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();

          await ensureBaseNetwork(injectedProv);

          pbjContract = new ethers.Contract(pbjContractAddress, pbjAbi, signer);
          casinoContract = new ethers.Contract(casinoAddress, casinoAbi, signer);
          contract = new ethers.Contract(contractAddress, abi, signer);

          const balance = await provider.getBalance(userAddress);
          document.getElementById("ethBalance").innerText = `${parseFloat(
            ethers.utils.formatEther(balance)
          ).toFixed(4)} ETH`;

          document.getElementById("status").innerText = "‚úÖ Wallet conectada";
          document.getElementById("buyButton").disabled = false;
          await updatePBJBalance();
          await loadUserNFTs();
        } catch (e) {
          console.error("Error al conectar billetera inyectada:", e);
          document.getElementById("status").innerText = "‚ùå Error al conectar billetera";
        }
      }

      // WalletConnect opci√≥n (QR modal)
      document.getElementById("walletconnectOption")?.addEventListener("click", async () => {
        try {
          const wcProvider = await window.EthereumProvider.init({
            projectId: WALLETCONNECT_PROJECT_ID,
            chains: [baseChainData.chainId],
            showQrModal: true,
            optionalChains: [],
            metadata: {
              name: "PepeBlackjack",
              description: "PBJ DApp",
              url: window.location.origin,
              icons: [
                "https://raw.githubusercontent.com/ethereum/ethereum-org-website/master/src/assets/images/og-image.png",
              ],
            },
          });
          currentExternalProvider = wcProvider;
          hideWalletModal();
          await connectWithInjectedProvider(wcProvider);
        } catch (err) {
          console.error("Error WalletConnect:", err);
          alert("No se pudo inicializar WalletConnect.");
        }
      });

      // Coinbase Wallet (si est√° inyectado)
      document.getElementById("coinbaseOption")?.addEventListener("click", async () => {
        const eth = window.ethereum;
        if (eth && eth.providers) {
          const coinbase = eth.providers.find((p) => p.isCoinbaseWallet);
          if (coinbase) {
            currentExternalProvider = coinbase;
            hideWalletModal();
            return connectWithInjectedProvider(coinbase);
          }
        } else if (eth && eth.isCoinbaseWallet) {
          currentExternalProvider = eth;
          hideWalletModal();
          return connectWithInjectedProvider(eth);
        }
        alert("Coinbase Wallet no est√° inyectado. Usa WalletConnect o instala la extensi√≥n.");
      });

      // Asegurar red Base
      async function ensureBaseNetwork(injectedProv) {
        try {
          const chainHex = "0x" + baseChainData.chainId.toString(16);
          const currentChain = await injectedProv.request({ method: "eth_chainId" });
          if (currentChain !== chainHex) {
            try {
              await injectedProv.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: chainHex }],
              });
            } catch (switchErr) {
              // Agregar cadena si no existe
              if (
                switchErr.code === 4902 ||
                (switchErr.data &&
                  switchErr.data.originalError &&
                  switchErr.data.originalError.code === 4902)
              ) {
                await injectedProv.request({
                  method: "wallet_addEthereumChain",
                  params: [
                    {
                      chainId: chainHex,
                      chainName: baseChainData.name,
                      nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                      rpcUrls: [baseChainData.rpcUrl],
                      blockExplorerUrls: [baseChainData.explorerUrl],
                    },
                  ],
                });
              } else {
                console.warn("No se pudo cambiar/agregar red Base:", switchErr);
              }
            }
          }
        } catch (err) {
          console.error("Error al verificar/cambiar red:", err);
        }
      }

      // Bot√≥n principal conectar
      document.getElementById("connectButton")?.addEventListener("click", () => {
        showWalletModal();
      });

      // ----------------- FUNCIONES DAPP -----------------
      async function loadUserNFTs() {
        const userNFTsContainer = document.getElementById("userNFTs");
        if (!userNFTsContainer) return;
        userNFTsContainer.innerHTML = "";

        if (!provider || !userAddress) return;

        const signerLocal = provider.getSigner();
        const pbjNftContract = new ethers.Contract(
          nftAddress,
          [
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string)",
          ],
          signerLocal
        );

        try {
          const balance = await pbjNftContract.balanceOf(userAddress);
          for (let i = 0; i < balance; i++) {
            const tokenId = await pbjNftContract.tokenOfOwnerByIndex(userAddress, i);
            // const tokenURI = await pbjNftContract.tokenURI(tokenId); // opcional para metadata

            const card = document.createElement("div");
            card.className =
              "bg-gray-800 rounded-lg p-4 w-52 text-center shadow-lg border border-green-500";
            card.innerHTML = `
              <div class="text-white font-semibold text-lg mb-2">NFT #${tokenId}</div>
              <button onclick="stakeNFT(${tokenId})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">Stake</button>
            `;
            userNFTsContainer.appendChild(card);
          }

          if (balance == 0) {
            userNFTsContainer.innerHTML = `<p class="text-gray-400">No tienes NFTs disponibles.</p>`;
          }
        } catch (err) {
          console.error("Error al cargar NFTs:", err);
          userNFTsContainer.innerHTML = `<p class="text-red-500">Error al cargar tus NFTs.</p>`;
        }
      }

      // Placeholder para staking
      window.stakeNFT = async function (tokenId) {
        alert("Stake coming soon. TokenId: " + tokenId);
      };

      // Comprar NFT por rareza
      window.buyNFT = async function (rarity) {
        if (!provider || !signer) {
          return alert("Conecta una billetera primero.");
        }

        try {
          const nftContract = new ethers.Contract(nftAddress, nftAbi, signer);
          const pbjToken = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);
          const nftInfo = await nftContract.nftTypes(rarity);
          const price = nftInfo.pricePBJ;

          const allowance = await pbjToken.allowance(userAddress, nftAddress);
          if (allowance.lt(price)) {
            const txApprove = await pbjToken.approve(nftAddress, price);
            await txApprove.wait();
          }
          const txMint = await nftContract.mint(rarity);
          await txMint.wait();
          alert("‚úÖ NFT comprado con √©xito");
          loadUserNFTs();
        } catch (err) {
          console.error("Error comprando NFT:", err);
          alert("No se pudo comprar el NFT.");
        }
      };

      async function updatePBJBalance() {
        if (!pbjContract || !userAddress) return;
        try {
          const raw = await pbjContract.balanceOf(userAddress);
          const dec = await pbjContract.decimals();
          const balance = ethers.utils.formatUnits(raw, dec);
          const formatted = parseFloat(balance).toFixed(2);
          document.getElementById("pbjBalanceHeader").innerText = formatted;
          const gameBalEl = document.getElementById("pbjBalanceGame");
          if (gameBalEl) gameBalEl.innerText = formatted;
        } catch (err) {
          console.error("Error PBJ balance:", err);
        }
      }

      // Sincronizar inputs de compra
      const ethAmountEl = document.getElementById("ethAmount");
      const pbjAmountEl = document.getElementById("pbjAmount");
      ethAmountEl?.addEventListener("input", () => {
        const v = parseFloat(ethAmountEl.value || "0");
        pbjAmountEl.value = isNaN(v) ? "0" : Math.floor(v * rate).toString();
      });
      pbjAmountEl?.addEventListener("input", () => {
        const v = parseFloat(pbjAmountEl.value || "0");
        ethAmountEl.value = isNaN(v) ? "0" : (v / rate).toFixed(6);
      });

      // ----------------- PREVENTA TIMER -----------------
      const PRESALE_DURATION_MS = 7 * 24 * 60 * 60 * 1000;
      const presaleStartDate = new Date("2025-11-07T00:00:00Z");
      const presaleEndDate = new Date(presaleStartDate.getTime() + PRESALE_DURATION_MS);

      function updatePresaleTimer() {
        const now = new Date();
        const total = presaleEndDate - presaleStartDate;
        const left = Math.max(presaleEndDate - now, 0);
        const percent = 100 - Math.floor((left / total) * 100);

        const bar = document.getElementById("presale-progress");
        const countdownEl = document.getElementById("presale-countdown");
        if (bar) bar.style.width = percent + "%";

        const d = Math.floor(left / (1000 * 60 * 60 * 24));
        const h = Math.floor((left / (1000 * 60 * 60)) % 24);
        const m = Math.floor((left / (1000 * 60)) % 60);
        const s = Math.floor((left / 1000) % 60);

        if (countdownEl) {
          countdownEl.innerText =
            left > 0 ? `Faltan ${d}d ${h}h ${m}m ${s}s` : "¬°Preventa finalizada!";
        }
        if (left <= 0) {
          const buyBtn = document.getElementById("buyButton");
          if (buyBtn) buyBtn.disabled = true;
          const statusEl = document.getElementById("status");
          if (statusEl) statusEl.innerText = "Preventa finalizada";
        }
      }
      setInterval(updatePresaleTimer, 1000);
      updatePresaleTimer();

      function updateEthCollectedBar(ethCollected = 2, ethGoal = 20) {
        const percent = Math.min(100, Math.floor((ethCollected / ethGoal) * 100));
        const pEl = document.getElementById("eth-collected-progress");
        const cEl = document.getElementById("eth-collected-count");
        if (pEl) pEl.style.width = percent + "%";
        if (cEl) cEl.innerText = `${ethCollected} ETH recolectados de ${ethGoal}`;
      }
      updateEthCollectedBar(2, 20);

      // ----------------- Votaci√≥n con emojis -----------------
      const voteResults = {};
      const emojis = ["üëç", "üî•", "ü§©", "üíé", "üòÇ"];

      function loadVotes() {
        emojis.forEach((e) => (voteResults[e] = parseInt(localStorage.getItem("vote_" + e) || "0")));
        renderVotes();
      }
      function renderVotes() {
        const vr = document.getElementById("vote-results");
        if (vr) vr.innerHTML = emojis.map((e) => `<span>${e} <b>${voteResults[e]}</b></span>`).join(" ");
      }
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".emoji-vote-btn").forEach((btn) => {
          btn.onclick = () => {
            const emoji = btn.getAttribute("data-emoji");
            voteResults[emoji]++;
            localStorage.setItem("vote_" + emoji, voteResults[emoji]);
            renderVotes();
            btn.disabled = true;
            setTimeout(() => (btn.disabled = false), 3000);
          };
        });
        loadVotes();
      });

      // ----------------- Blackjack -----------------
      const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"],
        vals = [2, 3, 4, 5, 6, 7, 8, 9, 10, "J", "Q", "K", "A"];
      let deck = [],
        dealerHand = [],
        playerHand = [];

      function shuffle() {
        deck = [];
        suits.forEach((s) => vals.forEach((v) => deck.push({ s, v })));
        deck.sort(() => Math.random() - 0.5);
      }

      function dealCard(hand, area, index) {
        const card = deck.pop();
        hand.push(card);
        const isRed = card.s === "‚ô•" || card.s === "‚ô¶";
        const el = document.createElement("div");
        el.className = `card ${isRed ? "red-suit" : "black-suit"}`;
        el.innerHTML = `
          <div class="corner top-left">${card.v}${card.s}</div>
          <div class="corner bottom-right">${card.v}${card.s}</div>
          ${card.v}${card.s}
        `;
        area.appendChild(el);
        setTimeout(() => el.classList.add("deal"), index * 150);
      }

      function calc(hand) {
        let sum = 0,
          aces = 0;
        hand.forEach((c) => {
          if (c.v === "A") {
            aces++;
            sum += 11;
          } else if (["J", "Q", "K"].includes(c.v)) sum += 10;
          else sum += c.v;
        });
        while (sum > 21 && aces) {
          sum -= 10;
          aces--;
        }
        return sum;
      }

      function updateScores() {
        const p = calc(playerHand);
        const d = calc(dealerHand);
        const pEl = document.getElementById("playerScore");
        const dEl = document.getElementById("dealerScore");
        if (pEl) pEl.innerText = p;
        if (dEl) dEl.innerText = d;
        if (p > 21) {
          const res = document.getElementById("resultMsg");
          if (res) res.innerText = "Has perdido";
          disableGameButtons();
        }
      }

      function disableGameButtons() {
        const hit = document.getElementById("hitBtn");
        const stand = document.getElementById("standBtn");
        if (hit) hit.disabled = true;
        if (stand) stand.disabled = true;
      }

      function showDemoBlackjack() {
        shuffle();
        dealerHand = [];
        playerHand = [];
        const dArea = document.getElementById("dealerArea");
        const pArea = document.getElementById("playerArea");
        if (!dArea || !pArea) return;
        dArea.innerHTML = "";
        pArea.innerHTML = "";
        dealCard(dealerHand, dArea, 0);
        dealCard(playerHand, pArea, 1);
        dealCard(playerHand, pArea, 2);
        updateScores();
      }
      document.addEventListener("DOMContentLoaded", showDemoBlackjack);

      document.getElementById("dealBtn")?.addEventListener("click", async () => {
        if (!pbjContract || !signer) return alert("Conecta una billetera primero.");
        const bet = parseInt(document.getElementById("betAmount").value) || 0;

        try {
          const decimals = await pbjContract.decimals();
          const betUnits = ethers.utils.parseUnits(bet.toString(), decimals);
          const rawBalance = await pbjContract.balanceOf(userAddress);
          const balance = parseFloat(ethers.utils.formatUnits(rawBalance, decimals));
          if (bet > balance) return alert("Saldo insuficiente");

          await pbjContract.connect(signer).approve(casinoAddress, betUnits);
          await casinoContract.placeBet(betUnits);

          shuffle();
          dealerHand = [];
          playerHand = [];
          const dArea = document.getElementById("dealerArea");
          const pArea = document.getElementById("playerArea");
          dArea.innerHTML = "";
          pArea.innerHTML = "";
          dealCard(dealerHand, dArea, 0);
          dealCard(playerHand, pArea, 1);
          dealCard(playerHand, pArea, 2);
          setTimeout(updateScores, 500);

          document.getElementById("hitBtn").disabled = false;
          document.getElementById("standBtn").disabled = false;
          document.getElementById("resultMsg").innerText = "";
        } catch (err) {
          console.error("Error al colocar la apuesta:", err);
          alert("No se pudo colocar la apuesta.");
        }
      });

      document.getElementById("hitBtn")?.addEventListener("click", () => {
        dealCard(playerHand, document.getElementById("playerArea"), playerHand.length);
        setTimeout(() => {
          updateScores();
          if (calc(playerHand) > 21) disableGameButtons();
        }, 500);
      });

      document.getElementById("standBtn")?.addEventListener("click", async () => {
        // Dealer hits to 17
        while (calc(dealerHand) < 17) {
          dealCard(dealerHand, document.getElementById("dealerArea"), dealerHand.length);
        }
        const p = calc(playerHand);
        const d = calc(dealerHand);
        let msg = "";
        if (d > 21 || p > d) {
          msg = "¬°Has ganado!";
          try {
            await casinoContract.finishGame(true);
          } catch (e) {
            console.warn("finishGame(true) fallo", e);
          }
        } else if (p === d) {
          msg = "Empate";
          try {
            await casinoContract.cancelBet();
          } catch (e) {
            console.warn("cancelBet fallo", e);
          }
        } else {
          msg = "Has perdido";
          try {
            await casinoContract.finishGame(false);
          } catch (e) {
            console.warn("finishGame(false) fallo", e);
          }
        }
        document.getElementById("resultMsg").innerText = msg;
        disableGameButtons();
        updatePBJBalance();
      });

      // ----------------- COMPRA DE TOKENS -----------------
      document.getElementById("buyButton")?.addEventListener("click", async () => {
        if (!provider || !signer) return alert("Conecta una billetera primero.");

        const ethAmountInput = document.getElementById("ethAmount");
        if (!ethAmountInput) return;
        const ethAmount = parseFloat(ethAmountInput.value);
        if (ethAmount <= 0 || isNaN(ethAmount)) return alert("Cantidad inv√°lida");

        try {
          // Enviar ETH a contrato de preventa (si el contrato requiere buyTokens(), c√°mbialo por contract.buyTokens({ value }))
          const tx = await signer.sendTransaction({
            to: contractAddress,
            value: ethers.utils.parseEther(ethAmount.toString()),
          });
          document.getElementById("status").innerText = "‚è≥ Procesando compra...";
          await tx.wait();
          document.getElementById("status").innerText = "‚úÖ Compra completada";
          updatePBJBalance();
        } catch (err) {
          console.error("Error compra:", err);
          document.getElementById("status").innerText = "‚ùå Error en la compra";
        }
      });

      // ----------------- RECONECTAR CAMBIOS DE CUENTA/RED -----------------
      function attachProviderEvents(prov) {
        try {
          prov.on?.("accountsChanged", async () => {
            if (currentExternalProvider) await connectWithInjectedProvider(currentExternalProvider);
          });
          prov.on?.("chainChanged", async () => {
            if (currentExternalProvider) await connectWithInjectedProvider(currentExternalProvider);
          });
          prov.on?.("disconnect", () => {
            document.getElementById("status").innerText = "üîå Desconectado";
            document.getElementById("buyButton").disabled = true;
          });
        } catch (e) {
          // ignore
        }
      }

      if (window.ethereum) {
        attachProviderEvents(window.ethereum);
        if (Array.isArray(window.ethereum.providers)) {
          window.ethereum.providers.forEach(attachProviderEvents);
        }
      }

      // ----------------- MODAL HTML -----------------
    </script>

    <!-- Modal selecci√≥n de wallet inyectada -->
    <div id="walletSelectModal">
      <div class="modal-content">
        <h3>Selecciona tu billetera</h3>
        <div class="wallet-list" id="walletOptionsContainer"></div>
        <button class="wallet-option-btn" id="walletconnectOption">WalletConnect</button>
        <button class="wallet-option-btn" id="coinbaseOption">Coinbase Wallet</button>
        <button class="close-modal-btn wallet-option-btn" id="closeWalletModal">Cancelar</button>
      </div>
    </div>
  </body>
</html>
