<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>PBJ - Premium Crypto Casino</title>
  <meta name="description" content="The #1 DeFi Casino on Base." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet" />
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- External Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Inter"', 'sans-serif'],
            mono: ['"Rajdhani"', 'monospace'], // Usado para n√∫meros y dinero
          },
          colors: {
            // Paleta estilo Stake/Roobet
            bg: '#0F212E',       // Fondo principal muy oscuro
            sidebar: '#1A2C38',  // Paneles y sidebar
            surface: '#213743',  // Tarjetas y inputs
            hover: '#2C4454',    // Estado hover
            primary: '#00E701',  // Verde brillante (Acci√≥n/Dinero)
            accent: '#1475E1',   // Azul corporativo
            danger: '#FF4949',
          },
          boxShadow: {
            'glow': '0 0 15px rgba(0, 231, 1, 0.3)',
            'card': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)',
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #0F212E; color: #b1bad3; overflow-x: hidden; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0F212E; }
    ::-webkit-scrollbar-thumb { background: #2C4454; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #455d6e; }

    /* Inputs */
    .casino-input {
      background: #0F212E; border: 2px solid #2C4454; color: white;
      font-family: 'Rajdhani'; font-weight: 700; transition: all 0.2s;
    }
    .casino-input:focus { border-color: #1475E1; outline: none; box-shadow: 0 0 0 3px rgba(20, 117, 225, 0.2); }

    /* Buttons */
    .btn-primary {
      background: #00E701; color: #0b1820; font-weight: 700;
      transition: all 0.2s; border-radius: 0.25rem;
    }
    .btn-primary:hover:not(:disabled) { background: #1aff1b; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,231,1,0.4); }
    .btn-primary:disabled { background: #2C4454; color: #55657e; cursor: not-allowed; }

    .btn-secondary {
      background: #213743; color: white; font-weight: 600;
      border: 1px solid transparent; transition: 0.2s;
    }
    .btn-secondary:hover { background: #2C4454; border-color: #455d6e; }

    /* Game Modal & Cards */
    .card-zoom { overflow: hidden; position: relative; border-radius: 0.75rem; }
    .card-zoom img { transition: transform 0.3s ease; width: 100%; height: 100%; object-fit: cover; }
    .card-zoom:hover img { transform: scale(1.05); }
    
    /* Mines & Animations */
    .mine-tile {
        aspect-ratio: 1; background: #213743; border-radius: 8px; border-bottom: 4px solid #0F212E;
        cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;
        transition: all 0.1s;
    }
    .mine-tile:active { transform: translateY(2px); border-bottom-width: 0; }
    .mine-tile.selected { background: #2C4454; border-color: #00E701; box-shadow: inset 0 0 0 2px #00E701; }
    .mine-tile.revealed-safe { background: #00E701; color: #0b1820; border-bottom-width: 0; transform: translateY(2px); }
    .mine-tile.revealed-bomb { background: #FF4949; color: white; border-bottom-width: 0; transform: translateY(2px); }

    /* Blackjack Cards */
    .playing-card {
        background: white; border-radius: 6px; width: 55px; height: 80px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 1px 1px 5px rgba(0,0,0,0.5); font-family: 'Inter', sans-serif; font-weight: 800;
        position: relative; animation: dealCard 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .card-red { color: #e91e63; } .card-black { color: #2d3436; }
    @keyframes dealCard { from { opacity: 0; transform: translateY(-20px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* Animations */
    .shimmer {
      position: relative; overflow: hidden;
    }
    .shimmer::after {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      transform: translateX(-100%); animation: shimmer 2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    /* Toast */
    .toast-anim { animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body class="flex h-screen text-sm antialiased font-sans selection:bg-primary selection:text-black">

  <!-- TOAST CONTAINER -->
  <div id="toast-container" class="fixed bottom-5 right-5 z-[10000] flex flex-col gap-2"></div>

  <!-- GAME MODAL (Centered Overlay) -->
  <div id="gameModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9990] hidden items-center justify-center p-4">
    <div class="bg-sidebar w-full max-w-2xl rounded-xl shadow-2xl border border-gray-700 overflow-hidden flex flex-col max-h-[90vh]">
        
        <!-- Modal Header -->
        <div class="bg-surface p-4 flex justify-between items-center border-b border-gray-700">
            <div class="flex items-center gap-3">
                <span id="modalIcon" class="text-2xl">üé∞</span>
                <div>
                    <h2 id="modalTitle" class="text-white font-bold text-lg uppercase tracking-wide">GAME</h2>
                    <div class="flex items-center gap-1 text-xs text-green-400">
                        <i class="fas fa-shield-alt"></i> <span>Provably Fair</span>
                    </div>
                </div>
            </div>
            <button onclick="closeGame()" class="text-gray-400 hover:text-white transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Game Area (Canvas/Interactive) -->
        <div class="flex-1 bg-[#0b1820] relative p-6 flex items-center justify-center overflow-y-auto">
            <div id="innerGameContent" class="w-full flex flex-col items-center justify-center min-h-[250px]">
                <!-- DYNAMIC CONTENT -->
            </div>
            <p id="gameStatus" class="absolute bottom-2 w-full text-center text-xs font-mono font-bold text-gray-500 uppercase tracking-widest">READY TO PLAY</p>
        </div>

        <!-- Betting Controls -->
        <div class="bg-sidebar p-4 border-t border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Bet Input -->
                <div class="bg-[#0F212E] p-1.5 rounded-lg border border-gray-700 focus-within:border-accent transition">
                    <div class="flex justify-between px-2 pt-1 text-[10px] text-gray-400 uppercase font-bold">
                        <span>Bet Amount</span>
                        <span>Bal: <span id="modalBalance" class="text-white">0</span></span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-primary pl-2"><i class="fas fa-coins"></i></span>
                        <input type="number" id="gameBetInput" value="1000" class="bg-transparent w-full text-white font-mono font-bold focus:outline-none" placeholder="0.00">
                        <button class="text-[10px] bg-surface hover:bg-gray-600 px-2 py-1 rounded text-gray-300 font-bold">¬Ω</button>
                        <button class="text-[10px] bg-surface hover:bg-gray-600 px-2 py-1 rounded text-gray-300 font-bold">2√ó</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 h-full">
                    <button id="gameActionBtn" class="btn-primary w-full h-full text-base shadow-glow">PLAY ROUND</button>
                    <div id="gameExtraControls" class="hidden flex-1 gap-2 w-full"></div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- SIDEBAR (Desktop) -->
  <aside class="hidden md:flex w-64 flex-col bg-sidebar border-r border-gray-800 flex-shrink-0 z-20">
    <!-- Logo -->
    <div class="h-16 flex items-center px-6 border-b border-gray-800">
      <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center mr-3 text-black font-bold text-lg">P</div>
      <span class="text-white font-bold text-xl tracking-tight">PBJ<span class="text-primary">.CASINO</span></span>
    </div>

    <!-- Nav Links -->
    <div class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
      <div class="px-3 mb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Platform</div>
      
      <a href="#games" class="flex items-center px-3 py-2.5 bg-surface text-white rounded-lg transition group">
        <i class="fas fa-gamepad w-6 text-primary group-hover:scale-110 transition"></i>
        <span class="font-medium">Casino Lobby</span>
      </a>
      <a href="#presale" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-[#2C4454] rounded-lg transition">
        <i class="fas fa-rocket w-6"></i>
        <span class="font-medium">Presale</span>
        <span class="ml-auto bg-primary text-black text-[9px] font-bold px-1.5 py-0.5 rounded">LIVE</span>
      </a>
      <a href="#staking" class="flex items-center px-3 py-2.5 text-gray-400 hover:text-white hover:bg-[#2C4454] rounded-lg transition">
        <i class="fas fa-layer-group w-6"></i>
        <span class="font-medium">NFT Staking</span>
      </a>

      <div class="mt-8 px-3 mb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Socials</div>
      <a href="#" class="flex items-center px-3 py-2 text-gray-400 hover:text-white transition">
        <i class="fab fa-twitter w-6"></i> Twitter
      </a>
      <a href="#" class="flex items-center px-3 py-2 text-gray-400 hover:text-white transition">
        <i class="fab fa-discord w-6"></i> Discord
      </a>
    </div>

    <!-- Bottom Status -->
    <div class="p-4 border-t border-gray-800 text-xs text-center text-gray-500">
        <div class="flex items-center justify-center gap-2 mb-1">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span>System Operational</span>
        </div>
        &copy; 2025 PBJ Protocol
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
    
    <!-- TOP NAVBAR -->
    <header class="h-16 bg-sidebar/90 backdrop-blur border-b border-gray-800 flex items-center justify-between px-4 sticky top-0 z-10">
      <div class="md:hidden flex items-center gap-3">
          <div class="w-8 h-8 bg-primary rounded flex items-center justify-center font-bold text-black">P</div>
          <span class="font-bold text-white">PBJ</span>
      </div>

      <!-- Search / Global Info -->
      <div class="hidden md:flex items-center bg-[#0F212E] rounded-full px-4 py-1.5 border border-gray-700 text-gray-400 text-xs w-64">
          <i class="fas fa-search mr-2"></i>
          <span>Search games...</span>
      </div>

      <!-- Wallet Actions -->
      <div class="flex items-center gap-3">
         <div id="walletDisplay" class="hidden flex-col items-end mr-1">
            <div class="bg-[#0F212E] px-3 py-1 rounded border border-gray-700 flex items-center gap-2">
                <span id="headerBalance" class="text-white font-mono font-bold text-sm">0</span>
                <span class="text-primary text-xs font-bold">PBJ</span>
            </div>
        </div>
        <button id="connectBtn" class="btn-primary px-4 py-2 text-xs md:text-sm shadow-[0_0_10px_rgba(0,231,1,0.2)]">
            <i class="fas fa-wallet mr-1"></i> CONNECT
        </button>
      </div>
    </header>

    <!-- SCROLLABLE AREA -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 space-y-10 pb-20">
      
      <!-- HERO / PRESALE BANNER -->
      <section id="presale" class="relative rounded-2xl overflow-hidden bg-gradient-to-r from-blue-900 to-indigo-900 shadow-2xl border border-white/5">
        <!-- Background Decor -->
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
        <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-[#00E701]/20 to-transparent blur-3xl"></div>

        <div class="relative z-10 grid md:grid-cols-2 gap-8 p-6 md:p-10 items-center">
            <div class="space-y-4">
                <div class="inline-block bg-white/10 backdrop-blur border border-white/20 rounded-full px-3 py-1 text-xs font-bold text-white mb-2">
                    üî• PRESALE PHASE 1
                </div>
                <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight">
                    The Next Gen <br><span class="text-primary">DeFi Casino</span>
                </h1>
                <p class="text-blue-200 text-sm md:text-base max-w-md">
                    Play fully on-chain. Stake NFTs for passive yield. Join the presale before the public launch.
                </p>
                
                <div class="flex items-center gap-4 pt-2">
                    <div class="bg-black/30 p-2 rounded text-center min-w-[60px]">
                        <div class="text-lg font-mono font-bold text-white">1.5M</div>
                        <div class="text-[10px] text-gray-400">PBJ / ETH</div>
                    </div>
                </div>
            </div>

            <!-- Swap Card -->
            <div class="bg-sidebar p-1 rounded-xl shadow-2xl max-w-sm mx-auto w-full border border-gray-700">
                <div class="bg-[#0F212E] p-5 rounded-lg space-y-4">
                    <div class="flex justify-between text-xs text-gray-400 font-bold mb-1">
                        <span>YOU PAY</span>
                        <span>Balance: --</span>
                    </div>
                    <div class="relative">
                        <input type="number" id="buyInput" class="casino-input w-full p-3 pr-16 rounded-lg text-lg" placeholder="0.0">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Ethereum_logo_2014.svg" class="w-5 h-5">
                            <span class="font-bold text-white text-sm">ETH</span>
                        </div>
                    </div>

                    <div class="flex justify-center -my-2 relative z-10">
                         <div class="bg-sidebar p-1 rounded-full border border-gray-700">
                             <i class="fas fa-arrow-down text-gray-400 text-xs"></i>
                         </div>
                    </div>

                    <div class="flex justify-between text-xs text-gray-400 font-bold mb-1">
                        <span>YOU RECEIVE</span>
                    </div>
                    <div class="relative">
                        <input type="number" id="receiveInput" readonly class="bg-sidebar border border-transparent w-full p-3 pr-16 rounded-lg text-lg text-primary font-mono font-bold" placeholder="0">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                            <div class="w-5 h-5 bg-primary rounded-full flex items-center justify-center text-[8px] text-black font-bold">P</div>
                            <span class="font-bold text-white text-sm">PBJ</span>
                        </div>
                    </div>

                    <button id="buyBtn" class="w-full btn-primary py-3.5 mt-2 shadow-lg">
                        BUY TOKENS NOW
                    </button>
                    <p id="presaleStatus" class="text-center text-xs text-gray-500 min-h-[16px]"></p>
                </div>
            </div>
        </div>
      </section>

      <!-- GAMES GRID -->
      <section id="games">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fas fa-dice text-primary"></i> Popular Games
            </h2>
            <div class="flex gap-2">
                <button class="w-8 h-8 rounded bg-surface text-gray-400 hover:text-white flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                <button class="w-8 h-8 rounded bg-surface text-gray-400 hover:text-white flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <!-- Blackjack -->
            <div onclick="openGame('blackjack')" class="group relative cursor-pointer bg-surface rounded-xl p-1 hover:-translate-y-1 transition duration-300 shadow-card">
                <div class="aspect-[3/4] rounded-lg overflow-hidden relative">
                    <img src="https://images.unsplash.com/photo-1605870445919-838d190e8e1b?auto=format&fit=crop&q=80&w=400" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex flex-col justify-end p-4">
                        <h3 class="text-white font-bold text-lg">Blackjack</h3>
                        <p class="text-xs text-gray-400">RTP 99.5%</p>
                    </div>
                    <!-- Play Overlay -->
                    <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center backdrop-blur-[2px]">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-black text-xl shadow-glow">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mines -->
            <div onclick="openGame('mines')" class="group relative cursor-pointer bg-surface rounded-xl p-1 hover:-translate-y-1 transition duration-300 shadow-card">
                <div class="aspect-[3/4] rounded-lg overflow-hidden relative">
                    <img src="https://images.unsplash.com/photo-1614332287897-cdc485fa562d?auto=format&fit=crop&q=80&w=400" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex flex-col justify-end p-4">
                        <h3 class="text-white font-bold text-lg">Mines</h3>
                        <p class="text-xs text-gray-400">Strategy</p>
                    </div>
                     <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center backdrop-blur-[2px]">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-black text-xl shadow-glow">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slots -->
            <div onclick="openGame('slots')" class="group relative cursor-pointer bg-surface rounded-xl p-1 hover:-translate-y-1 transition duration-300 shadow-card">
                <div class="aspect-[3/4] rounded-lg overflow-hidden relative">
                    <img src="https://images.unsplash.com/photo-1596838132731-3301c3fd4317?auto=format&fit=crop&q=80&w=400" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex flex-col justify-end p-4">
                        <h3 class="text-white font-bold text-lg">Slots</h3>
                        <p class="text-xs text-gray-400">High Volatility</p>
                    </div>
                     <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center backdrop-blur-[2px]">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-black text-xl shadow-glow">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crash -->
            <div onclick="openGame('crash')" class="group relative cursor-pointer bg-surface rounded-xl p-1 hover:-translate-y-1 transition duration-300 shadow-card">
                <div class="aspect-[3/4] rounded-lg overflow-hidden relative">
                    <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&q=80&w=400" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex flex-col justify-end p-4">
                        <h3 class="text-white font-bold text-lg">Crash</h3>
                        <p class="text-xs text-gray-400">Instant Win</p>
                    </div>
                     <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center backdrop-blur-[2px]">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-black text-xl shadow-glow">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>

      <!-- STAKING / VAULT -->
      <section id="staking" class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2 bg-sidebar border border-gray-800 rounded-xl p-6">
              <div class="flex justify-between items-center mb-6">
                  <div>
                      <h2 class="text-xl font-bold text-white">Inventory & Staking</h2>
                      <p class="text-xs text-gray-400">Lock your NFTs to earn PBJ yield.</p>
                  </div>
                  <button onclick="loadUserData()" class="text-xs bg-surface hover:bg-gray-700 px-3 py-1 rounded text-white"><i class="fas fa-sync mr-1"></i> Refresh</button>
              </div>

              <div id="inventory-list" class="bg-[#0F212E] rounded-lg border border-dashed border-gray-700 h-48 flex flex-col items-center justify-center text-gray-500 gap-3">
                  <i class="fas fa-wallet text-3xl opacity-50"></i>
                  <span class="text-xs">Connect Wallet to view inventory</span>
              </div>
          </div>

          <div class="bg-gradient-to-b from-sidebar to-[#0F212E] border border-gray-800 rounded-xl p-6 flex flex-col justify-between">
              <div>
                  <h3 class="text-white font-bold mb-4 border-b border-gray-700 pb-2">Vault Stats</h3>
                  <div class="space-y-4">
                      <div class="flex justify-between items-end">
                          <span class="text-gray-400 text-xs">TOTAL STAKED</span>
                          <span id="total-staked" class="text-white font-mono text-xl font-bold">0</span>
                      </div>
                      <div class="flex justify-between items-end">
                          <span class="text-gray-400 text-xs">APR</span>
                          <span class="text-primary font-mono text-xl font-bold">120%</span>
                      </div>
                      <div class="bg-surface p-3 rounded-lg mt-4">
                          <span class="text-gray-400 text-[10px] block mb-1">PENDING REWARDS</span>
                          <span id="pending-rewards" class="text-2xl text-primary font-mono font-bold block">0.00</span>
                      </div>
                  </div>
              </div>
              <button onclick="claimRewards()" class="w-full btn-secondary mt-6 py-3 border border-gray-600 hover:border-white text-xs">CLAIM ALL REWARDS</button>
          </div>
      </section>
      
    </main>
  </div>

  <!-- SCRIPT BLOCK (LOGIC UNTOUCHED) -->
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    // --- CONFIGURACI√ìN ---
    const ADDR = {
        TOKEN: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5",
        PRESALE: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", 
        BLACKJACK: "0xbe0b8099B707e3c0bA278583C6b5561D82E77f3E",
        INSTANT: "0xbcF9DFfcDaDeC818F7B653aF1a7Ff287F3e7011f", 
        NFT: "0xDE05dAf2cbF59ce9094979d639393ADED494e920"
    };

    const ABIS = {
        TOKEN: [ "function approve(address spender, uint256 amount) external returns (bool)", "function allowance(address owner, address spender) external view returns (uint256)", "function balanceOf(address account) external view returns (uint256)" ],
        PRESALE: [ "function buyTokens() payable" ],
        GAME: [ 
            "function blackjackDeal(uint256 bet) external", 
            "function playMines(uint256 bet, uint256 mask) external",
            "function playSlots(uint256 bet) external",
            "function playCrash(uint256 bet, uint256 cashout) external"
        ], 
        NFT: [ "function balanceOf(address, uint256) view returns (uint256)", "function mint(uint256, uint256) external", "function stake(uint256, uint256) external", "function claim() external", "function getPendingRewards(address) view returns (uint256)", "function getStakedBalance(address, uint256) view returns (uint256)" ]
    };

    let provider, signer, address;
    let contracts = {};
    let gameState = { active: false, game: null, mines: [], bjPlayer: 0, bjDealer: 0 };

    // --- UTILS ---
    const toast = (msg, type='success') => {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        // Updated styling for toast
        const bgColor = type==='error' ? 'bg-red-500' : 'bg-primary';
        const textColor = type==='error' ? 'text-white' : 'text-black';
        
        t.className = `toast-anim flex items-center p-4 mb-2 rounded shadow-lg ${bgColor} ${textColor} min-w-[200px]`;
        t.innerHTML = `<span class="font-bold text-xs uppercase mr-2">${type === 'error' ? 'Error' : 'Success'}</span> <span class="text-xs font-mono">${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    };

    function updateStatus(msg, colorClass='text-gray-500') {
        const el = document.getElementById('gameStatus');
        el.innerText = msg;
        // Reset classes and apply new ones
        el.className = `absolute bottom-2 w-full text-center text-xs font-mono font-bold uppercase tracking-widest ${colorClass}`;
    }

    // --- WALLET ---
    document.getElementById('connectBtn').addEventListener('click', async () => {
        if(!window.ethereum) return alert("Install Metamask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            address = await signer.getAddress();
            
            contracts.token = new ethers.Contract(ADDR.TOKEN, ABIS.TOKEN, signer);
            contracts.presale = new ethers.Contract(ADDR.PRESALE, ABIS.PRESALE, signer);
            contracts.instant = new ethers.Contract(ADDR.INSTANT, ABIS.GAME, signer);
            contracts.blackjack = new ethers.Contract(ADDR.BLACKJACK, ABIS.GAME, signer);
            contracts.nft = new ethers.Contract(ADDR.NFT, ABIS.NFT, signer);

            updateUI();
            toast("WALLET CONNECTED");
        } catch(e) { toast("Connection Error", "error"); }
    });

    async function updateUI() {
        // Formato corto de direcci√≥n
        document.getElementById('connectBtn').innerHTML = `<i class="fas fa-user mr-1"></i> ${address.substring(0,6)}...`;
        try {
            const bal = await contracts.token.balanceOf(address);
            const fmt = Math.floor(parseFloat(ethers.utils.formatUnits(bal, 18)));
            document.getElementById('headerBalance').innerText = fmt.toLocaleString();
            document.getElementById('modalBalance').innerText = fmt.toLocaleString();
            document.getElementById('walletDisplay').style.display = 'flex';
            loadUserData();
        } catch(e) { console.log("Token load error (ignore if dev)"); }
    }

    // --- PRESALE LOGIC ---
    document.getElementById('buyInput').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('receiveInput').value = val ? (val * 1500000).toFixed(0) : 0;
    });

    document.getElementById('buyBtn').addEventListener('click', async () => {
        if(!signer) return toast("Connect Wallet", "error");
        const ethVal = document.getElementById('buyInput').value;
        if(!ethVal || ethVal <= 0) return toast("Invalid Amount", "error");
        
        const btn = document.getElementById('buyBtn');
        const status = document.getElementById('presaleStatus');
        
        try {
            btn.disabled = true; btn.innerText = "PROCESSING...";
            status.innerText = "Confirming Transaction...";
            
            const tx = await contracts.presale.buyTokens({
                value: ethers.utils.parseEther(ethVal),
                gasLimit: 500000 
            });
            
            status.innerText = "Waiting for block...";
            await tx.wait();
            
            toast("PURCHASE SUCCESSFUL!");
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#00E701', '#ffffff']
            });
            updateUI();
        } catch(e) {
            console.error(e);
            toast("Transaction Failed", "error");
        } finally {
            btn.disabled = false; btn.innerText = "BUY TOKENS NOW";
            status.innerText = "";
        }
    });

    // --- GAME ENGINE ---
    window.openGame = (gameName) => {
        gameState.game = gameName;
        gameState.active = false;
        gameState.mines = [];
        
        const m = document.getElementById('gameModal');
        const content = document.getElementById('innerGameContent');
        const extra = document.getElementById('gameExtraControls');
        const btn = document.getElementById('gameActionBtn');

        m.classList.remove('hidden');
        m.classList.add('flex'); // Flex to center
        document.body.style.overflow = 'hidden';
        
        document.getElementById('modalTitle').innerText = gameName;
        extra.innerHTML = ''; extra.classList.add('hidden');
        btn.style.display = 'block'; btn.innerText = 'PLAY ROUND'; btn.disabled = false;
        updateStatus("READY TO START");

        // Config UI Inicial
        if(gameName === 'blackjack') {
            content.innerHTML = `
                <div class="flex flex-col gap-6 w-full max-w-sm">
                    <div class="text-center bg-white/5 p-4 rounded-lg border border-white/5">
                        <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-widest">DEALER HAND</p>
                        <div id="bjDealer" class="h-[90px] flex justify-center items-center gap-[-20px]"><div class="playing-card bg-gray-800 border-2 border-gray-600 rounded-md">?</div></div>
                    </div>
                    <div class="text-center bg-white/5 p-4 rounded-lg border border-white/5">
                        <div id="bjPlayer" class="h-[90px] flex justify-center items-center gap-[-20px]"><div class="text-xs text-gray-600 font-mono">WAITING DEAL...</div></div>
                        <p class="text-[10px] text-gray-400 mt-2 font-bold uppercase tracking-widest">YOUR HAND</p>
                    </div>
                </div>`;
        } else if (gameName === 'mines') {
            btn.innerText = "BET & REVEAL";
            updateStatus("SELECT 1-5 TILES", "text-primary");
            let grid = '<div class="grid grid-cols-5 gap-2 w-full max-w-[300px] mx-auto">';
            for(let i=0; i<25; i++) grid += `<div class="mine-tile" id="tile-${i}" onclick="toggleMine(${i})"></div>`;
            grid += '</div>';
            content.innerHTML = grid;
        } else {
            content.innerHTML = `<div class="text-6xl text-gray-700 animate-pulse"><i class="fas fa-gamepad"></i></div>`;
        }
        
        btn.onclick = startGameTransaction;
    };

    window.closeGame = () => {
        const m = document.getElementById('gameModal');
        m.classList.add('hidden');
        m.classList.remove('flex');
        document.body.style.overflow = 'auto';
    };

    // --- GAME LOGIC ---
    window.toggleMine = (idx) => {
        if(gameState.active) return;
        const tile = document.getElementById(`tile-${idx}`);
        if(gameState.mines.includes(idx)) {
            gameState.mines = gameState.mines.filter(i => i !== idx);
            tile.classList.remove('selected'); tile.innerText = '';
        } else {
            if(gameState.mines.length >= 5) return toast("Max 5 Tiles", "error");
            gameState.mines.push(idx);
            tile.classList.add('selected'); 
            tile.innerHTML = '<i class="fas fa-crosshairs text-primary"></i>';
        }
    };

    async function startGameTransaction() {
        if(!signer) return toast("Connect Wallet", "error");
        const betVal = document.getElementById('gameBetInput').value;
        const bet = ethers.utils.parseUnits(betVal, 18);
        const btn = document.getElementById('gameActionBtn');

        if(gameState.game === 'mines' && gameState.mines.length === 0) return toast("Select tiles first", "error");

        try {
            btn.disabled = true; btn.innerText = "APPROVING...";
            updateStatus("CHECKING ALLOWANCE...", "text-yellow-500");

            const spender = gameState.game === 'blackjack' ? ADDR.BLACKJACK : ADDR.INSTANT;
            const allow = await contracts.token.allowance(address, spender);
            if(allow.lt(bet)) {
                const txApp = await contracts.token.approve(spender, ethers.constants.MaxUint256, { gasLimit: 100000 });
                await txApp.wait();
            }

            btn.innerText = "SENDING...";
            updateStatus("CONFIRM IN WALLET...", "text-yellow-500");
            let tx;

            if(gameState.game === 'blackjack') {
                tx = await contracts.blackjack.blackjackDeal(bet, { gasLimit: 500000 });
                startBjRoundVisual(); 
            } 
            else if (gameState.game === 'mines') {
                tx = await contracts.instant.playMines(bet, 123, { gasLimit: 500000 });
                await tx.wait();
                revealMinesVisual();
            }
            else if (gameState.game === 'slots') {
                tx = await contracts.instant.playSlots(bet, { gasLimit: 500000 });
                await tx.wait();
                playSlotsAnim();
            }
            else if (gameState.game === 'crash') {
                tx = await contracts.instant.playCrash(bet, 200, { gasLimit: 500000 }); 
                await tx.wait();
                endGame(true, "CASHED OUT @ 2.00x");
            }

            if(gameState.game !== 'blackjack') updateUI();

        } catch(e) {
            console.error(e);
            const err = e.message || JSON.stringify(e);
            if(err.includes("user rejected")) toast("User Rejected", "error");
            else toast("Transaction Failed", "error");
            
            btn.disabled = false; btn.innerText = "PLAY ROUND";
            updateStatus("ERROR DETECTED", "text-red-500");
        }
    }

    // --- VISUAL SIMULATIONS ---
    
    // Blackjack
    function startBjRoundVisual() {
        const btn = document.getElementById('gameActionBtn');
        btn.style.display = 'none'; 
        
        const extra = document.getElementById('gameExtraControls');
        extra.classList.remove('hidden');
        extra.classList.add('flex');
        extra.innerHTML = `
            <button onclick="bjHit()" class="flex-1 bg-accent hover:bg-blue-600 text-white font-bold py-2 rounded shadow-lg">HIT</button>
            <button onclick="bjStand()" class="flex-1 bg-surface hover:bg-gray-600 text-white font-bold py-2 rounded shadow-lg">STAND</button>
        `;

        document.getElementById('bjPlayer').innerHTML = '';
        document.getElementById('bjDealer').innerHTML = '';
        
        gameState.bjPlayer = 0;
        gameState.bjDealer = 0;

        addCard('bjDealer', getRandomCard());
        setTimeout(() => addCard('bjPlayer', getRandomCard()), 500);
        setTimeout(() => addCard('bjPlayer', getRandomCard()), 1000);
        
        updateStatus("YOUR TURN: HIT OR STAND?", "text-white");
    }

    window.bjHit = () => {
        addCard('bjPlayer', getRandomCard());
        if(gameState.bjPlayer > 21) endGame(false, "BUSTED! > 21");
    };

    window.bjStand = () => {
        document.getElementById('gameExtraControls').innerHTML = ''; 
        updateStatus("DEALER TURN...", "text-yellow-500");
        
        const interval = setInterval(() => {
            if(gameState.bjDealer < 17) {
                addCard('bjDealer', getRandomCard());
            } else {
                clearInterval(interval);
                if(gameState.bjDealer > 21) endGame(true, "DEALER BUST! YOU WIN");
                else if (gameState.bjDealer >= gameState.bjPlayer) endGame(false, "DEALER WINS");
                else endGame(true, "YOU WIN!");
            }
        }, 800);
    };

    function addCard(id, card) {
        const div = document.getElementById(id);
        const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
        // -ml-4 para efecto de superposici√≥n de cartas
        div.innerHTML += `
            <div class="playing-card ${isRed?'card-red':'card-black'} -ml-4 first:ml-0">
                <span class="text-lg">${card.val}</span>
                <span class="text-xs">${card.suit}</span>
            </div>`;
        
        let num = parseInt(card.val);
        if(isNaN(num)) num = card.val === 'A' ? 11 : 10;
        
        if(id === 'bjPlayer') gameState.bjPlayer += num;
        else gameState.bjDealer += num;
    }

    // Mines
    function revealMinesVisual() {
        const bombs = [Math.floor(Math.random()*25), Math.floor(Math.random()*25)]; 
        let hit = false;
        gameState.mines.forEach(idx => {
            const tile = document.getElementById(`tile-${idx}`);
            tile.classList.remove('selected');
            if(bombs.includes(idx)) {
                tile.classList.add('revealed-bomb'); 
                tile.innerHTML = '<i class="fas fa-bomb"></i>'; 
                hit = true;
            } else {
                tile.classList.add('revealed-safe'); 
                tile.innerHTML = '<i class="fas fa-gem"></i>';
            }
        });
        endGame(!hit, hit ? "BOOM! GAME OVER" : "NICE! GEMS FOUND");
    }

    // Slots
    function playSlotsAnim() {
        const content = document.getElementById('innerGameContent');
        const emojis = ['üçí','7Ô∏è‚É£','üíé','üçã', 'üçá'];
        let interval = setInterval(() => {
            content.innerHTML = `
                <div class="flex gap-4 text-5xl bg-surface p-6 rounded-xl border border-gray-700 shadow-inner">
                    <span>${emojis[Math.floor(Math.random()*5)]}</span>
                    <span>${emojis[Math.floor(Math.random()*5)]}</span>
                    <span>${emojis[Math.floor(Math.random()*5)]}</span>
                </div>`;
        }, 100);
        
        setTimeout(() => {
            clearInterval(interval);
            const win = Math.random() > 0.5;
            const res = win ? ['7Ô∏è‚É£','7Ô∏è‚É£','7Ô∏è‚É£'] : ['üçí','üçã','üíé'];
            content.innerHTML = `
                <div class="flex gap-4 text-5xl bg-surface p-6 rounded-xl border border-gray-700 shadow-inner ${win?'border-primary shadow-glow':''}">
                    <span class="${win?'animate-bounce':''}">${res[0]}</span>
                    <span class="${win?'animate-bounce delay-100':''}">${res[1]}</span>
                    <span class="${win?'animate-bounce delay-200':''}">${res[2]}</span>
                </div>`;
            endGame(win, win ? "BIG WIN! JACKPOT!" : "NO LUCK THIS TIME");
        }, 2000);
    }

    // Common End Game
    function endGame(won, msg) {
        updateStatus(msg, won ? 'text-primary' : 'text-danger');
        const btn = document.getElementById('gameActionBtn');
        btn.style.display = 'block';
        btn.disabled = false;
        btn.innerText = "PLAY AGAIN";
        document.getElementById('gameExtraControls').classList.add('hidden');
        document.getElementById('gameExtraControls').classList.remove('flex');
        
        if(won) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00E701', '#FFFFFF'] });
        }
    }

    // Helper
    function getRandomCard() {
        const s = ['‚ô†','‚ô•','‚ô¶','‚ô£']; const v = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        return { val: v[Math.floor(Math.random()*v.length)], suit: s[Math.floor(Math.random()*s.length)] };
    }
    
    // User Data
    window.loadUserData = async () => {
        if(!signer) return;
        const list = document.getElementById('inventory-list');
        list.className = "grid grid-cols-1 gap-2 max-h-48 overflow-y-auto";
        // Simulaci√≥n UI
        list.innerHTML = `
            <div class="flex justify-between items-center bg-[#0F212E] p-3 rounded border border-gray-700 hover:border-gray-500 transition">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-700 rounded flex items-center justify-center text-xs">üÉè</div>
                    <span class="text-white text-xs font-bold">Pepe Classic #420</span>
                </div>
                <button class="text-[10px] bg-primary text-black font-bold px-3 py-1 rounded hover:bg-white transition">STAKE</button>
            </div>
             <div class="flex justify-between items-center bg-[#0F212E] p-3 rounded border border-gray-700 hover:border-gray-500 transition">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-yellow-900/50 rounded flex items-center justify-center text-xs">üëë</div>
                    <span class="text-white text-xs font-bold">Golden Pepe #69</span>
                </div>
                <button class="text-[10px] bg-primary text-black font-bold px-3 py-1 rounded hover:bg-white transition">STAKE</button>
            </div>
        `;
    };
    window.claimRewards = async () => { toast("Claiming rewards..."); setTimeout(()=>toast("0.00 PBJ Sent to Wallet"), 1500); };
  </script>
</body>
</html>
