<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>Pepe Blackjack (PBJ) - On-Chain Casino</title>
  <meta name="description" content="The #1 Meme Casino on Base. Play Blackjack, Buy PBJ, Stake NFTs." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet" />

  <!-- CSS Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Web3 & Effects -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --neon-green: #39ff14;
      --panel-bg: rgba(10, 20, 15, 0.85); /* M√°s opaco para mejor lectura m√≥vil */
      --glass-border: rgba(57, 255, 20, 0.2);
    }

    /* Typography */
    h1, h2, h3, .nav-btn, .pixel-font { font-family: 'Press Start 2P', cursive; }
    body { font-family: 'Inter', sans-serif; background-color: #050505; color: #e0e0e0; overflow-x: hidden; }

    /* Backgrounds */
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background: radial-gradient(circle at 15% 50%, rgba(34, 197, 94, 0.08), transparent 25%),
                  radial-gradient(circle at 85% 30%, rgba(37, 99, 235, 0.08), transparent 25%);
    }
    body::after {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* Glass Panels */
    .glass-panel {
      background: var(--panel-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .glass-panel:hover {
      border-color: rgba(57, 255, 20, 0.4);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.15);
    }

    /* Buttons */
    .nav-btn { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s; cursor: pointer; }
    .nav-btn:hover { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); transform: translateY(-2px); }
    
    .action-btn {
      background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
      box-shadow: 0 4px 0 #064e3b; transition: all 0.1s;
    }
    .action-btn:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
    .action-btn:disabled { background: #333; box-shadow: none; cursor: not-allowed; opacity: 0.6; filter: grayscale(1); }

    /* Cards */
    .card {
      width: 70px; height: 100px; background: white; border-radius: 8px;
      position: relative; display: flex; align-items: center; justify-content: center;
      font-family: 'Inter', sans-serif; font-weight: bold; font-size: 20px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
      transform: translateY(-20px) scale(0.8); opacity: 0;
      transition: transform 0.4s, opacity 0.4s;
    }
    .card.reveal { transform: translateY(0) scale(1); opacity: 1; }
    .card.red { color: #ef4444; } .card.black { color: #171717; }
    .card .corner-val { position: absolute; font-size: 10px; line-height: 1; }
    .card .tl { top: 4px; left: 4px; }
    .card .br { bottom: 4px; right: 4px; transform: rotate(180deg); }
    @media(min-width: 640px){ .card { width: 100px; height: 140px; font-size: 32px; } }

    /* Toast */
    #toast-container { position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      background: rgba(10, 10, 10, 0.95); border-left: 4px solid var(--neon-green);
      color: white; padding: 12px 20px; border-radius: 4px; font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5); animation: slideIn 0.3s forwards;
      pointer-events: auto; max-width: 100%;
    }
    .toast.error { border-left-color: #ef4444; }
    @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    /* Pie Chart CSS */
    .pie-chart {
      width: 200px; height: 200px; border-radius: 50%;
      background: conic-gradient(
        #22c55e 0% 40%,   /* Presale 40% */
        #3b82f6 40% 65%,  /* Liquidity 25% */
        #a855f7 65% 85%,  /* Staking 20% */
        #f59e0b 85% 95%,  /* Team 10% */
        #ef4444 95% 100%  /* Airdrop 5% */
      );
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
      position: relative;
    }
    .pie-chart::after {
      content: "1B Supply"; position: absolute; inset: 20%; background: #050505; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 12px; font-family: 'Press Start 2P'; color: white;
    }

    /* Timeline CSS */
    .timeline-item { position: relative; padding-left: 30px; padding-bottom: 30px; border-left: 2px solid #22c55e; }
    .timeline-item:last-child { border-left: 2px solid transparent; }
    .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }

    /* Utils */
    .blackjack-table {
      background: radial-gradient(circle, #0f4c2e 0%, #062415 100%);
      border: 8px solid #1a1a1a; border-radius: 30px; box-shadow: inset 0 0 50px #000; position: relative;
    }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

  <div id="toast-container"></div>

  <!-- HEADER -->
  <nav class="sticky top-0 z-50 bg-black/90 backdrop-blur-md border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]"></div>
        <span class="text-green-400 text-sm md:text-lg pixel-font">PBJ CASINO</span>
      </div>
      
      <div class="hidden md:flex gap-6">
        <a href="#tokenomics" class="nav-btn text-gray-400">Tokenomics</a>
        <a href="#roadmap" class="nav-btn text-gray-400">Roadmap</a>
        <a href="#blackjack" class="nav-btn text-gray-400">Games</a>
        <a href="#nfts" class="nav-btn text-gray-400">NFTs</a>
      </div>

      <div class="flex items-center gap-3 ml-auto md:ml-0">
        <div id="walletDisplay" class="hidden items-center gap-2 px-3 py-1 rounded-full border border-green-800 bg-green-900/20 text-[10px] md:text-xs text-green-400">
          <span id="pbjBalanceHeader">0</span> PBJ
        </div>
        <button id="connectBtn" class="pixel-font bg-green-600 hover:bg-green-500 text-black text-[10px] px-4 py-2 rounded shadow-[0_0_10px_rgba(34,197,94,0.4)] transition-all">
          CONNECT
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-8 space-y-20">

    <!-- STATUS -->
    <div id="status" class="text-center text-[10px] font-mono min-h-[20px]"></div>

    <!-- HERO & PRESALE -->
    <section id="presale" class="grid md:grid-cols-2 gap-12 items-center pt-4">
      <div class="space-y-6 text-center md:text-left">
        <div class="inline-block px-3 py-1 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-[10px] font-bold tracking-widest mb-2">
          LIVE ON BASE L2
        </div>
        <h1 class="text-3xl md:text-5xl leading-tight text-white">
          Win Big with <span class="text-green-500">PEPE</span><br>Blackjack
        </h1>
        <p class="text-gray-400 leading-relaxed text-xs md:text-sm">
          The first fully on-chain meme casino. Connect Trust Wallet or MetaMask, buy PBJ, and play instantly.
        </p>

        <div class="glass-panel p-6 space-y-4 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-blue-500"></div>
          
          <div class="flex justify-between text-xs md:text-sm">
             <span class="text-gray-400">Presale Progress</span>
             <span id="presale-countdown" class="text-green-400 font-bold font-mono">Ending Soon</span>
          </div>
          <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden">
             <div id="presale-progress" class="h-full bg-green-500 shadow-[0_0_10px_#22c55e]" style="width: 75%"></div>
          </div>

          <div class="grid grid-cols-2 gap-4 pt-2">
            <div>
              <label class="text-[10px] text-gray-500 uppercase font-bold">ETH Amount</label>
              <input type="number" id="ethInput" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-green-500 outline-none transition-colors text-xs" placeholder="0.01">
            </div>
            <div>
              <label class="text-[10px] text-gray-500 uppercase font-bold">PBJ Received</label>
              <input type="text" id="pbjOutput" readonly class="w-full bg-black/30 border border-transparent rounded p-2 text-gray-300 cursor-not-allowed text-xs" placeholder="0">
            </div>
          </div>

          <button id="buyBtn" disabled class="w-full action-btn text-white font-bold py-3 rounded pixel-font text-xs mt-2">
            BUY TOKENS
          </button>
          <div class="flex justify-between text-[10px] text-gray-500">
            <span>Rate: 1 ETH = 1M PBJ</span>
            <span id="ethBalance">0.0000 ETH</span>
          </div>
        </div>
      </div>

      <div class="relative group hidden md:block">
        <div class="absolute -inset-1 bg-gradient-to-r from-green-600 to-blue-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
        <img src="/preventa.avif" alt="Pepe Dealer" class="relative rounded-2xl shadow-2xl w-full border border-gray-800">
      </div>
    </section>

    <!-- TOKENOMICS SECTION -->
    <section id="tokenomics" class="pt-10">
      <h2 class="text-xl md:text-2xl text-green-400 mb-8 text-center">Tokenomics</h2>
      <div class="glass-panel p-8 grid md:grid-cols-2 gap-10 items-center">
        <!-- Chart -->
        <div class="flex justify-center">
          <div class="pie-chart"></div>
        </div>
        <!-- Legend -->
        <div class="space-y-4">
          <div class="flex items-center justify-between text-xs border-b border-gray-800 pb-2">
            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> Presale</span>
            <span class="font-mono text-green-400">40%</span>
          </div>
          <div class="flex items-center justify-between text-xs border-b border-gray-800 pb-2">
            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-500 rounded-sm"></span> Liquidity</span>
            <span class="font-mono text-blue-400">25%</span>
          </div>
          <div class="flex items-center justify-between text-xs border-b border-gray-800 pb-2">
            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-purple-500 rounded-sm"></span> Staking</span>
            <span class="font-mono text-purple-400">20%</span>
          </div>
          <div class="flex items-center justify-between text-xs border-b border-gray-800 pb-2">
            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> Team</span>
            <span class="font-mono text-yellow-400">10%</span>
          </div>
          <div class="flex items-center justify-between text-xs">
            <span class="flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> Airdrop</span>
            <span class="font-mono text-red-400">5%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ROADMAP SECTION -->
    <section id="roadmap">
      <h2 class="text-xl md:text-2xl text-green-400 mb-8 text-center">Roadmap</h2>
      <div class="glass-panel p-8 max-w-3xl mx-auto">
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <h3 class="text-xs text-green-400 mb-1 pixel-font">PHASE 1: ORIGIN</h3>
          <p class="text-xs text-gray-400">Presale Launch, Contract Audit, Community Building on Telegram & Twitter.</p>
        </div>
        <div class="timeline-item">
          <div class="timeline-dot bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
          <h3 class="text-xs text-blue-400 mb-1 pixel-font">PHASE 2: CASINO ALPHA</h3>
          <p class="text-xs text-gray-400">Blackjack Live on Base Mainnet, NFT Minting, Staking Pools opening.</p>
        </div>
        <div class="timeline-item">
          <div class="timeline-dot bg-purple-500 shadow-[0_0_10px_#a855f7]"></div>
          <h3 class="text-xs text-purple-400 mb-1 pixel-font">PHASE 3: EXPANSION</h3>
          <p class="text-xs text-gray-400">Roulette & Slots Games, CEX Listings, Revenue Share for NFT Holders.</p>
        </div>
        <div class="timeline-item">
          <div class="timeline-dot bg-white shadow-[0_0_10px_#fff]"></div>
          <h3 class="text-xs text-white mb-1 pixel-font">PHASE 4: GLOBAL</h3>
          <p class="text-xs text-gray-400">Mobile App (iOS/Android), Live Dealer Integration, Metaverse Casino.</p>
        </div>
      </div>
    </section>

    <!-- BLACKJACK GAME -->
    <section id="blackjack" class="space-y-6">
      <div class="text-center space-y-2">
        <h2 class="text-xl md:text-2xl text-green-400">Blackjack Arena</h2>
        <p class="text-xs text-gray-400">State: <span id="gameState" class="text-white font-bold">Idle</span></p>
      </div>

      <div class="blackjack-table p-6 md:p-12 min-h-[400px] flex flex-col justify-between relative">
        <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
           <h1 class="text-6xl md:text-8xl text-white pixel-font">PBJ</h1>
        </div>

        <!-- Dealer -->
        <div class="flex flex-col items-center gap-2 z-10">
          <div class="text-[10px] uppercase tracking-widest text-gray-400 bg-black/40 px-3 py-1 rounded-full border border-white/10">
            Dealer <span id="dealerScore" class="text-white font-bold ml-1">0</span>
          </div>
          <div id="dealerArea" class="flex justify-center gap-2 md:gap-4 min-h-[110px]"></div>
        </div>

        <!-- Msg -->
        <div id="resultMsg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 pointer-events-none transition-all w-full text-center px-4"></div>

        <!-- Player -->
        <div class="flex flex-col items-center gap-4 z-10">
          <div id="playerArea" class="flex justify-center gap-2 md:gap-4 min-h-[110px]"></div>
          
          <div class="glass-panel px-4 py-2 flex items-center gap-4 border-green-500/30">
             <div class="text-[10px] uppercase tracking-widest text-gray-400">You <span id="playerScore" class="text-white font-bold ml-1">0</span></div>
             <div class="h-4 w-px bg-gray-600"></div>
             <div class="text-green-400 font-bold text-xs">Bet: <span id="activeBetDisplay">0</span> PBJ</div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="glass-panel p-4 max-w-2xl mx-auto">
        <div class="flex flex-wrap items-center justify-center gap-4 mb-4">
          <span class="text-xs text-gray-400">Status:</span>
          <span id="betStatus" class="text-xs font-mono text-yellow-400">Ready</span>
        </div>

        <!-- Betting UI -->
        <div class="flex flex-wrap items-center justify-center gap-4" id="bettingControls">
          <div class="flex items-center bg-black/40 rounded-lg border border-gray-700 overflow-hidden">
            <span class="px-3 text-gray-500 text-[10px] font-bold">BET PBJ</span>
            <input type="number" id="betAmount" value="1000" step="100" class="w-24 bg-transparent p-2 text-white outline-none font-mono text-xs">
          </div>
          <button id="btnDeal" class="action-btn text-white px-8 py-2 rounded pixel-font text-xs">DEAL</button>
        </div>

        <!-- Playing UI -->
        <div class="hidden flex-wrap items-center justify-center gap-2 md:gap-4" id="playControls">
          <button id="btnHit" class="bg-blue-600 hover:bg-blue-500 border-b-4 border-blue-800 text-white px-4 py-2 rounded pixel-font text-[10px] disabled:opacity-50">HIT</button>
          <button id="btnStand" class="bg-red-600 hover:bg-red-500 border-b-4 border-red-800 text-white px-4 py-2 rounded pixel-font text-[10px] disabled:opacity-50">STAND</button>
          <button id="btnDouble" class="bg-yellow-600 hover:bg-yellow-500 border-b-4 border-yellow-800 text-white px-4 py-2 rounded pixel-font text-[10px] disabled:opacity-50">DOUBLE</button>
          <button id="btnCancel" class="bg-gray-600 hover:bg-gray-500 border-b-4 border-gray-800 text-white px-4 py-2 rounded pixel-font text-[10px] disabled:opacity-50">CANCEL</button>
        </div>
      </div>
    </section>

    <!-- NFT SHOP -->
    <section id="nfts" class="pb-10">
      <h2 class="text-xl md:text-2xl text-green-400 mb-8 text-center">Membership NFTs</h2>
      
      <div class="grid md:grid-cols-3 gap-6 mb-12">
        <div class="glass-panel p-4 hover:scale-105 transition-transform text-center">
          <div class="text-xs text-green-400 mb-2 pixel-font">COMMON</div>
          <div class="w-full aspect-square bg-green-900/20 rounded mb-3 border border-green-800 flex items-center justify-center text-4xl">üê∏</div>
          <p class="text-[10px] text-gray-400 mb-3">Price: 5,000 PBJ</p>
          <button onclick="buyNFT(0)" class="w-full border border-green-600 text-green-400 hover:bg-green-600 hover:text-black py-2 rounded pixel-font text-[10px] transition-colors">MINT</button>
        </div>
        <div class="glass-panel p-4 hover:scale-105 transition-transform text-center relative">
          <div class="absolute -top-3 right-4 bg-blue-500 text-black text-[9px] font-bold px-2 py-1 rounded pixel-font">POPULAR</div>
          <div class="text-xs text-blue-400 mb-2 pixel-font">RARE</div>
          <div class="w-full aspect-square bg-blue-900/20 rounded mb-3 border border-blue-800 flex items-center justify-center text-4xl">üê∏üé©</div>
          <p class="text-[10px] text-gray-400 mb-3">Price: 10,000 PBJ</p>
          <button onclick="buyNFT(1)" class="w-full border border-blue-600 text-blue-400 hover:bg-blue-600 hover:text-black py-2 rounded pixel-font text-[10px] transition-colors">MINT</button>
        </div>
        <div class="glass-panel p-4 hover:scale-105 transition-transform text-center">
          <div class="text-xs text-purple-400 mb-2 pixel-font">LEGENDARY</div>
          <div class="w-full aspect-square bg-purple-900/20 rounded mb-3 border border-purple-800 flex items-center justify-center text-4xl">üê∏üëë</div>
          <p class="text-[10px] text-gray-400 mb-3">Price: 25,000 PBJ</p>
          <button onclick="buyNFT(2)" class="w-full border border-purple-600 text-purple-400 hover:bg-purple-600 hover:text-black py-2 rounded pixel-font text-[10px] transition-colors">MINT</button>
        </div>
      </div>

      <div class="glass-panel p-6 text-center">
        <h3 class="text-xs text-white mb-2 pixel-font">Your Inventory</h3>
        <div id="userNFTs" class="flex flex-wrap gap-4 justify-center min-h-[30px] text-xs text-gray-500">
          Connect wallet to view.
        </div>
      </div>
    </section>

  </main>

  <footer class="border-t border-white/10 bg-black/80 py-8 mt-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <div class="flex justify-center gap-4 text-gray-400 text-xs mb-4">
        <a href="#" class="hover:text-green-400">Contract</a>
        <a href="#" class="hover:text-green-400">Twitter</a>
        <a href="#" class="hover:text-green-400">Telegram</a>
      </div>
      <p class="text-[10px] text-gray-700 font-mono">¬© 2025 PBJ CASINO.</p>
    </div>
  </footer>

  <!-- ========================================= -->
  <!-- LOGIC SCRIPT -->
  <!-- ========================================= -->
  <script defer>
    /* --- Helpers --- */
    const toast = (msg, type = 'success') => {
      const c = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
    };
    const showStatus = (msg, ok = true) => {
       const el = document.getElementById('status');
       if(el) { el.textContent = msg; el.style.color = ok ? '#39ff14' : '#ff5151'; }
       if(msg.includes('Error') || msg.includes('Purchase')) toast(msg, ok?'success':'error');
    };
    const formatNum = (n) => new Intl.NumberFormat('en-US').format(n);

    /* --- CONFIG --- */
    let provider, signer, userAddress;
    let pbjContract, casinoContract, presaleContract;

    const rate = 1000000;
    const PRESALE_DURATION_MS = 7 * 24 * 60 * 60 * 1000; 
    const presaleStart = Date.now();

    const contractAddress     = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
    const pbjContractAddress  = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
    const pbjTokenAddress     = '0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5';
    const casinoAddress       = '0x79e617b64eae98bda7f8Cd4b1EdC05dE696E4B74';
    const nftAddress          = '0x4AabC024D719240e98e82930EAC04bD49CB86E31';

    // ABIs fixed for Ethers v5 (Human-Readable)
    const pbjAbi = [
      'function balanceOf(address) view returns (uint256)',
      'function decimals() view returns (uint8)',
      'function approve(address spender, uint256 amount) returns (bool)',
      'function allowance(address owner, address spender) view returns (uint256)'
    ];
    const casinoAbi = [
      'function placeBet(uint256 amount) external',
      'function finishGame(bool playerWon) external',
      'function cancelBet() external'
    ];
    const presaleAbi = ['function buyTokens() payable'];
    
    // CORRECCI√ìN CLAVE AQU√ç: ABI legible para evitar error "invalid fragment object"
    const nftAbi = [
      'function mint(uint8 _rarity) external',
      'function balanceOf(address owner) view returns (uint256)',
      // Simplificamos el struct de retorno. Ethers v5 mapea el struct a un array si no se define completo,
      // pero con este string basta para que no crashee.
      'function nftTypes(uint8) view returns (uint256 pricePBJ, uint256 totalSupply, uint256 minted)'
    ];

    /* --- WALLET LOGIC (Optimized for Mobile/TrustWallet) --- */
    async function ensureBaseNetwork() {
      try {
        const net = await provider.getNetwork();
        if (net.chainId === 8453) return true;
        // Intentar switch
        try {
          await provider.send("wallet_switchEthereumChain", [{ chainId: "0x2105" }]);
          return true;
        } catch (e) {
          try {
             await provider.send("wallet_addEthereumChain", [{
              chainId: "0x2105",
              chainName: "Base",
              nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
              rpcUrls: ["https://mainnet.base.org"],
              blockExplorerUrls: ["https://basescan.org"]
            }]);
            return true;
          } catch (e2) {
            toast("Switch to Base Network manually", "error");
            return false;
          }
        }
      } catch(e){ return false; }
    }

    async function connectFlow() {
      const btn = document.getElementById('connectBtn');
      btn.textContent = "CONNECTING...";
      btn.disabled = true;

      // Timeout de seguridad por si se cuelga
      const timeout = setTimeout(() => {
        if(!userAddress) {
          btn.textContent = "CONNECT"; 
          btn.disabled = false;
          toast("Connection timed out. Retry.", "error");
        }
      }, 10000);

      try {
        // 1. Priorizar Injected Provider (Trust Wallet / MetaMask Mobile)
        if (window.ethereum) {
          provider = new ethers.providers.Web3Provider(window.ethereum, "any");
          await provider.send("eth_requestAccounts", []);
        } 
        // 2. Fallback a WalletConnect (Solo escritorio o si no hay inyectado)
        else {
          const { default: EthereumProvider } = await import("https://esm.sh/@walletconnect/ethereum-provider@2.11.1");
          const wcProvider = await EthereumProvider.init({
            projectId: "06606e3b978574fe1fe67024c91c5aa3", // Demo ID
            chains: [8453],
            showQrModal: true,
            rpcMap: { 8453: "https://mainnet.base.org" }
          });
          await wcProvider.enable();
          provider = new ethers.providers.Web3Provider(wcProvider, "any");
        }

        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        clearTimeout(timeout);
        
        const ok = await ensureBaseNetwork();
        if (!ok) throw new Error("Wrong Network");

        await afterConnected();

      } catch (e) {
        clearTimeout(timeout);
        console.error(e);
        toast("Connection failed", "error");
        btn.textContent = "CONNECT";
        btn.disabled = false;
      }
    }

    async function afterConnected(){
      pbjContract      = new ethers.Contract(pbjContractAddress, pbjAbi, signer);
      casinoContract   = new ethers.Contract(casinoAddress, casinoAbi, signer);
      presaleContract  = new ethers.Contract(contractAddress, presaleAbi, signer);

      const btn = document.getElementById('connectBtn');
      const walletDisplay = document.getElementById('walletDisplay');
      const short = userAddress.substring(0,5) + "..." + userAddress.substring(38);
      
      btn.textContent = short;
      btn.classList.replace('bg-green-600', 'bg-gray-800');
      btn.classList.replace('text-black', 'text-green-400');
      walletDisplay.classList.remove('hidden');
      walletDisplay.classList.add('flex');
      
      const buyBtn = document.getElementById('buyBtn');
      if(buyBtn) buyBtn.disabled = false;

      toast("Connected successfully");
      await updatePBJBalance();
      await loadUserNFTs();
    }

    async function updatePBJBalance(){
      if(!pbjContract) return;
      try {
        const raw = await pbjContract.balanceOf(userAddress);
        // Asumimos 18 decimales si falla la llamada
        const balance = ethers.utils.formatUnits(raw, 18); 
        document.getElementById('pbjBalanceHeader').textContent = formatNum(parseInt(balance));
      } catch(e){ console.log("PBJ Bal err"); }
      
      try {
        const eth = await provider.getBalance(userAddress);
        const ethEl = document.getElementById('ethBalance');
        if(ethEl) ethEl.textContent = parseFloat(ethers.utils.formatEther(eth)).toFixed(4) + ' ETH';
      } catch (e) {}
    }

    /* --- PRESALE --- */
    const ethInput = document.getElementById('ethInput');
    const pbjOutput = document.getElementById('pbjOutput');
    if(ethInput) {
      ethInput.addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        pbjOutput.value = isNaN(val) ? 0 : formatNum(Math.floor(val * rate));
      });
    }
    document.getElementById('buyBtn').addEventListener('click', async () => {
      if(!presaleContract) return toast("Connect wallet first", "error");
      const val = parseFloat(ethInput.value);
      if(!val || val <= 0) return toast("Invalid ETH amount", "error");
      
      try {
        const btn = document.getElementById('buyBtn');
        btn.textContent = "SIGNING..."; btn.disabled = true;
        const tx = await presaleContract.buyTokens({ value: ethers.utils.parseEther(val.toString()) });
        btn.textContent = "MINING...";
        await tx.wait();
        toast("Purchase Successful!", "success");
        confetti();
        await updatePBJBalance();
      } catch(e) {
        console.error(e);
        toast("Transaction failed", "error");
      } finally {
        const btn = document.getElementById('buyBtn');
        btn.textContent = "BUY TOKENS"; btn.disabled = false;
      }
    });

    /* --- NFT LOGIC (FIXED ABI) --- */
    async function loadUserNFTs() {
      const container = document.getElementById("userNFTs");
      if(!nftAddress || !userAddress) return;
      const nft = new ethers.Contract(nftAddress, nftAbi, provider);
      try {
        const bal = await nft.balanceOf(userAddress);
        if(bal.gt(0)) {
          container.innerHTML = `<span class="text-green-400">You own ${bal.toString()} NFTs!</span>`;
        } else {
          container.innerHTML = "No NFTs found.";
        }
      } catch(e){}
    }

    window.buyNFT = async function(rarity) {
      if(!provider) return toast("Connect wallet first", "error");
      try {
        const nftContract = new ethers.Contract(nftAddress, nftAbi, signer);
        const pbjToken = new ethers.Contract(pbjTokenAddress, pbjAbi, signer);

        // Get Price safely
        // Dependiendo del contrato, nftTypes devuelve un array o un objeto
        // Usamos valores hardcodeados de seguridad si falla la lectura onchain para no bloquear la UI
        let price = ethers.utils.parseUnits("5000", 18);
        if(rarity === 1) price = ethers.utils.parseUnits("10000", 18);
        if(rarity === 2) price = ethers.utils.parseUnits("25000", 18);

        try {
            const info = await nftContract.nftTypes(rarity);
            if(info && info.pricePBJ) price = info.pricePBJ;
            else if(info && info[0]) price = info[0];
        } catch(e) { console.log("Using fallback prices"); }

        // Check Allowance
        const allowance = await pbjToken.allowance(userAddress, nftAddress);
        if(allowance.lt(price)) {
          toast("Approving PBJ spend...");
          const txApp = await pbjToken.approve(nftAddress, ethers.constants.MaxUint256);
          await txApp.wait();
        }

        toast("Confirm Minting...");
        const tx = await nftContract.mint(rarity);
        toast("Minting in progress...");
        await tx.wait();
        toast("‚úÖ NFT Minted Successfully!", "success");
        confetti();
        await loadUserNFTs();
        await updatePBJBalance();

      } catch(e) {
        console.error(e);
        // Filtramos el mensaje de error para que sea legible
        let msg = "Mint failed";
        if(e.code === 'ACTION_REJECTED') msg = "User rejected transaction";
        if(e.message.includes("insufficient funds")) msg = "Insufficient PBJ/ETH";
        toast(msg, "error");
      }
    }

    /* --- BLACKJACK GAME (Existing Logic Preserved) --- */
    let deck=[], playerHand=[], dealerHand=[], betAmountPBJ=0, gameActive=false;
    const ui = {
      deal: document.getElementById('btnDeal'),
      hit: document.getElementById('btnHit'),
      stand: document.getElementById('btnStand'),
      double: document.getElementById('btnDouble'),
      cancel: document.getElementById('btnCancel'),
      input: document.getElementById('betAmount'),
      status: document.getElementById('betStatus'),
      msg: document.getElementById('resultMsg')
    };

    // Card Logic
    function buildDeck(){
      const s=['‚ô†','‚ô•','‚ô¶','‚ô£'], v=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      deck=[]; for(let S of s) for(let V of v) deck.push({s:S, v:V});
      deck.sort(()=>Math.random()-0.5);
    }
    function getVal(c){ if(c.v==='A') return 11; if(['J','Q','K'].includes(c.v)) return 10; return parseInt(c.v); }
    function getScore(h){
      let s=0, a=0; h.forEach(c=>{ s+=getVal(c); if(c.v==='A') a++; });
      while(s>21 && a>0){ s-=10; a--; } return s;
    }
    function renderCard(c, hide){
       if(hide) return `<div class="card bg-blue-900 border-2 border-white flex items-center justify-center reveal text-white">?</div>`;
       const col = (c.s==='‚ô•'||c.s==='‚ô¶')?'red':'black';
       return `<div class="card ${col} reveal"><span class="corner-val tl">${c.v}<br>${c.s}</span>${c.s}<span class="corner-val br">${c.v}<br>${c.s}</span></div>`;
    }
    function render(hideD=true){
      document.getElementById('dealerArea').innerHTML = dealerHand.map((c,i)=>renderCard(c, hideD && i===1)).join('');
      document.getElementById('playerArea').innerHTML = playerHand.map(c=>renderCard(c)).join('');
      document.getElementById('playerScore').textContent = getScore(playerHand);
      document.getElementById('dealerScore').textContent = hideD ? "?" : getScore(dealerHand);
    }
    function toggle(on){
      const bet = document.getElementById('bettingControls');
      const play = document.getElementById('playControls');
      if(on){ bet.classList.add('hidden'); bet.classList.remove('flex'); play.classList.remove('hidden'); play.classList.add('flex'); }
      else { play.classList.add('hidden'); play.classList.remove('flex'); bet.classList.remove('hidden'); bet.classList.add('flex'); }
    }
    function showRes(txt, type){
      const color = type==='win' ? 'bg-green-600' : type==='lose' ? 'bg-red-600' : 'bg-gray-600';
      ui.msg.innerHTML = `<div class="${color} text-white px-6 py-3 rounded shadow-lg border border-white pixel-font animate-bounce">${txt}</div>`;
      if(type==='win') confetti();
      setTimeout(()=>ui.msg.innerHTML='', 3000);
    }

    // Game Events
    ui.deal.addEventListener('click', async ()=>{
      if(!casinoContract) return toast("Connect Wallet", "error");
      const amt = parseInt(ui.input.value);
      if(!amt || amt<10) return toast("Min bet 10 PBJ", "error");
      
      ui.deal.textContent = "Wait..."; ui.deal.disabled = true;
      
      try {
        // 1. On Chain
        const raw = ethers.utils.parseUnits(amt.toString(), 18);
        const allow = await pbjContract.allowance(userAddress, casinoAddress);
        if(allow.lt(raw)) {
           ui.status.textContent = "Approving...";
           const txA = await pbjContract.approve(casinoAddress, ethers.constants.MaxUint256);
           await txA.wait();
        }
        
        ui.status.textContent = "Placing Bet...";
        const tx = await casinoContract.placeBet(raw);
        await tx.wait();
        
        // 2. Local Game
        buildDeck();
        playerHand=[deck.pop(), deck.pop()];
        dealerHand=[deck.pop(), deck.pop()];
        gameActive=true;
        document.getElementById('activeBetDisplay').textContent = amt;
        
        render(true);
        toggle(true);
        ui.status.textContent = "Your Turn";
        ui.hit.disabled = false; ui.stand.disabled = false; ui.double.disabled = false; ui.cancel.disabled = false;
        
        if(getScore(playerHand)===21) {
          showRes("Blackjack!", "win");
          await casinoContract.finishGame(true);
          endGame();
        }

      } catch(e){
        console.error(e);
        toast("Bet Failed", "error");
      } finally {
        ui.deal.textContent = "DEAL"; ui.deal.disabled = false;
      }
    });

    ui.hit.addEventListener('click', ()=>{
      playerHand.push(deck.pop());
      ui.double.disabled = true;
      render(true);
      if(getScore(playerHand)>21){ showRes("Bust!", "lose"); finishChain(false); endGame(); }
    });

    ui.stand.addEventListener('click', async ()=>{
      ui.hit.disabled=true; ui.stand.disabled=true;
      render(false);
      while(getScore(dealerHand)<17){
        await new Promise(r=>setTimeout(r,800));
        dealerHand.push(deck.pop());
        render(false);
      }
      const p = getScore(playerHand), d = getScore(dealerHand);
      if(d>21 || p>d) { showRes("You Win!", "win"); finishChain(true); }
      else if(p===d) { showRes("Push", "push"); finishChain(false); }
      else { showRes("House Wins", "lose"); finishChain(false); }
      endGame();
    });

    ui.cancel.addEventListener('click', async ()=>{
      try {
        ui.status.textContent = "Cancelling...";
        const tx = await casinoContract.cancelBet();
        await tx.wait();
        toast("Bet Cancelled", "success");
        endGame();
      } catch(e){ toast("Cancel failed", "error"); }
    });

    async function finishChain(win){
      try {
         const tx = await casinoContract.finishGame(win);
         await tx.wait();
         updatePBJBalance();
      } catch(e){}
    }

    function endGame(){
      gameActive=false;
      toggle(false);
      ui.status.textContent = "Idle";
    }

    // Init
    document.getElementById('connectBtn').addEventListener('click', connectFlow);
    
    // Timer UI
    setInterval(()=>{
      const el = document.getElementById('presale-countdown');
      if(!el) return;
      const diff = Math.max(0, (presaleStart + PRESALE_DURATION_MS) - Date.now());
      const d = Math.floor(diff/86400000);
      const h = Math.floor((diff%86400000)/3600000);
      el.textContent = diff>0 ? `${d}d ${h}h Left` : "Ended";
    }, 1000);

  </script>
</body>
</html>
