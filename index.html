<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>PBJ - The Pepe Miner Casino</title>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Chart.js for Crash Game (New) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Rajdhani', 'monospace'] },
          colors: { bg: '#050505', surface: '#141414', primary: '#39FF14', gold: '#FFD700', danger: '#FF4949' },
          animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
        }
      }
    }
  </script>

  <style>
    body { background: #050505 url('assets/img/bg-cave.png') fixed cover; color: #e2e8f0; font-family: 'Inter'; }
    
    /* Dust Particles */
    .dust { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; background: url('https://assets.codepen.io/1462889/fog.png') repeat-x; animation: fog 60s linear infinite; opacity: 0.3; }
    @keyframes fog { 0% { background-position: 0 0; } 100% { background-position: 1000px 0; } }

    /* Custom Scroll & UI */
    ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #39FF14; border-radius: 5px; }
    .glass-panel { background: rgba(10,10,10,0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    .btn-primary { background: linear-gradient(180deg, #39FF14 0%, #228b22 100%); color: black; font-weight: 800; transition: 0.2s; border: 1px solid #39FF14; text-transform: uppercase; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 25px rgba(57,255,20,0.4); }
    .btn-primary:disabled { background: #333; border-color: #444; color: #666; cursor: not-allowed; }
    
    /* Game Specifics */
    .mine-cell { aspect-ratio: 1; background: #222; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: 0.2s; border: 1px solid #333; }
    .mine-cell:hover { background: #333; border-color: #39FF14; }
    .fly-money { position: fixed; z-index: 9999; color: #39FF14; font-family: 'Rajdhani'; font-weight: 800; font-size: 1.5rem; pointer-events: none; text-shadow: 0 0 10px #39FF14; transition: 1s ease-in-out; }
  </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-primary selection:text-black">

  <div class="dust"></div> <!-- Atmosphere Effect -->
  <div id="toast-container" class="fixed bottom-5 right-5 z-[10000] flex flex-col gap-2"></div>

  <!-- GAME MODAL -->
  <div id="gameModal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[9990] hidden items-center justify-center p-2 md:p-6">
    <div class="bg-[#0a0a0a] w-full max-w-6xl h-[90vh] rounded-2xl border border-[#222] flex flex-col md:flex-row overflow-hidden shadow-2xl relative">
        
        <!-- LEFT: GAME -->
        <div class="flex-1 flex flex-col h-full relative">
            <div class="bg-[#111] p-4 flex justify-between items-center border-b border-[#222]">
                <div class="flex items-center gap-3 text-primary font-mono text-xl font-bold"><i class="fas fa-gamepad"></i> <span id="modalTitle">GAME</span></div>
                <button onclick="closeGame()" class="md:hidden text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Game Canvas Area -->
            <div class="flex-1 bg-[#050505] relative flex items-center justify-center overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#39FF14 1px, transparent 1px); background-size: 40px 40px;"></div>
                <div id="innerGameContent" class="relative z-10 w-full h-full flex flex-col items-center justify-center p-4">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-[#111] p-4 border-t border-[#222]">
                <div id="gameStatus" class="text-center text-xs font-mono text-gray-500 mb-2 tracking-widest">WAITING FOR INPUT</div>
                <div class="flex flex-col gap-3 max-w-2xl mx-auto w-full">
                    <div id="gameExtraControls" class="hidden flex gap-2 justify-center w-full"></div>
                    
                    <div class="grid grid-cols-[1fr_auto] gap-3">
                        <div class="relative group">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-primary"><i class="fas fa-coins"></i></div>
                            <input type="number" id="gameBetInput" value="100" class="w-full bg-[#050505] border border-[#333] rounded py-3 pl-9 pr-16 text-white font-mono font-bold focus:border-primary outline-none transition" placeholder="0.00">
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                <button onclick="adjustBet(0.5)" class="text-[10px] bg-[#222] px-2 py-1 rounded hover:bg-[#333] text-gray-400">¬Ω</button>
                                <button onclick="adjustBet(2)" class="text-[10px] bg-[#222] px-2 py-1 rounded hover:bg-[#333] text-gray-400">2x</button>
                                <button onclick="setMaxBet()" class="text-[10px] bg-[#222] px-2 py-1 rounded hover:bg-[#333] text-gold">MAX</button>
                            </div>
                        </div>
                        <button id="gameActionBtn" class="btn-primary px-8 min-w-[120px] shadow-[0_0_20px_rgba(57,255,20,0.2)]">PLAY</button>
                    </div>
                    <div class="flex justify-between text-[10px] font-mono text-gray-500">
                        <span>BAL: <span id="modalBalance" class="text-white">0</span> PBJ</span>
                        <span id="modeIndicator" class="text-primary">REAL MODE</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: INFO SIDEBAR -->
        <div class="w-80 bg-[#0f0f0f] border-l border-[#222] hidden md:flex flex-col relative">
            <button onclick="closeGame()" class="absolute top-4 right-4 text-gray-600 hover:text-white"><i class="fas fa-times"></i></button>
            <div class="p-6">
                <h3 class="text-gold font-bold font-mono mb-4 text-sm border-b border-[#222] pb-2">MANUAL</h3>
                <p id="sideTutText" class="text-gray-400 text-xs leading-relaxed mb-6">...</p>
                
                <h3 class="text-white font-bold font-mono mb-2 text-sm">STATS</h3>
                <div class="bg-[#161616] rounded p-3 border border-[#222] space-y-2 mb-6">
                    <div class="flex justify-between text-xs"><span class="text-gray-500">RTP</span><span class="text-primary">98.5%</span></div>
                    <div class="flex justify-between text-xs"><span class="text-gray-500">Max Win</span><span class="text-white">‚àû</span></div>
                </div>

                <h3 class="text-white font-bold font-mono mb-2 text-sm">SESSION LOG</h3>
                <div id="sessionLog" class="h-48 overflow-y-auto space-y-1 pr-1 text-[10px] font-mono text-gray-500">
                    <div class="text-center italic opacity-50 mt-4">No games played yet</div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- NAVIGATION -->
  <nav class="h-16 bg-black/80 backdrop-blur-md border-b border-[#222] flex items-center justify-between px-4 sticky top-0 z-50">
      <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-primary rounded flex items-center justify-center font-bold text-black shadow-[0_0_10px_#39FF14]">P</div>
          <span class="hidden md:block text-white font-bold text-xl font-mono tracking-tight">PEPE<span class="text-primary">.MINER</span></span>
      </div>
      <div class="flex items-center gap-4">
         <div class="hidden md:flex bg-[#111] px-4 py-1.5 rounded border border-[#333] gap-3 items-center">
            <div class="flex flex-col items-end leading-none">
                <span class="text-[10px] text-gray-500">BALANCE</span>
                <span id="headerBalance" class="text-white font-mono font-bold">0.00</span>
            </div>
            <div class="w-px h-6 bg-[#333]"></div>
            <span class="text-primary font-bold text-xs">PBJ</span>
        </div>
        <button id="connectBtn" class="btn-primary px-5 py-2 text-xs font-bold rounded shadow-lg"><i class="fas fa-link mr-2"></i> CONNECT</button>
      </div>
  </nav>

  <main class="flex-1 max-w-[1400px] mx-auto w-full pb-20 px-2 md:px-6">
      
      <!-- HERO SECTION -->
      <section id="hero" class="py-8">
          <div class="relative rounded-2xl overflow-hidden bg-[#0a0a0a] border border-[#222] grid md:grid-cols-2 gap-8 shadow-2xl group">
              <div class="absolute inset-0 bg-[url('assets/img/hero-pepe.jpg')] bg-cover bg-center opacity-40 transition duration-700 group-hover:scale-105"></div>
              <div class="absolute inset-0 bg-gradient-to-r from-black via-black/90 to-transparent"></div>
              
              <div class="p-8 pt-12 relative z-10 space-y-6">
                  <div class="inline-flex items-center gap-2 bg-gold/10 text-gold border border-gold/30 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">
                      <span class="w-2 h-2 bg-gold rounded-full animate-pulse"></span> Phase 1: Excavation
                  </div>
                  <h1 class="text-4xl md:text-6xl font-bold text-white leading-none font-mono">DIG FOR <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-emerald-500">ETERNAL GLORY</span></h1>
                  <p class="text-gray-400 max-w-md text-sm leading-relaxed">The deepest liquidity mine on Base. Hire NFT crews, stake your claim, and play provably fair games to unearth massive yields.</p>
                  <div class="flex gap-3 pt-2">
                      <a href="#games" class="btn-primary px-8 py-3 text-sm rounded shadow-[0_0_20px_rgba(57,255,20,0.3)]">START MINING</a>
                      <a href="#demo-games" class="px-8 py-3 text-sm font-bold text-white border border-[#444] rounded hover:bg-[#222] transition">R&D LAB</a>
                  </div>
              </div>

              <!-- SWAP WIDGET -->
              <div class="relative z-10 flex items-center justify-center p-8">
                  <div class="bg-[#050505]/90 backdrop-blur p-6 rounded-xl border border-[#333] w-full max-w-sm shadow-2xl">
                      <div class="flex justify-between items-center mb-6 border-b border-[#222] pb-4">
                          <h3 class="text-white font-bold font-mono">PRESALE EXCHANGE</h3>
                          <div class="text-[10px] text-primary animate-pulse">‚óè LIVE</div>
                      </div>
                      <div class="space-y-4">
                          <div class="space-y-1">
                              <div class="flex justify-between text-[10px] text-gray-500 font-bold"><span>PAY (ETH)</span><span>BAL: --</span></div>
                              <input type="number" id="buyInput" class="w-full bg-[#111] border border-[#333] rounded p-3 text-white font-mono font-bold focus:border-primary outline-none transition" placeholder="0.1">
                          </div>
                          <div class="flex justify-center -my-3 relative z-10"><div class="bg-[#222] border border-[#333] rounded-full p-1"><i class="fas fa-arrow-down text-gray-500 text-xs"></i></div></div>
                          <div class="space-y-1">
                              <div class="flex justify-between text-[10px] text-gray-500 font-bold"><span>RECEIVE (PBJ)</span></div>
                              <input type="number" id="receiveInput" class="w-full bg-[#111] border border-[#333] rounded p-3 text-primary font-mono font-bold focus:border-primary outline-none transition" placeholder="0">
                          </div>
                          <button id="buyBtn" class="w-full btn-primary py-3 font-bold text-sm mt-2">MINT TOKENS</button>
                      </div>
                  </div>
              </div>
          </div>
      </section>

      <!-- GAMES GRID -->
      <section id="games" class="py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white font-mono flex items-center gap-2"><i class="fas fa-dungeon text-primary"></i> MINING SHAFT <span class="text-xs bg-[#222] text-gray-400 px-2 py-1 rounded ml-2">REAL MODE</span></h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Games -->
            <div onclick="openGame('crash', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative">
                <div class="absolute top-2 right-2 bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded z-10">HOT</div>
                <img src="assets/img/game-crash.png" class="w-full h-48 object-cover opacity-60 group-hover:opacity-100 transition duration-500" onerror="this.src='https://placehold.co/400x300/111/333?text=CRASH'">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black p-4"><h3 class="text-white font-bold font-mono">ROCKET CART</h3><p class="text-[10px] text-gray-400">Going Up!</p></div>
            </div>
            <div onclick="openGame('mines', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative">
                <img src="assets/img/game-mines.png" class="w-full h-48 object-cover opacity-60 group-hover:opacity-100 transition duration-500" onerror="this.src='https://placehold.co/400x300/111/333?text=MINES'">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black p-4"><h3 class="text-white font-bold font-mono">MINEFIELD</h3><p class="text-[10px] text-gray-400">Watch your step</p></div>
            </div>
            <div onclick="openGame('slots', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative">
                <img src="assets/img/game-slots.png" class="w-full h-48 object-cover opacity-60 group-hover:opacity-100 transition duration-500" onerror="this.src='https://placehold.co/400x300/111/333?text=SLOTS'">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black p-4"><h3 class="text-white font-bold font-mono">GEM SLOTS</h3><p class="text-[10px] text-gray-400">Spin for Gold</p></div>
            </div>
            <div onclick="openGame('plinko', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative">
                <img src="assets/img/game-plinko.png" class="w-full h-48 object-cover opacity-60 group-hover:opacity-100 transition duration-500" onerror="this.src='https://placehold.co/400x300/111/333?text=PLINKO'">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black p-4"><h3 class="text-white font-bold font-mono">GEM DROP</h3><p class="text-[10px] text-gray-400">Let it fall</p></div>
            </div>
        </div>
      </section>

      <!-- STAKING & INVENTORY (REVERSED LAYOUT) -->
      <section id="staking" class="py-8 grid md:grid-cols-2 gap-8">
          <!-- LEFT: STATS -->
          <div class="bg-[#111] border border-[#222] rounded-xl p-6 flex flex-col justify-between h-full relative overflow-hidden">
              <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 blur-[60px]"></div>
              <div>
                  <h2 class="text-xl font-bold text-white font-mono mb-1">CONTROL CENTER</h2>
                  <p class="text-xs text-gray-500 mb-6">Manage yields and mining efficiency.</p>
                  
                  <div class="space-y-4">
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#222] flex justify-between items-center">
                          <span class="text-gray-500 text-xs font-bold">ACTIVE MINERS</span>
                          <span id="total-staked" class="text-white font-bold font-mono text-xl">0</span>
                      </div>
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#222] flex justify-between items-center">
                          <span class="text-gray-500 text-xs font-bold">MINING RATE</span>
                          <span id="daily-yield" class="text-primary font-bold font-mono text-xl">0/hr</span>
                      </div>
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#333] border-l-4 border-l-primary shadow-lg">
                          <span class="text-gray-500 text-[10px] font-bold uppercase block mb-1">Unclaimed Ore</span>
                          <span id="pending-rewards" class="text-gold font-mono font-bold text-3xl">0.0000</span>
                          <span class="text-xs text-gray-600 ml-1">PBJ</span>
                      </div>
                  </div>
              </div>
              <button onclick="claimRewards()" class="w-full mt-6 btn-primary py-4 text-sm rounded shadow-lg">CLAIM REWARDS</button>
          </div>

          <!-- RIGHT: INVENTORY -->
          <div class="bg-[#111] border border-[#222] rounded-xl p-6 h-[500px] flex flex-col">
              <div class="flex justify-between items-center mb-4 border-b border-[#222] pb-4">
                  <h2 class="text-xl font-bold text-white font-mono">MINER BARRACKS</h2>
                  <button onclick="loadUserData()" class="w-8 h-8 rounded bg-[#222] hover:bg-[#333] text-gray-400 hover:text-white transition"><i class="fas fa-sync-alt"></i></button>
              </div>
              <div id="inventory-list" class="flex-1 overflow-y-auto pr-2 space-y-2 custom-scroll">
                  <div class="h-full flex flex-col items-center justify-center text-gray-600 gap-2">
                      <i class="fas fa-lock text-2xl"></i>
                      <span class="text-xs font-mono">CONNECT WALLET TO VIEW</span>
                  </div>
              </div>
          </div>
      </section>

      <!-- PARTNERS -->
      <section id="partners" class="py-8 pb-20">
          <h2 class="text-xl font-bold text-white mb-6 font-mono">MINING GUILD (AFFILIATES)</h2>
          <div id="partner-unlocked" class="hidden grid md:grid-cols-3 gap-6">
              <div class="md:col-span-2 bg-[#111] border border-[#222] rounded-xl p-6">
                  <h3 class="text-white font-bold mb-4 text-sm">YOUR RECRUITMENT LINK</h3>
                  <div class="flex items-center gap-4 bg-[#050505] p-3 rounded border border-[#333]">
                      <input type="text" id="refLinkInput" readonly class="w-full bg-transparent text-gray-300 text-sm outline-none font-mono" value="https://pbj.bet/?ref=0x...">
                      <button onclick="copyRefLink()" class="text-primary hover:text-white text-xs font-bold px-4">COPY</button>
                  </div>
                  <div class="grid grid-cols-3 gap-4 mt-6">
                      <div class="bg-[#0a0a0a] p-3 rounded text-center border border-[#222]"><div class="text-[10px] text-gray-500 uppercase">Recruits</div><div class="text-white font-bold text-xl">0</div></div>
                      <div class="bg-[#0a0a0a] p-3 rounded text-center border border-[#222]"><div class="text-[10px] text-gray-500 uppercase">Active</div><div class="text-primary font-bold text-xl">0</div></div>
                      <div class="bg-[#0a0a0a] p-3 rounded text-center border border-[#222]"><div class="text-[10px] text-gray-500 uppercase">Earned</div><div class="text-gold font-bold text-xl">0.00</div></div>
                  </div>
              </div>
              <div class="bg-[#111] border border-[#222] rounded-xl p-6">
                  <h3 class="text-white font-bold mb-4 text-sm">COMMISSION RATES</h3>
                  <div class="space-y-2">
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded border border-primary/30"><span class="text-primary font-bold">Tier 1</span><span class="text-white">15%</span></div>
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded opacity-50"><span class="text-gray-500">Tier 2</span><span class="text-gray-500">5%</span></div>
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded opacity-50"><span class="text-gray-500">Tier 3</span><span class="text-gray-500">2%</span></div>
                  </div>
              </div>
          </div>
          <div id="partner-locked" class="bg-[#111] border border-dashed border-[#333] rounded-xl p-12 text-center">
              <i class="fas fa-user-lock text-4xl text-gray-700 mb-4"></i>
              <h3 class="text-white font-bold font-mono">ACCESS RESTRICTED</h3>
              <p class="text-gray-500 text-sm mb-4">Connect your pickaxe (wallet) to access the guild.</p>
          </div>
      </section>

  </main>

  <!-- LOGIC -->
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    // --- CONFIG ---
    const BASE_CHAIN_ID = '0x2105'; // 8453
    const ADDR = { TOKEN: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", PRESALE: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", INSTANT: "0xbcF9DFfcDaDeC818F7B653aF1a7Ff287F3e7011f" };
    const ABIS = { TOKEN: ["function approve(address, uint256) external returns (bool)", "function balanceOf(address) external view returns (uint256)"], PRESALE: ["function buyTokens() payable"], INSTANT: ["function playSlots(uint256) external", "function playCrash(uint256, uint256) external", "function playMines(uint256, uint256) external"] };
    
    let provider, signer, address, contracts = {}, currentGame = null, isDemo = false;
    let miningInterval = null;

    // --- UTILS ---
    const playSound = (id) => { const el = document.getElementById(`sfx-${id}`); if(el) { el.volume=0.3; el.currentTime=0; el.play().catch(()=>{}); }};
    const toast = (msg, type='success') => { 
        const t = document.createElement('div'); t.className = `px-4 py-2 text-xs font-mono font-bold text-black rounded shadow-lg mb-2 ${type==='error'?'bg-red-500':'bg-primary'}`; t.innerText = `> ${msg}`; 
        document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 3000);
    };
    document.body.addEventListener('click', (e) => { if(e.target.closest('button')) playSound('click'); });

    // --- WALLET & NETWORK ---
    document.getElementById('connectBtn').addEventListener('click', async () => {
        if(!window.ethereum) return alert("Install Metamask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            // Network Check
            const { chainId } = await provider.getNetwork();
            if(chainId !== 8453) {
                try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_CHAIN_ID }] }); } 
                catch (e) { toast("Please switch to Base Network", "error"); return; }
            }

            signer = provider.getSigner();
            address = await signer.getAddress();
            
            // Contracts Setup
            contracts.token = new ethers.Contract(ADDR.TOKEN, ABIS.TOKEN, signer);
            contracts.presale = new ethers.Contract(ADDR.PRESALE, ABIS.PRESALE, signer);
            contracts.instant = new ethers.Contract(ADDR.INSTANT, ABIS.INSTANT, signer);

            document.getElementById('connectBtn').innerText = address.substring(0,6)+"...";
            updateUI(); loadUserData(); unlockPartners();
            localStorage.setItem('walletConnected', 'true');
            toast("SYSTEM ONLINE");
        } catch(e) { console.error(e); toast("Connection Failed", "error"); }
    });

    // Auto-connect if previously connected
    if(localStorage.getItem('walletConnected')) document.getElementById('connectBtn').click();

    async function updateUI() {
        if(!contracts.token) return;
        try {
            const bal = await contracts.token.balanceOf(address);
            const fmt = Math.floor(parseFloat(ethers.utils.formatUnits(bal, 18)));
            document.getElementById('headerBalance').innerText = fmt.toLocaleString();
            document.getElementById('modalBalance').innerText = fmt.toLocaleString();
        } catch(e) {}
    }

    // --- PARTNERS ---
    function unlockPartners() {
        document.getElementById('partner-locked').classList.add('hidden');
        document.getElementById('partner-unlocked').classList.remove('hidden');
        document.getElementById('partner-unlocked').classList.add('grid');
        document.getElementById('refLinkInput').value = `${window.location.origin}?ref=${address}`;
    }
    window.copyRefLink = () => {
        const el = document.getElementById('refLinkInput'); el.select(); navigator.clipboard.writeText(el.value);
        toast("LINK COPIED");
    };

    // --- CALCULATOR ---
    const RATE = 1500000;
    document.getElementById('buyInput').addEventListener('input', (e) => { const v = parseFloat(e.target.value); document.getElementById('receiveInput').value = isNaN(v) ? '' : (v * RATE).toFixed(0); });
    document.getElementById('receiveInput').addEventListener('input', (e) => { const v = parseFloat(e.target.value); document.getElementById('buyInput').value = isNaN(v) ? '' : (v / RATE).toFixed(6); });
    document.getElementById('buyBtn').addEventListener('click', async () => {
        if(!signer) return toast("CONNECT WALLET", "error");
        const val = document.getElementById('buyInput').value;
        try { 
            const tx = await contracts.presale.buyTokens({ value: ethers.utils.parseEther(val), gasLimit: 500000 });
            toast("TX SENT: MINTING..."); await tx.wait(); toast("TOKENS RECEIVED!"); updateUI();
        } catch(e) { toast("TX FAILED", "error"); }
    });

    // --- GAME ENGINE ---
    window.openGame = (game, demo) => {
        currentGame = game; isDemo = demo;
        document.getElementById('gameModal').classList.remove('hidden');
        document.getElementById('gameModal').classList.add('flex');
        document.getElementById('modalTitle').innerText = game.toUpperCase();
        document.getElementById('gameStatus').innerText = "READY";
        
        const content = document.getElementById('innerGameContent');
        content.innerHTML = ''; // Clear previous

        if(game === 'crash') {
            // Initialize Canvas for Crash
            content.innerHTML = `<div class="relative w-full h-full flex items-center justify-center"><canvas id="crashCanvas" class="w-full h-full"></canvas><div id="crashMultiplier" class="absolute text-6xl font-bold text-white font-mono">1.00x</div></div>`;
        } else if (game === 'slots') {
            content.innerHTML = `<div class="flex gap-2 text-6xl"><div class="slot-reel">üíé</div><div class="slot-reel">üíé</div><div class="slot-reel">üíé</div></div>`;
        } else {
            content.innerHTML = `<div class="text-4xl text-gray-600 font-mono">PRESS PLAY</div>`;
        }
        
        document.getElementById('modeIndicator').innerText = demo ? "TEST MODE" : "REAL MODE";
        document.getElementById('modeIndicator').className = demo ? "text-blue-400" : "text-primary";
    };

    window.closeGame = () => { document.getElementById('gameModal').classList.add('hidden'); document.getElementById('gameModal').classList.remove('flex'); };
    window.adjustBet = (m) => { const el = document.getElementById('gameBetInput'); el.value = (parseFloat(el.value) * m).toFixed(2); };
    window.setMaxBet = () => { document.getElementById('gameBetInput').value = 1000; };

    document.getElementById('gameActionBtn').addEventListener('click', async () => {
        const btn = document.getElementById('gameActionBtn');
        if(!signer && !isDemo) return toast("CONNECT WALLET", "error");
        
        btn.disabled = true; btn.innerText = isDemo ? "COMPUTING..." : "MINING...";
        playSound('spin');

        if(currentGame === 'crash') playCrashAnim(); // Trigger visual graph

        setTimeout(() => {
            const win = Math.random() > 0.5;
            const amount = parseFloat(document.getElementById('gameBetInput').value) * 2;
            
            if(win) {
                playSound('win'); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#39FF14'] });
                animateWin(amount);
                document.getElementById('gameStatus').innerText = "YOU WON!";
                addToLog(currentGame, amount, true);
            } else {
                playSound('lose');
                document.getElementById('gameStatus').innerText = "TRY AGAIN";
                addToLog(currentGame, 0, false);
            }
            btn.disabled = false; btn.innerText = "PLAY";
            if(!isDemo) updateUI();
        }, 2000);
    });

    // --- ANIMATIONS ---
    function playCrashAnim() {
        // Simple placeholder for chart animation
        const el = document.getElementById('crashMultiplier');
        if(!el) return;
        let val = 1.00;
        const int = setInterval(() => {
            val += 0.05;
            el.innerText = val.toFixed(2) + "x";
            if(val > 2.00) clearInterval(int); // Stop for demo
        }, 50);
    }

    function animateWin(amount) {
        const flyer = document.createElement('div');
        flyer.className = 'fly-money';
        flyer.innerText = `+${amount}`;
        flyer.style.left = '50%'; flyer.style.top = '50%';
        document.body.appendChild(flyer);
        setTimeout(() => {
            flyer.style.top = '5%'; flyer.style.left = '80%'; flyer.style.opacity = '0';
            setTimeout(() => flyer.remove(), 1000);
        }, 100);
    }

    function addToLog(game, amount, win) {
        const log = document.getElementById('sessionLog');
        const item = document.createElement('div');
        item.className = `flex justify-between ${win ? 'text-primary' : 'text-red-500'}`;
        item.innerHTML = `<span>${game.toUpperCase()}</span><span>${win ? '+' : '-'}${amount}</span>`;
        log.prepend(item);
    }

    // --- STAKING TICKER ---
    window.loadUserData = () => {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        // Mock Inventory
        const items = [
            { name: "ROOKIE #420", type: "Common", color: "text-gray-400" },
            { name: "KING #001", type: "Legendary", color: "text-gold" }
        ];
        items.forEach(item => {
            list.innerHTML += `
                <div class="flex justify-between items-center bg-[#1a1a1a] p-3 rounded border-l-2 ${item.type === 'Legendary' ? 'border-gold' : 'border-gray-500'}">
                    <span class="text-xs text-white font-bold">${item.name}</span>
                    <span class="text-[10px] ${item.color} animate-pulse">MINING...</span>
                </div>`;
        });

        document.getElementById('total-staked').innerText = "2 MINERS";
        document.getElementById('daily-yield').innerText = "2,050 PBJ/d";

        if(miningInterval) clearInterval(miningInterval);
        let pending = 12.4500;
        miningInterval = setInterval(() => {
            pending += 0.0004;
            document.getElementById('pending-rewards').innerText = pending.toFixed(4);
        }, 100);
    };

    window.claimRewards = () => {
        toast("REWARDS SENT TO WALLET");
        document.getElementById('pending-rewards').innerText = "0.0000";
    };

  </script>
</body>
</html>
