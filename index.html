<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PBJ - The Pepe Miner Casino</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Rajdhani', 'monospace'] },
          colors: { 
            bg: '#050505', sidebar: '#0a0a0a', surface: '#141414', 
            primary: '#39FF14', gold: '#FFD700', danger: '#FF4949' 
          },
          animation: { 'pulse-glow': 'pulse-glow 2s infinite' },
          keyframes: { 'pulse-glow': { '0%, 100%': { boxShadow: '0 0 5px #39FF14' }, '50%': { boxShadow: '0 0 20px #39FF14' } } }
        }
      }
    }
  </script>

  <!-- Global Styles -->
  <style>
    body { 
        background-color: #050505; color: #e2e8f0; 
        background-image: radial-gradient(circle at 50% 50%, #111 0%, #050505 100%);
    }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #050505; }
    ::-webkit-scrollbar-thumb { background: #39FF14; border-radius: 10px; }

    /* Elements */
    .glass-panel { background: rgba(20,20,20,0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
    .btn-primary { 
        background: linear-gradient(180deg, #39FF14 0%, #228b22 100%); color: black; 
        font-weight: 800; text-transform: uppercase; border-radius: 4px; transition: 0.2s;
        box-shadow: 0 0 10px rgba(57,255,20,0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(57,255,20,0.6); }
    .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
    
    .card-visual { width: 50px; height: 70px; background: white; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; color: black; }
    .card-red { color: #e53e3e; }
    
    /* Effects */
    .fly-money { position: fixed; z-index: 9999; color: #39FF14; font-family: 'Rajdhani'; font-weight: 800; font-size: 1.5rem; pointer-events: none; text-shadow: 0 0 10px #39FF14; transition: 1s ease-in-out; }
    .demo-ribbon { position: absolute; top: 12px; right: -30px; background: #FFD700; color: black; font-weight: bold; font-size: 10px; padding: 2px 30px; transform: rotate(45deg); z-index: 20; }
  </style>
</head>
<body class="flex h-screen overflow-hidden">

  <div id="toast-container" class="fixed bottom-5 right-5 z-[10000] flex flex-col gap-2"></div>

  <!-- GAME MODAL -->
  <div id="gameModal" class="fixed inset-0 bg-black/95 backdrop-blur-md z-[9990] hidden items-center justify-center p-2 md:p-6">
    <div class="bg-[#0a0a0a] w-full max-w-6xl h-[90vh] rounded-2xl border border-[#333] flex flex-col md:flex-row overflow-hidden relative shadow-2xl">
        <!-- LEFT: Game -->
        <div class="flex-1 flex flex-col h-full relative">
            <div class="bg-[#111] p-4 flex justify-between items-center border-b border-[#222]">
                <h2 class="text-primary font-bold text-xl font-mono"><i class="fas fa-gamepad mr-2"></i> <span id="modalTitle">GAME</span></h2>
                <button onclick="closeGame()" class="md:hidden text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 bg-[#050505] relative flex items-center justify-center overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#39FF14 1px, transparent 1px); background-size: 40px 40px;"></div>
                <div id="innerGameContent" class="relative z-10 w-full h-full flex flex-col items-center justify-center p-4"></div>
            </div>
            <div class="bg-[#111] p-4 border-t border-[#222]">
                <div id="gameStatus" class="text-center text-xs font-mono text-gray-500 mb-2 tracking-widest">READY</div>
                <div class="flex flex-col gap-3 max-w-2xl mx-auto">
                    <div id="gameExtraControls" class="hidden flex gap-2 justify-center w-full"></div>
                    <div class="grid grid-cols-[1fr_auto] gap-3">
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"><i class="fas fa-coins"></i></div>
                            <input type="number" id="gameBetInput" value="100" class="w-full bg-[#050505] border border-[#333] rounded py-3 pl-9 pr-16 text-white font-mono font-bold focus:border-primary outline-none" placeholder="Bet">
                            <button onclick="setMaxBet()" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] bg-[#222] text-gold px-2 py-1 rounded hover:bg-[#333]">MAX</button>
                        </div>
                        <button id="gameActionBtn" class="btn-primary px-8 min-w-[120px]">PLAY</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- RIGHT: Sidebar -->
        <div class="w-80 bg-[#0f0f0f] border-l border-[#222] hidden md:flex flex-col p-6">
            <button onclick="closeGame()" class="absolute top-4 right-4 text-gray-600 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-gold font-bold font-mono mb-4 text-sm border-b border-[#222] pb-2">MANUAL</h3>
            <p id="sideTutText" class="text-gray-400 text-xs leading-relaxed mb-6">...</p>
            <h3 class="text-white font-bold font-mono mb-2 text-sm">STATS</h3>
            <div class="bg-[#161616] rounded p-3 border border-[#222] mb-6 text-xs">
                <div class="flex justify-between mb-2"><span class="text-gray-500">RTP</span><span class="text-primary">98.5%</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Max Win</span><span class="text-white">1000x</span></div>
            </div>
            <div id="sessionLog" class="flex-1 overflow-y-auto text-[10px] font-mono text-gray-500 space-y-1"></div>
        </div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="h-16 bg-black/90 backdrop-blur border-b border-[#222] flex items-center justify-between px-4 fixed w-full top-0 z-50">
      <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-primary rounded flex items-center justify-center font-bold text-black shadow-[0_0_10px_#39FF14]">P</div>
          <span class="hidden md:block text-white font-bold text-xl font-mono">PEPE<span class="text-primary">.MINER</span></span>
      </div>
      <div class="flex items-center gap-4">
         <div class="hidden md:flex bg-[#111] px-4 py-1.5 rounded border border-[#333] gap-3 items-center">
            <div class="flex flex-col items-end leading-none">
                <span class="text-[10px] text-gray-500">BALANCE</span>
                <span id="headerBalance" class="text-white font-mono font-bold">0</span>
            </div>
            <div class="w-px h-6 bg-[#333]"></div>
            <span class="text-primary font-bold text-xs">PBJ</span>
        </div>
        <button id="connectBtn" class="btn-primary px-5 py-2 text-xs font-bold"><i class="fas fa-wallet mr-2"></i> CONNECT</button>
      </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="flex-1 max-w-[1400px] mx-auto w-full pt-20 pb-20 px-4 space-y-16">
      
      <!-- 1. HERO & PRESALE -->
      <section id="hero" class="grid md:grid-cols-2 gap-12 items-center">
          <div class="space-y-6">
              <div class="inline-flex items-center gap-2 bg-gold/10 text-gold border border-gold/30 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">
                  <span class="w-2 h-2 bg-gold rounded-full animate-pulse"></span> Phase 1 Excavation
              </div>
              <h1 class="text-5xl md:text-7xl font-bold text-white leading-none font-mono">DIG FOR <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-emerald-500">GLORY</span></h1>
              <p class="text-gray-400 max-w-md text-sm leading-relaxed">Hire NFT crews, stake claim to the vault, and play provably fair games in the deepest mine on Base.</p>
              <div class="flex gap-4 pt-2">
                  <a href="#games" class="btn-primary px-8 py-3 text-sm rounded">START MINING</a>
                  <a href="#staking" class="px-8 py-3 text-sm font-bold text-white border border-[#444] rounded hover:bg-[#222]">THE VAULT</a>
              </div>
          </div>

          <!-- SWAP UI -->
          <div class="bg-[#0a0a0a] p-6 rounded-xl border border-[#333] shadow-2xl">
              <div class="flex justify-between items-center mb-6 border-b border-[#222] pb-4">
                  <h3 class="text-white font-bold font-mono">PRESALE EXCHANGE</h3>
                  <div class="text-[10px] text-primary animate-pulse">‚óè LIVE</div>
              </div>
              
              <!-- Tabs -->
              <div class="flex bg-[#111] p-1 rounded mb-4">
                  <button class="flex-1 py-1 text-xs font-bold bg-[#222] text-white rounded shadow">BUY</button>
                  <button class="flex-1 py-1 text-xs font-bold text-gray-600 cursor-not-allowed relative group">
                      SELL <i class="fas fa-lock ml-1"></i>
                      <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-red-900 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition">Locked until Launch</span>
                  </button>
              </div>

              <div class="space-y-4">
                  <div class="space-y-1">
                      <div class="flex justify-between text-[10px] text-gray-500 font-bold"><span>PAY (ETH)</span><span>BAL: --</span></div>
                      <input type="number" id="buyInput" class="w-full bg-[#111] border border-[#333] rounded p-3 text-white font-mono font-bold focus:border-primary outline-none" placeholder="0.1">
                  </div>
                  <div class="flex justify-center -my-3 relative z-10"><div class="bg-[#222] border border-[#333] rounded-full p-1"><i class="fas fa-arrow-down text-gray-500 text-xs"></i></div></div>
                  <div class="space-y-1">
                      <div class="flex justify-between text-[10px] text-gray-500 font-bold"><span>RECEIVE (PBJ)</span></div>
                      <input type="number" id="receiveInput" class="w-full bg-[#111] border border-[#333] rounded p-3 text-primary font-mono font-bold focus:border-primary outline-none" placeholder="0">
                  </div>
                  <button id="buyBtn" class="w-full btn-primary py-3 font-bold text-sm mt-2">MINT TOKENS</button>
              </div>
          </div>
      </section>

      <!-- 2. LORE & ROADMAP -->
      <section class="grid md:grid-cols-2 gap-8">
          <div class="glass-panel p-6 rounded-xl border border-[#333]">
              <h2 class="text-xl font-bold text-white mb-4 font-mono"><i class="fas fa-book text-gold mr-2"></i> THE LORE</h2>
              <p class="text-gray-400 text-sm leading-relaxed mb-4">Deep within the Base Chain bedrock, Pepe struck digital gold: $PBJ. He didn't just build a mine; he built an empire where every holder is a shareholder.</p>
              <div class="h-1 w-full bg-[#222] rounded overflow-hidden"><div class="h-full bg-primary w-[40%]"></div></div>
              <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>Progress</span><span>Phase 1/3</span></div>
          </div>
          <div class="glass-panel p-6 rounded-xl border border-[#333] overflow-y-auto h-48 custom-scroll">
              <h2 class="text-xl font-bold text-white mb-4 font-mono"><i class="fas fa-map-signs text-blue-400 mr-2"></i> ROADMAP</h2>
              <ul class="space-y-4 border-l border-[#333] pl-4 ml-2 text-sm text-gray-400">
                  <li class="relative"><span class="absolute -left-[21px] top-1 w-3 h-3 bg-primary rounded-full"></span> <strong>Phase 1:</strong> Presale, Audit, Beta Games.</li>
                  <li class="relative"><span class="absolute -left-[21px] top-1 w-3 h-3 bg-[#333] rounded-full"></span> <strong>Phase 2:</strong> NFT Mint, Staking V1, Marketing.</li>
                  <li class="relative"><span class="absolute -left-[21px] top-1 w-3 h-3 bg-[#333] rounded-full"></span> <strong>Phase 3:</strong> Metaverse Casino, Dividends.</li>
              </ul>
          </div>
      </section>

      <!-- 3. STAKING & INVENTORY (Requested Layout: Stats Left, Vault Right) -->
      <section id="staking" class="grid md:grid-cols-2 gap-8">
          <!-- LEFT: CONTROL PANEL -->
          <div class="bg-[#111] border border-[#222] rounded-xl p-6 flex flex-col justify-between h-full relative overflow-hidden">
              <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 blur-[60px]"></div>
              <div>
                  <h2 class="text-xl font-bold text-white font-mono mb-1">CONTROL CENTER</h2>
                  <p class="text-xs text-gray-500 mb-6">Manage yields and mining efficiency.</p>
                  <div class="space-y-4">
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#222] flex justify-between items-center">
                          <span class="text-gray-500 text-xs font-bold">ACTIVE MINERS</span>
                          <span id="total-staked" class="text-white font-bold font-mono text-xl">0</span>
                      </div>
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#222] flex justify-between items-center">
                          <span class="text-gray-500 text-xs font-bold">MINING RATE</span>
                          <span id="daily-yield" class="text-primary font-bold font-mono text-xl">0 PBJ/d</span>
                      </div>
                      <!-- Real-time Ticker -->
                      <div class="bg-[#0a0a0a] p-4 rounded border border-[#222] border-l-4 border-l-primary shadow-lg">
                          <div class="flex justify-between items-center mb-1">
                              <span class="text-gray-500 text-xs font-bold">UNCLAIMED ORE</span>
                              <span class="text-[10px] text-primary animate-pulse"><i class="fas fa-cog fa-spin mr-1"></i> MINING</span>
                          </div>
                          <div class="text-right">
                              <span id="pending-rewards" class="text-gold font-mono font-bold text-3xl">0.0000</span>
                              <span class="text-xs text-gray-600 ml-1">PBJ</span>
                          </div>
                      </div>
                  </div>
              </div>
              <button onclick="claimRewards()" class="w-full mt-6 btn-primary py-4 text-sm rounded shadow-lg">COLLECT YIELD</button>
          </div>

          <!-- RIGHT: INVENTORY VAULT -->
          <div class="bg-[#111] border border-[#222] rounded-xl p-6 h-[500px] flex flex-col">
              <div class="flex justify-between items-center mb-4 border-b border-[#222] pb-4">
                  <h2 class="text-xl font-bold text-white font-mono">THE VAULT (NFTs)</h2>
                  <button onclick="loadUserData()" class="text-xs bg-[#222] hover:bg-[#333] px-3 py-1 rounded text-white border border-[#444]"><i class="fas fa-sync mr-1 text-primary"></i></button>
              </div>
              <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2">
                  <div class="h-full flex flex-col items-center justify-center text-gray-600 gap-2">
                      <i class="fas fa-lock text-2xl"></i>
                      <span class="text-xs font-mono">CONNECT PICKAXE TO VIEW</span>
                  </div>
              </div>
          </div>
      </section>

      <!-- 4. GAMES LOBBY -->
      <section id="games">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white font-mono flex items-center gap-2"><i class="fas fa-dungeon text-primary"></i> MINING SHAFT <span class="text-xs bg-[#222] text-gray-400 px-2 py-1 rounded ml-2">REAL MODE</span></h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Game Cards (Using placeholders for structure reliability) -->
            <div onclick="openGame('crash', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative h-48">
                <div class="absolute inset-0 flex items-center justify-center bg-[#1a1a1a]"><i class="fas fa-rocket text-4xl text-gray-700 group-hover:text-primary transition"></i></div>
                <div class="absolute bottom-0 w-full bg-black p-3"><h3 class="text-white font-bold font-mono">CRASH</h3></div>
            </div>
            <div onclick="openGame('mines', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative h-48">
                <div class="absolute inset-0 flex items-center justify-center bg-[#1a1a1a]"><i class="fas fa-bomb text-4xl text-gray-700 group-hover:text-primary transition"></i></div>
                <div class="absolute bottom-0 w-full bg-black p-3"><h3 class="text-white font-bold font-mono">MINES</h3></div>
            </div>
            <div onclick="openGame('slots', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative h-48">
                <div class="absolute inset-0 flex items-center justify-center bg-[#1a1a1a]"><i class="fas fa-gem text-4xl text-gray-700 group-hover:text-primary transition"></i></div>
                <div class="absolute bottom-0 w-full bg-black p-3"><h3 class="text-white font-bold font-mono">SLOTS</h3></div>
            </div>
            <div onclick="openGame('plinko', false)" class="group cursor-pointer bg-[#111] rounded-xl overflow-hidden border border-[#222] hover:border-primary transition relative h-48">
                <div class="absolute inset-0 flex items-center justify-center bg-[#1a1a1a]"><i class="fas fa-circle text-4xl text-gray-700 group-hover:text-primary transition"></i></div>
                <div class="absolute bottom-0 w-full bg-black p-3"><h3 class="text-white font-bold font-mono">PLINKO</h3></div>
            </div>
        </div>
      </section>

      <!-- 5. DEMO GAMES -->
      <section id="demo-games" class="border-t border-[#222] pt-8">
        <div class="flex items-center gap-2 mb-6"><i class="fas fa-flask text-blue-400"></i> <h2 class="text-xl font-bold text-white font-mono">R&D SECTOR (DEMO)</h2></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div onclick="openGame('limbo', true)" class="group cursor-pointer bg-[#111] rounded-lg border border-[#222] hover:border-blue-400 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="demo-ribbon">DEMO</div>
                <span class="text-gray-500 group-hover:text-white font-bold font-mono">LIMBO</span>
            </div>
            <div onclick="openGame('hilo', true)" class="group cursor-pointer bg-[#111] rounded-lg border border-[#222] hover:border-blue-400 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="demo-ribbon">DEMO</div>
                <span class="text-gray-500 group-hover:text-white font-bold font-mono">HILO</span>
            </div>
            <div onclick="openGame('wheel', true)" class="group cursor-pointer bg-[#111] rounded-lg border border-[#222] hover:border-blue-400 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="demo-ribbon">DEMO</div>
                <span class="text-gray-500 group-hover:text-white font-bold font-mono">WHEEL</span>
            </div>
            <div onclick="openGame('poker', true)" class="group cursor-pointer bg-[#111] rounded-lg border border-[#222] hover:border-blue-400 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="demo-ribbon">DEMO</div>
                <span class="text-gray-500 group-hover:text-white font-bold font-mono">POKER</span>
            </div>
        </div>
      </section>

      <!-- 6. PARTNERS (ENHANCED) -->
      <section id="partners" class="bg-[#080808] rounded-xl border border-[#222] p-6">
          <h2 class="text-xl font-bold text-white mb-6 text-center font-mono">MINING GUILD (AFFILIATES)</h2>
          
          <!-- Locked State -->
          <div id="partner-locked" class="text-center py-10">
              <i class="fas fa-lock text-4xl text-gray-700 mb-4"></i>
              <h3 class="text-white font-bold">ACCESS RESTRICTED</h3>
              <p class="text-gray-500 text-sm mb-4">Connect wallet to see your stats.</p>
          </div>

          <!-- Unlocked State -->
          <div id="partner-unlocked" class="hidden grid md:grid-cols-2 gap-8">
              <!-- Link & Stats -->
              <div>
                  <h3 class="text-white font-bold mb-3 text-sm">YOUR RECRUITMENT LINK</h3>
                  <div class="flex items-center gap-2 bg-[#111] p-3 rounded border border-[#333] mb-6">
                      <input type="text" id="refLinkInput" readonly class="w-full bg-transparent text-gray-400 text-xs font-mono outline-none" value="https://pbj.bet/?ref=...">
                      <button onclick="copyRefLink()" class="text-primary text-xs font-bold hover:text-white">COPY</button>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4">
                      <div class="bg-[#111] p-3 rounded text-center border border-[#222]">
                          <div class="text-[10px] text-gray-500 uppercase">Total Recruits</div>
                          <div class="text-white font-bold text-lg">0</div>
                      </div>
                      <div class="bg-[#111] p-3 rounded text-center border border-[#222]">
                          <div class="text-[10px] text-gray-500 uppercase">Active Today</div>
                          <div class="text-primary font-bold text-lg">0</div>
                      </div>
                      <div class="bg-[#111] p-3 rounded text-center border border-[#222]">
                          <div class="text-[10px] text-gray-500 uppercase">Earned (PBJ)</div>
                          <div class="text-gold font-bold text-lg">0.00</div>
                      </div>
                  </div>
              </div>

              <!-- Tiers Info -->
              <div class="bg-[#111] p-4 rounded border border-[#222]">
                  <h3 class="text-white font-bold mb-4 text-sm">COMMISSION TIERS</h3>
                  <div class="space-y-2">
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded border-l-2 border-primary">
                          <span class="text-white">Level 1 (Direct)</span>
                          <span class="text-primary font-bold">15%</span>
                      </div>
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded border-l-2 border-gray-600 opacity-70">
                          <span class="text-gray-400">Level 2 (Sub-affiliate)</span>
                          <span class="text-gray-400">5%</span>
                      </div>
                      <div class="flex justify-between text-xs p-2 bg-[#0a0a0a] rounded border-l-2 border-gray-800 opacity-50">
                          <span class="text-gray-500">Level 3</span>
                          <span class="text-gray-500">2%</span>
                      </div>
                  </div>
              </div>
          </div>
      </section>

  </main>

  <!-- LOGIC -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

    // --- CONFIG ---
    const ADDR = { TOKEN: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", PRESALE: "0xff4b4f2076F39550e2C5fD44cb2024Eb06B944E5", BLACKJACK: "0xbe0b8099B707e3c0bA278583C6b5561D82E77f3E", INSTANT: "0xbcF9DFfcDaDeC818F7B653aF1a7Ff287F3e7011f" };
    const ABIS = { TOKEN: ["function balanceOf(address) view returns (uint256)"], PRESALE: ["function buyTokens() payable"] };
    const PBJ_RATE = 1500000;
    let provider, signer, address, contracts = {}, miningTicker = null, currentGame = null;

    // --- TOAST & SOUND ---
    const toast = (msg, type='success') => {
        const div = document.createElement('div');
        div.className = `px-4 py-2 text-xs font-mono font-bold text-black rounded shadow-lg mb-2 ${type==='error'?'bg-red-500':'bg-primary'}`;
        div.innerText = `> ${msg}`;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(()=>div.remove(), 3000);
    };

    // --- WALLET ---
    document.getElementById('connectBtn').addEventListener('click', async () => {
        if(!window.ethereum) return alert("Install Metamask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            address = await signer.getAddress();
            
            contracts.token = new ethers.Contract(ADDR.TOKEN, ABIS.TOKEN, signer);
            contracts.presale = new ethers.Contract(ADDR.PRESALE, ABIS.PRESALE, signer);

            document.getElementById('connectBtn').innerText = address.substring(0,6)+"...";
            unlockPartners(); loadUserData();
            toast("PICKAXE CONNECTED");
        } catch(e) { toast("CONNECTION FAILED", "error"); }
    });

    // --- PARTNERS ---
    function unlockPartners() {
        document.getElementById('partner-locked').classList.add('hidden');
        document.getElementById('partner-unlocked').classList.remove('hidden');
        document.getElementById('partner-unlocked').classList.add('grid');
        document.getElementById('refLinkInput').value = `${window.location.origin}?ref=${address}`;
    }
    window.copyRefLink = () => {
        const el = document.getElementById('refLinkInput'); el.select(); navigator.clipboard.writeText(el.value);
        toast("LINK COPIED");
    };

    // --- STAKING & MINING SIMULATION ---
    window.loadUserData = () => {
        const list = document.getElementById('inventory-list');
        list.innerHTML = ''; // Clear lock icon
        
        // Mock Data
        const miners = [
            { id: "ROOKIE #420", rate: 0.0001, color: "text-gray-400" },
            { id: "KING #001", rate: 0.0050, color: "text-gold" }
        ];

        miners.forEach(m => {
            list.innerHTML += `
                <div class="flex justify-between items-center bg-[#1a1a1a] p-3 rounded border-l-2 border-primary mb-2">
                    <span class="text-xs text-white font-bold">${m.id}</span>
                    <span class="text-[10px] ${m.color} animate-pulse">MINING...</span>
                </div>`;
        });

        document.getElementById('total-staked').innerText = "2 MINERS";
        document.getElementById('daily-yield').innerText = "2,050 PBJ/d";

        // Real-time ticker
        if(miningTicker) clearInterval(miningTicker);
        let pending = 12.4500;
        miningTicker = setInterval(() => {
            pending += 0.0004; // Increment per tick
            document.getElementById('pending-rewards').innerText = pending.toFixed(4);
        }, 100);
    };

    window.claimRewards = () => {
        toast("REWARDS SENT TO WALLET");
        document.getElementById('pending-rewards').innerText = "0.0000";
    };

    // --- CALCULATOR ---
    const buyInput = document.getElementById('buyInput');
    const receiveInput = document.getElementById('receiveInput');
    
    buyInput.addEventListener('input', (e) => { 
        const v = parseFloat(e.target.value);
        receiveInput.value = isNaN(v) ? '' : (v * PBJ_RATE).toFixed(0);
    });
    receiveInput.addEventListener('input', (e) => {
        const v = parseFloat(e.target.value);
        buyInput.value = isNaN(v) ? '' : (v / PBJ_RATE).toFixed(6);
    });

    // --- GAME MODAL ---
    window.openGame = (name, demo) => {
        document.getElementById('gameModal').classList.remove('hidden');
        document.getElementById('gameModal').classList.add('flex');
        document.getElementById('modalTitle').innerText = name.toUpperCase();
        document.getElementById('innerGameContent').innerHTML = `<div class="text-4xl text-gray-600 font-mono">PRESS PLAY</div>`;
    };
    window.closeGame = () => {
        document.getElementById('gameModal').classList.add('hidden');
        document.getElementById('gameModal').classList.remove('flex');
    };
    
    document.getElementById('gameActionBtn').addEventListener('click', () => {
        document.getElementById('gameStatus').innerText = "MINING...";
        setTimeout(() => {
            const win = Math.random() > 0.5;
            if(win) {
                toast("YOU WON!");
                confetti({ particleCount: 50, origin: { y: 0.6 }, colors: ['#39FF14'] });
            }
            document.getElementById('gameStatus').innerText = win ? "WIN!" : "TRY AGAIN";
        }, 1000);
    });

  </script>
</body>
</html>
