<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tragamonedas - Pepe Blackjack Casino</title>
  <meta name="description" content="Tragamonedas PBJ: Gira los rodillos, activa giros gratis, multiplica ganancias y utiliza s√≠mbolos Wild." />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  
  <style>
    :root { color-scheme: dark; scroll-behavior:smooth; }
    html, body { margin:0; padding:0; background:#000; }
    html, body, * { font-family:'Press Start 2P', cursive !important; }
    body { -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
    button { cursor:pointer; }
    .container { max-width:1280px; margin:0 auto; padding:40px 20px 140px; position:relative; }

    .back-link {
      display:inline-block; background:#0f2b1c; color:#a9ffcf; border:2px solid #1e5a3c;
      padding:10px 16px; border-radius:8px; text-decoration:none; font-size:12px; margin-bottom:30px;
      box-shadow:0 0 8px #39ff1433, 2px 2px 0 #001c0d; transition:.15s;
    }
    .back-link:hover { transform:translateY(-3px); box-shadow:0 0 14px #39ff14, 4px 4px 0 #001c0d; }
    h1 { color:#39ff14; text-shadow:0 0 10px #39ff14; font-size:28px; margin-bottom:30px; text-align:center; }

    .panel, .hero-section, .content-section {
      background:#0a1114; border-radius:20px; padding:26px 24px;
      box-shadow:0 0 0 3px #0d1e15 inset, 0 14px 30px rgba(0,0,0,.6), 0 0 42px #39ff1428;
      border:3px solid #123b27; position:relative;
    }
    .panel::before, .hero-section::before, .content-section::before {
      content:""; position:absolute; inset:-3px; border-radius:22px; z-index:-1;
      background:conic-gradient(#39ff14,#00ffa5,#39ff14); filter:blur(20px); opacity:.15;
    }
    h2 { color:#39ff14; font-size:18px; margin:0 0 20px; text-shadow:0 0 6px #39ff14; }
    p, li, label, .small, h3, h4 { color:#b8ffda; font-size:12px; line-height:1.7; }
    ul { list-style:none; padding:0; margin:0; }
    ul li { margin-bottom:12px; }
    ul li::before { content:"‚Ä¢ "; color:#39ff14; font-weight:bold; margin-right:6px; }

    .flex { display:flex; gap:28px; flex-wrap:wrap; }
    @media (max-width:1050px){ .flex-col-mobile { flex-direction:column; } }

    /* Slot machine */
    .slot-wrapper {
      display:flex; flex-direction:column; gap:16px; align-items:center;
    }
    .slot-frame {
      background:#06140f;
      border:4px solid #1e5a3c;
      box-shadow:inset 0 0 30px #0c2d20, 0 10px 30px #000000aa, 0 0 28px #39ff1422;
      border-radius:18px;
      padding:18px 14px 24px;
      position:relative;
      width:100%;
      max-width:680px;
    }
    .reels {
      display:flex; gap:10px; justify-content:center;
    }
    .reel {
      width:110px;
      height:330px;
      overflow:hidden;
      position:relative;
      border:2px solid #123b27;
      border-radius:14px;
      background:#071810;
      box-shadow:inset 0 0 18px #0c2d20;
    }
    .symbols-column {
      position:absolute;
      top:0;
      left:0;
      right:0;
      will-change:transform;
    }
    .symbol {
      height:110px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      text-align:center;
      padding:4px;
      box-sizing:border-box;
      font-weight:bold;
      letter-spacing:1px;
    }
    .symbol.pepea { background:#1d2e28; color:#b8ffda; }
    .symbol.pepeb { background:#153d2b; color:#b8ffda; }
    .symbol.pepec { background:#2a183d; color:#ffd6ff; }
    .symbol.peped { background:#3d1f27; color:#ffdbcf; }
    .symbol.wild { background:#5e0; color:#041; text-shadow:0 0 6px #39ff14; }
    .symbol.scatter { background:#5b008a; color:#ffd5ff; text-shadow:0 0 6px #ff72ff; }
    .symbol.mult2 { background:#004d82; color:#d2f2ff; text-shadow:0 0 6px #39bfff; }

    .paylines-overlay {
      pointer-events:none;
      position:absolute;
      inset:0;
    }
    .payline-line {
      position:absolute;
      height:2px;
      background:#39ff14;
      opacity:.0;
      transition:opacity .3s;
    }
    .payline-line.active { opacity:.85; box-shadow:0 0 8px #39ff14, 0 0 18px #39ff1477; }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:center;
      margin-top:10px;
    }
    .btn {
      background:#132a22;
      color:#b8ffda;
      border:2px solid #1e5a3c;
      padding:12px 18px;
      font-size:11px;
      border-radius:12px;
      box-shadow:inset 0 0 10px #0c2d20;
      transition:.15s;
      font-weight:bold;
      letter-spacing:1px;
    }
    .btn:hover:not(:disabled) {
      border-color:#39ff14; color:#39ff14; box-shadow:0 0 12px #39ff1499;
      transform:translateY(-3px);
    }
    .btn:disabled { opacity:.4; cursor:not-allowed; }

    .toggle-btn {
      background:#072818;
      border:2px solid #39ff14;
      color:#39ff14;
      font-size:10px;
      padding:8px 14px;
      border-radius:50px;
      box-shadow:0 0 10px #39ff1444;
      transition:.15s;
    }
    .toggle-btn.active, .toggle-btn:hover { background:#39ff14; color:#01210f; box-shadow:0 0 14px #39ff14; }

    .bet-config {
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      justify-content:center;
      margin-top:12px;
    }
    .bet-box {
      background:#071810;
      border:2px solid #123b27;
      padding:12px 16px;
      border-radius:14px;
      min-width:160px;
      box-shadow:inset 0 0 10px #0c2d20;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:10px;
    }
    .bet-box strong { color:#39ff14; font-size:11px; }
    .value-row { display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .value-row button {
      background:#092a1c;
      border:2px solid #1e5a3c;
      color:#b8ffda;
      font-size:10px;
      padding:6px 10px;
      border-radius:8px;
      transition:.15s;
    }
    .value-row button:hover { border-color:#39ff14; color:#39ff14; }

    .chip-select {
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:4px;
    }
    .chip {
      background:#072818;
      color:#39ff14;
      border:2px solid #39ff14;
      padding:10px 14px;
      border-radius:50px;
      font-size:11px;
      box-shadow:0 0 10px #39ff1444;
      transition:.15s;
    }
    .chip.active, .chip:hover { background:#39ff14; color:#01210f; box-shadow:0 0 14px #39ff14; }

    .balance-box {
      margin-top:18px;
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .balance {
      background:#072818;
      border:2px solid #39ff14;
      color:#39ff14;
      padding:12px 18px;
      border-radius:14px;
      font-size:13px;
      box-shadow:0 0 12px #39ff1477;
    }
    .info-row {
      margin-top:12px;
      text-align:center;
      font-size:11px;
      color:#b8ffda;
    }
    .result-box {
      margin-top:14px;
      font-size:14px;
      font-weight:bold;
      min-height:26px;
      text-align:center;
      color:#39ff14;
      text-shadow:0 0 8px #39ff14;
    }

    .history-box, .payout-table, .fair-box {
      background:#071810;
      border:2px solid #123b27;
      padding:14px 16px;
      border-radius:14px;
      font-size:11px;
      box-shadow:inset 0 0 10px #0c2d20;
      max-height:320px;
      overflow:auto;
    }
    .history-box::-webkit-scrollbar,
    .payout-table::-webkit-scrollbar,
    .fair-box::-webkit-scrollbar { width:6px; }
    .history-box::-webkit-scrollbar-thumb,
    .payout-table::-webkit-scrollbar-thumb,
    .fair-box::-webkit-scrollbar-thumb { background:#1e5a3c; border-radius:4px; }

    .win-line-entry { display:flex; justify-content:space-between; gap:10px; }
    .tag {
      display:inline-block;
      padding:2px 6px;
      border-radius:6px;
      font-size:10px;
      background:#39ff14;
      color:#02160b;
      margin-left:6px;
    }
    .tag.small { font-size:9px; padding:1px 4px; }

    code {
      background:#04130d;
      padding:2px 4px;
      border-radius:4px;
      font-size:10px;
      color:#39ff14;
      word-break:break-all;
    }

    .coming-soon {
      background:#072818;
      border:2px solid #39ff14;
      color:#39ff14;
      padding:16px 24px;
      border-radius:12px;
      text-align:center;
      font-size:14px;
      box-shadow:0 0 16px #39ff1499;
      margin-top:30px;
    }

    .highlight-win {
      animation: pulseWin 0.8s ease-in-out 2;
    }
    @keyframes pulseWin {
      0%,100% { filter:none; }
      50% { filter:brightness(1.5) drop-shadow(0 0 6px #39ff14); }
    }

    .free-spin-indicator {
      margin-top:8px;
      text-align:center;
      font-size:12px;
      color:#ffe86b;
      text-shadow:0 0 8px #ffe86b;
      font-weight:bold;
      min-height:20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html#casino" class="back-link">‚Üê Volver al Casino</a>
    <h1>üé∞ TRAGAMONEDAS</h1>

    <div class="hero-section">
      <h2>Giros √âpicos y Premios Masivos</h2>
      <p>
        Tragamonedas estilo retro con s√≠mbolos Wild, Scatters que otorgan giros gratis y multiplicadores.
        Configura tu apuesta, elige l√≠neas y presiona SPIN. Con el modo turbo y auto-spin
        puedes acelerar tu sesi√≥n. El sistema incluye hash de imparcialidad b√°sico.
      </p>
      <div class="balance-box">
        <div class="balance">Balance: <span id="balanceSpan"></span> PBJ</div>
        <button class="btn" id="addFundsBtn">+100</button>
        <button class="btn" id="resetBalanceBtn">Reset 500</button>
      </div>
      <p class="small" style="text-align:center;">Tu balance se guarda en localStorage. Esta versi√≥n es demostrativa; integraci√≥n real con tokens PBJ pr√≥ximamente.</p>
    </div>

    <div class="flex flex-col-mobile">
      <!-- M√°quina -->
      <div class="panel" style="flex:1.2; min-width:380px;">
        <h2>M√°quina</h2>
        <div class="slot-wrapper">
          <div class="slot-frame" id="slotFrame">
            <div class="reels" id="reelsContainer"></div>
            <div class="paylines-overlay" id="paylinesOverlay"></div>
          </div>
          <div class="controls">
            <button class="btn" id="spinBtn">SPIN</button>
            <button class="btn" id="autoBtn">AUTO</button>
            <button class="toggle-btn" id="turboBtn">Turbo</button>
            <button class="toggle-btn" id="freeSpinInfo" style="display:none;"></button>
            <button class="btn" id="stopAutoBtn" disabled>STOP AUTO</button>
          </div>

          <div class="bet-config">
            <div class="bet-box">
              <strong>Apuesta por L√≠nea</strong>
              <div class="chip-select" id="chipSelect"></div>
              <div class="value-row">
                <span>Valor actual:</span>
                <span id="betPerLineSpan"></span>
              </div>
            </div>
            <div class="bet-box">
              <strong>L√≠neas Activas</strong>
              <div class="value-row">
                <button id="linesMinusBtn">‚àí</button>
                <span id="linesCountSpan"></span>
                <button id="linesPlusBtn">+</button>
              </div>
              <div class="value-row">
                <span>Total apuesta:</span>
                <span id="totalBetSpan">0</span>
              </div>
            </div>
            <div class="bet-box">
              <strong>Estado</strong>
              <div class="value-row">
                <span>Modo Turbo:</span>
                <span id="turboStateSpan">OFF</span>
              </div>
              <div class="value-row">
                <span>Auto-Spin:</span>
                <span id="autoStateSpan">OFF</span>
              </div>
              <div class="value-row">
                <span>Free Spins:</span>
                <span id="freeSpinsSpan">0</span>
              </div>
            </div>
          </div>

          <div class="free-spin-indicator" id="freeSpinIndicator"></div>
          <div class="result-box" id="resultBox"></div>
        </div>
      </div>

      <!-- Informaci√≥n y tablas -->
      <div class="panel" style="flex:1; min-width:340px;">
        <h2>Pagos / Historial</h2>
        <div class="payout-table" id="payoutTable">
          <strong style="color:#39ff14;">Tabla de Pagos (3 / 4 / 5 en l√≠nea):</strong>
          <div id="payoutContent"></div>
        </div>
        <div class="history-box" id="historyBox" style="margin-top:16px;">
          <strong style="color:#39ff14;">Historial (√∫ltimos 20):</strong>
          <div id="historyList"></div>
        </div>
        <div class="fair-box" style="margin-top:16px;">
          <strong style="color:#39ff14;">Provably Fair (simplificado)</strong><br />
          √öltimo resultado hash: <code id="lastHashFair">-</code><br />
          Cadena: <code id="lastFairRaw">-</code><br />
          (Hash SHA-256 de paradas de rodillos + timestamp. Para mayor transparencia se puede
          a√±adir semilla de servidor + semilla de cliente en futuro.)
        </div>
      </div>
    </div>

    <div class="content-section">
      <h2>üìã C√≥mo Jugar</h2>
      <ul>
        <li>Elige apuesta por l√≠nea (botones de ficha).</li>
        <li>Configura cu√°ntas l√≠neas usar (m√°x 25).</li>
        <li>Presiona SPIN para girar los 5 rodillos.</li>
        <li>Los s√≠mbolos se comparan seg√∫n las l√≠neas activas de izquierda a derecha.</li>
        <li>Wild sustituye cualquier s√≠mbolo excepto Scatter o Multiplicador.</li>
        <li>3+ Scatter (en cualquier posici√≥n) otorgan Free Spins.</li>
        <li>Multiplicador (x2) dentro de una combinaci√≥n mejora esa l√≠nea.</li>
      </ul>
    </div>

    <div class="content-section">
      <h2>üéØ S√≠mbolos Especiales</h2>
      <p>
        Wild: Sustituye s√≠mbolos regulares. Scatter: Otorga giros gratis (3 = 5 FS, 4 = 10 FS, 5 = 18 FS).
        Mult2: Duplica la ganancia de la l√≠nea si aparece dentro de la combinaci√≥n ganadora. Los Free Spins
        no consumen balance y pueden encadenarse.
      </p>
    </div>

    <div class="content-section">
      <h2>üíé Caracter√≠sticas Especiales</h2>
      <ul>
        <li>Animaci√≥n de rodillos variable</li>
        <li>Modo Turbo para giros r√°pidos</li>
        <li>Auto-Spin hasta detener</li>
        <li>Free Spins acumulables</li>
        <li>Hash de transparencia b√°sico</li>
        <li>Persistencia de balance (localStorage)</li>
      </ul>
    </div>

    <div class="coming-soon">
      üöÄ Pr√≥ximamente: Jackpot progresivo, l√≠neas avanzadas personalizadas, selecci√≥n de temas y modo ‚Äúbuy bonus‚Äù.
    </div>
  </div>

  <script>
    /******************************
     * Configuraci√≥n del juego    *
     ******************************/
    const REELS_COUNT = 5;
    const ROWS_VISIBLE = 3;
    const INITIAL_BALANCE = 1000;
    const BALANCE_KEY = 'slots_balance';
    const MAX_HISTORY = 20;
    const MAX_LINES = 25;

    // Fichas (apuesta por l√≠nea)
    const CHIP_VALUES = [1,2,5,10,20,50,100];

    // S√≠mbolos y sus pagos por 3/4/5 (multiplicador base)
    const SYMBOLS = {
      'pepea': { name:'PEPE A', pays:{3:5,4:12,5:30}, weight:30 },
      'pepeb': { name:'PEPE B', pays:{3:8,4:16,5:40}, weight:26 },
      'pepec': { name:'PEPE C', pays:{3:12,4:24,5:60}, weight:22 },
      'peped': { name:'PEPE D', pays:{3:18,4:32,5:100}, weight:16 },
      'wild':  { name:'WILD',  pays:{3:20,4:60,5:150}, weight:10 },
      'scatter': { name:'SCATTER', pays:{3:0,4:0,5:0}, weight:8 },
      'mult2': { name:'MULT x2', pays:{3:0,4:0,5:0}, weight:6 } // Solo efecto multiplicador
    };

    // Paylines (cada l√≠nea es un array de 5 √≠ndices de fila: 0 arriba,1 medio,2 abajo)
    // 25 l√≠neas de ejemplo (cl√°sico + diagonales + zigzags)
    const PAYLINES = [
      [1,1,1,1,1], [0,0,0,0,0], [2,2,2,2,2],
      [0,1,2,1,0], [2,1,0,1,2], [0,0,1,2,2], [2,2,1,0,0], [0,1,1,1,0], [2,1,1,1,2], [1,0,0,0,1],
      [1,2,2,2,1], [0,1,0,1,0], [2,1,2,1,2], [1,0,1,2,1], [1,2,1,0,1],
      [0,2,0,2,0], [2,0,2,0,2], [0,2,1,2,0], [2,0,1,0,2], [1,1,0,1,1],
      [1,1,2,1,1], [0,1,2,2,1], [2,1,0,0,1], [0,2,2,0,0], [2,0,0,2,2]
    ];

    // Free spins otorgados por scatters
    const SCATTER_FREE_SPINS = {3:5,4:10,5:18};

    /******************************
     * Estado din√°mico            *
     ******************************/
    let balance = parseInt(localStorage.getItem(BALANCE_KEY)||INITIAL_BALANCE,10);
    let betPerLine = CHIP_VALUES[0];
    let activeLines = 10;
    let turboMode = false;
    let autoSpinning = false;
    let freeSpins = 0;
    let history = [];

    let spinning = false;
    let reelsData = []; // Arreglo de arrays con los s√≠mbolos visibles
    let lastStops = null;

    /******************************
     * Utilidades                 *
     ******************************/
    function updateBalanceDisplay(){ document.getElementById('balanceSpan').textContent = balance; }
    function persistBalance(){ localStorage.setItem(BALANCE_KEY, balance.toString()); }
    function totalBet(){ return freeSpins > 0 ? 0 : betPerLine * activeLines; }
    function cryptRandInt(max){
      const arr = new Uint32Array(1);
      crypto.getRandomValues(arr);
      return arr[0] % max;
    }
    function sha256Hex(str){
      const enc = new TextEncoder();
      return crypto.subtle.digest('SHA-256', enc.encode(str)).then(buf=>{
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      });
    }

    /******************************
     * Render fichas (chips)      *
     ******************************/
    function renderChipSelect(){
      const el = document.getElementById('chipSelect');
      el.innerHTML='';
      CHIP_VALUES.forEach(v=>{
        const b = document.createElement('button');
        b.className='chip' + (v===betPerLine ? ' active':'');
        b.textContent = v + ' PBJ';
        b.onclick = ()=>{
          betPerLine = v;
          renderChipSelect();
          refreshBetUI();
        };
        el.appendChild(b);
      });
    }

    /******************************
     * UI de apuestas             *
     ******************************/
    function refreshBetUI(){
      document.getElementById('betPerLineSpan').textContent = betPerLine;
      document.getElementById('linesCountSpan').textContent = activeLines;
      document.getElementById('totalBetSpan').textContent = totalBet();
      document.getElementById('turboStateSpan').textContent = turboMode ? 'ON':'OFF';
      document.getElementById('autoStateSpan').textContent = autoSpinning ? 'ON':'OFF';
      document.getElementById('freeSpinsSpan').textContent = freeSpins;
      const indicator = document.getElementById('freeSpinIndicator');
      indicator.textContent = freeSpins > 0 ? `Giros Gratis Restantes: ${freeSpins}` : '';
    }

    /******************************
     * Construir reels (DOM)      *
     ******************************/
    function createReels(){
      const container = document.getElementById('reelsContainer');
      container.innerHTML='';
      for (let r=0;r<REELS_COUNT;r++){
        const reel = document.createElement('div');
        reel.className='reel';
        const col = document.createElement('div');
        col.className='symbols-column';
        reel.appendChild(col);
        container.appendChild(reel);
      }
    }

    function pickRandomSymbol(){
      // Weighted random
      const totalWeight = Object.values(SYMBOLS).reduce((acc,s)=>acc+s.weight,0);
      let rnd = cryptRandInt(totalWeight);
      for (const [key,sym] of Object.entries(SYMBOLS)){
        if (rnd < sym.weight) return key;
        rnd -= sym.weight;
      }
      // fallback
      return 'pepea';
    }

    function generateReelsResult(){
      reelsData = [];
      for (let r=0;r<REELS_COUNT;r++){
        const column = [];
        for (let i=0;i<ROWS_VISIBLE;i++){
          column.push(pickRandomSymbol());
        }
        reelsData.push(column);
      }
      lastStops = JSON.parse(JSON.stringify(reelsData));
    }

    function renderReelsSymbols(initial=false){
      const reels = [...document.querySelectorAll('.reel .symbols-column')];
      reels.forEach((col, idx)=>{
        col.innerHTML='';
        // Para animaci√≥n, a√±adimos m√°s s√≠mbolos (buffer) si girando
        const visible = spinning ? 15 : ROWS_VISIBLE;
        for (let i=0;i<visible;i++){
          const symbolKey = spinning ? pickRandomSymbol() : reelsData[idx][i];
          const div = document.createElement('div');
          div.className='symbol ' + symbolKey;
          div.textContent = SYMBOLS[symbolKey].name;
          col.appendChild(div);
        }
        if (!spinning){
          col.style.transform = 'translateY(0px)';
        }
      });
    }

    /******************************
     * Paylines overlay           *
     ******************************/
    function renderPaylinesOverlay(){
      const overlay = document.getElementById('paylinesOverlay');
      overlay.innerHTML='';
      const frameRect = document.getElementById('slotFrame').getBoundingClientRect();
      // Posiciones Y por fila (aprox)
      const reelHeight = 330;
      const cellHeight = reelHeight / ROWS_VISIBLE;
      const yPositions = [
        cellHeight*0.5,
        cellHeight*1.5,
        cellHeight*2.5
      ];
      // Ancho de cada reel incluyendo gap
      const reelEls = [...document.querySelectorAll('.reel')];
      const xPositions = reelEls.map(el=>el.offsetLeft + el.offsetWidth/2);
      PAYLINES.slice(0, activeLines).forEach((line, idx)=>{
        const path = document.createElement('div');
        path.className='payline-line';
        path.dataset.lineIndex = idx;
        // Dibujar con un gradiente diagonal usando width/height
        // Representamos como una l√≠nea posicionada y rota entre primer y √∫ltimo reel
        // Mejor: usar un canvas overlay. Simplicidad: repetimos peque√±os segmentos.
        for (let i=0;i<line.length-1;i++){
          const x1 = xPositions[i];
          const x2 = xPositions[i+1];
            const y1 = yPositions[line[i]];
            const y2 = yPositions[line[i+1]];
          const segment = document.createElement('div');
          segment.className='payline-line';
          segment.style.position='absolute';
          const dx = x2 - x1;
          const dy = y2 - y1;
          const length = Math.sqrt(dx*dx + dy*dy);
          segment.style.width = length + 'px';
          segment.style.left = (x1) + 'px';
          segment.style.top = (y1) + 'px';
          const angle = Math.atan2(dy, dx);
          segment.style.transformOrigin='0 0';
          segment.style.transform = `rotate(${angle}rad)`;
          segment.dataset.lineIndex = idx;
          overlay.appendChild(segment);
        }
      });
    }

    function highlightWinningLines(linesWon){
      const overlay = document.getElementById('paylinesOverlay');
      [...overlay.querySelectorAll('.payline-line')].forEach(el=>{
        const idx = parseInt(el.dataset.lineIndex,10);
        if (linesWon.includes(idx)){
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }

    /******************************
     * Evaluar resultados         *
     ******************************/
    function evaluateSpin(){
      let totalWin = 0;
      const winDetails = [];
      const linesWon = [];
      let scatterCount = 0;

      // Contar scatters (en cualquier posici√≥n)
      reelsData.forEach(col=>{
        col.forEach(sym=>{
          if (sym==='scatter') scatterCount++;
        });
      });

      PAYLINES.slice(0, activeLines).forEach((line, lineIndex)=>{
        // Obtener s√≠mbolos en la l√≠nea
        const sequence = line.map((row,rIndex)=>reelsData[rIndex][row]);
        // Determinar la mejor combinaci√≥n desde la izquierda
        let baseSymbol = null;
        let count = 0;
        let hasMultiplier = false;

        for (let i=0;i<sequence.length;i++){
          const sym = sequence[i];
          if (sym === 'scatter') break; // Scatter no participa en l√≠nea normal
          if (sym === 'mult2'){
            // Multiplicador puede sumarse si ya hay un s√≠mbolo base
            if (baseSymbol) hasMultiplier = true;
            else {
              // Multiplicador sin base: espera a que aparezca algo siguiente (lo ignoramos)
            }
            continue;
          }
          if (!baseSymbol){
            baseSymbol = sym === 'wild' ? null : sym; // Wild no define base a√∫n
            if (baseSymbol){
              count++;
            } else {
              // baseSymbol sigue null, pero wildcard cuenta si luego se define
              count++;
              baseSymbol = null;
            }
          } else {
            // Si tenemos baseSymbol
            if (sym === baseSymbol || sym === 'wild'){
              count++;
            } else if (sym === 'mult2'){
              hasMultiplier = true;
            } else {
              break;
            }
          }
          // Si era wild y baseSymbol null, el siguiente s√≠mbolo distinto a wild definir√°
          if (baseSymbol === null && sym !== 'wild'){
            baseSymbol = sym;
          }
        }

        // Ajuste: Si primera parte incluye wild antes de definir base, necesitamos recomputar
        // Ejemplo: [wild, wild, pepea] => cuenta = 3 de pepea
        if (baseSymbol === null){
          // Buscar primer s√≠mbolo no wild/mult2/scatter
          for (let i=0;i<sequence.length;i++){
            const s = sequence[i];
            if (s!=='wild' && s!=='mult2' && s!=='scatter'){
              baseSymbol = s;
              break;
            }
          }
        }

        if (baseSymbol && count >= 3){
          const payTable = SYMBOLS[baseSymbol].pays;
          const payoutBase = payTable[count] || 0;
          let payout = payoutBase * betPerLine;
          if (hasMultiplier) payout *= 2;
          if (payout > 0){
            totalWin += payout;
            winDetails.push({
              line: lineIndex+1,
              symbol: baseSymbol,
              count,
              multiplier: hasMultiplier ? 2 : 1,
              payout
            });
            linesWon.push(lineIndex);
          }
        }
      });

      // Free spins por scatters
      let awardedFreeSpins = 0;
      if (scatterCount >= 3){
        awardedFreeSpins = SCATTER_FREE_SPINS[scatterCount] || 0;
        freeSpins += awardedFreeSpins;
      }

      // Aplicar balance
      const betUsed = totalBet();
      if (betUsed > 0){
        balance -= betUsed;
      }
      balance += totalWin;
      persistBalance();

      // Historial
      const resultEntry = {
        reels: JSON.parse(JSON.stringify(reelsData)),
        win: totalWin,
        bet: betUsed,
        scatters: scatterCount,
        freeSpinsAdded: awardedFreeSpins
      };
      history.unshift(resultEntry);
      if (history.length > MAX_HISTORY) history.pop();

      // Fair hash
      const raw = JSON.stringify(resultEntry) + ':' + Date.now();
      sha256Hex(raw).then(hash=>{
        document.getElementById('lastHashFair').textContent = hash;
        document.getElementById('lastFairRaw').textContent = raw;
      });

      // Mostrar resultado
      let msg = `Ganancia: ${totalWin} PBJ`;
      if (awardedFreeSpins) msg += ` ‚Ä¢ +${awardedFreeSpins} Free Spins`;
      if (totalWin === 0) msg = `Sin premio ‚Ä¢ Scatters: ${scatterCount}` + (awardedFreeSpins ? ` (+${awardedFreeSpins} FS)` : '');
      showResult(msg, totalWin === 0);

      // Render wins y resaltar
      renderHistory();
      highlightWinningLines(linesWon);

      // Animar s√≠mbolos ganadores
      linesWon.forEach(lIdx=>{
        const line = PAYLINES[lIdx];
        line.forEach((row,r)=>{
          const reelEl = document.querySelectorAll('.reel')[r];
          const symbolEls = reelEl.querySelectorAll('.symbol');
          const targetSymbol = symbolEls[row];
          if (targetSymbol) targetSymbol.classList.add('highlight-win');
        });
      });

      refreshBetUI();
      spinning = false;
      document.getElementById('spinBtn').disabled = false;
      document.getElementById('autoBtn').disabled = false;
      document.getElementById('stopAutoBtn').disabled = !autoSpinning;

      // Continuar auto-spin si activo
      if (autoSpinning){
        setTimeout(()=>{
          if (autoSpinning) startSpin();
        }, turboMode ? 300 : 1100);
      }
    }

    /******************************
     * Mostrar resultado           *
     ******************************/
    function showResult(msg, noWin){
      const box = document.getElementById('resultBox');
      box.textContent = msg;
      box.style.color = noWin ? '#ff5656' : '#39ff14';
      box.style.textShadow = noWin ? '0 0 8px #ff5656' : '0 0 8px #39ff14';
    }

    /******************************
     * Historial                  *
     ******************************/
    function renderHistory(){
      const list = document.getElementById('historyList');
      list.innerHTML='';
      history.forEach(h=>{
        const div = document.createElement('div');
        div.style.marginBottom='6px';
        const winTxt = h.win>0 ? `+${h.win}` : '0';
        const fsTxt = h.freeSpinsAdded>0 ? ` ‚Ä¢ FS:${h.freeSpinsAdded}` : '';
        div.innerHTML = `Bet:${h.bet} Win:${winTxt} S:${h.scatters}${fsTxt}`;
        list.appendChild(div);
      });
    }

    /******************************
     * Spin / Animaci√≥n           *
     ******************************/
    function startSpin(){
      if (spinning) return;
      if (totalBet() > balance){
        showResult('Balance insuficiente.', true);
        return;
      }
      if (!turboMode && !autoSpinning){
        showResult('Girando...', false);
      }

      // Limpiar resaltados previos
      document.querySelectorAll('.symbol.highlight-win').forEach(el=>el.classList.remove('highlight-win'));
      highlightWinningLines([]);

      // Generar nuevo resultado (final) para aplicar al terminar animaci√≥n
      generateReelsResult();

      spinning = true;
      document.getElementById('spinBtn').disabled = true;
      document.getElementById('autoBtn').disabled = true;
      document.getElementById('stopAutoBtn').disabled = !autoSpinning;

      // Re-render reels con muchos s√≠mbolos para simular scroll
      renderReelsSymbols(true);

      const reelsCols = [...document.querySelectorAll('.symbols-column')];
      reelsCols.forEach((col, idx)=>{
        // Determinar duraci√≥n y desplazamiento
        const totalSymbols = col.children.length;
        const symbolHeight = 110;
        const distance = symbolHeight * (totalSymbols - ROWS_VISIBLE);
        const baseDuration = turboMode ? 400 : 1400;
        const extra = turboMode ? 80 : 220;
        const duration = baseDuration + idx * extra;

        col.style.transition = `transform ${duration}ms cubic-bezier(.25,.6,.3,1)`;
        requestAnimationFrame(()=>{
          col.style.transform = `translateY(-${distance}px)`;
        });

        // Al terminar cada reel, reemplazamos con resultado final
        setTimeout(()=>{
          col.style.transition='none';
          col.innerHTML='';
          reelsData[idx].forEach(sym=>{
            const el = document.createElement('div');
            el.className='symbol ' + sym;
            el.textContent = SYMBOLS[sym].name;
            col.appendChild(el);
          });
          col.style.transform='translateY(0px)';
          if (idx === REELS_COUNT-1){
            // Peque√±a pausa y evaluar
            setTimeout(evaluateSpin, turboMode ? 50 : 300);
          }
        }, duration + 40);
      });
    }

    /******************************
     * Auto-Spin y Turbo          *
     ******************************/
    document.getElementById('autoBtn').onclick = ()=>{
      if (autoSpinning) return;
      autoSpinning = true;
      refreshBetUI();
      document.getElementById('stopAutoBtn').disabled = false;
      startSpin();
    };
    document.getElementById('stopAutoBtn').onclick = ()=>{
      autoSpinning = false;
      refreshBetUI();
      document.getElementById('stopAutoBtn').disabled = true;
    };
    document.getElementById('turboBtn').onclick = (e)=>{
      turboMode = !turboMode;
      e.target.classList.toggle('active', turboMode);
      refreshBetUI();
    };

    /******************************
     * Eventos b√°sicos            *
     ******************************/
    document.getElementById('spinBtn').onclick = startSpin;
    document.getElementById('addFundsBtn').onclick = ()=>{
      balance += 100;
      persistBalance();
      updateBalanceDisplay();
      showResult('+100 PBJ a√±adidos.', false);
    };
    document.getElementById('resetBalanceBtn').onclick = ()=>{
      if (!confirm('¬øResetear balance a 500 PBJ?')) return;
      balance = 500;
      persistBalance();
      updateBalanceDisplay();
      showResult('Balance reiniciado.', false);
    };
    document.getElementById('linesMinusBtn').onclick = ()=>{
      if (activeLines > 1){
        activeLines--;
        refreshBetUI();
        renderPaylinesOverlay();
      }
    };
    document.getElementById('linesPlusBtn').onclick = ()=>{
      if (activeLines < MAX_LINES){
        activeLines++;
        refreshBetUI();
        renderPaylinesOverlay();
      }
    };

    /******************************
     * Tabla de pagos             *
     ******************************/
    function renderPayoutTable(){
      const container = document.getElementById('payoutContent');
      container.innerHTML='';
      Object.entries(SYMBOLS).forEach(([key,sym])=>{
        if (key==='scatter'){
          const div = document.createElement('div');
          div.innerHTML = `<strong>${sym.name}</strong> ‚Ä¢ Free Spins: 3=5 | 4=10 | 5=18`;
          container.appendChild(div);
        } else if (key==='mult2'){
          const div = document.createElement('div');
          div.innerHTML = `<strong>${sym.name}</strong> ‚Ä¢ Duplica la l√≠nea (x2) si participa en la combinaci√≥n.`;
          container.appendChild(div);
        } else {
          const pays3 = sym.pays[3] || 0;
          const pays4 = sym.pays[4] || 0;
          const pays5 = sym.pays[5] || 0;
          const div = document.createElement('div');
          div.innerHTML = `<strong>${sym.name}</strong> ‚Üí ${pays3}/${pays4}/${pays5}x`;
          container.appendChild(div);
        }
      });
    }

    /******************************
     * Inicializaci√≥n             *
     ******************************/
    function init(){
      updateBalanceDisplay();
      renderChipSelect();
      refreshBetUI();
      createReels();
      generateReelsResult();
      renderReelsSymbols();
      renderPaylinesOverlay();
      renderPayoutTable();
      renderHistory();
    }
    init();
  </script>
</body>
</html>
