<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>Pepe Slots - PBJ Casino</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet" />

  <!-- Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --neon-green: #39ff14;
      --neon-purple: #a855f7;
      --panel-bg: rgba(8, 12, 10, 0.95);
      --glass-border: rgba(57, 255, 20, 0.2);
      --reel-bg: #0a0a0a;
      --icon-size: 40px;
      --reel-height: 150px; /* 3 visible rows approx */
    }
    
    @media(min-width: 768px) {
      :root { --icon-size: 60px; --reel-height: 240px; }
    }

    body { font-family: 'Inter', sans-serif; background-color: #020202; color: #e0e0e0; overflow-x: hidden; }
    .pixel-font { font-family: 'Press Start 2P', cursive; }

    /* Background */
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background: radial-gradient(circle at 50% 0%, rgba(168, 85, 247, 0.15), transparent 60%);
    }

    /* Slot Machine Frame */
    .slot-machine {
      position: relative;
      background: linear-gradient(180deg, #1a1a1a, #050505);
      border: 2px solid #333;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.2), inset 0 0 20px black;
      padding: 10px;
      max-width: 800px;
      margin: 0 auto;
    }

    .slot-screen {
      background: #000;
      border: 4px solid #222;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
    }
    
    /* Payline Indicator */
    .payline {
      position: absolute; top: 50%; left: 0; right: 0; height: 2px;
      background: rgba(255, 0, 0, 0.3); z-index: 10; pointer-events: none;
      transform: translateY(-50%);
      box-shadow: 0 0 5px red;
    }

    /* Reels */
    .reels-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
      height: var(--reel-height);
      background: var(--reel-bg);
    }

    .reel {
      overflow: hidden;
      position: relative;
      background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.8) 100%);
      border-right: 1px solid #222;
    }
    .reel:last-child { border-right: none; }

    .reel-strip {
      position: absolute;
      top: 0; left: 0; width: 100%;
      display: flex; flex-direction: column;
      will-change: transform; /* Performance optimization */
    }

    .slot-symbol {
      height: calc(var(--reel-height) / 3); /* 3 rows visible */
      display: flex; align-items: center; justify-content: center;
      font-size: var(--icon-size);
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
    }

    /* Blur Effect during spin */
    .blur-spin {
      filter: blur(3px);
    }

    /* Win Animation */
    .symbol-win {
      animation: pulseWin 0.5s infinite alternate;
      filter: drop-shadow(0 0 15px var(--neon-green));
      z-index: 20;
    }
    @keyframes pulseWin { from { transform: scale(1); } to { transform: scale(1.2); } }

    /* Controls */
    .glass-panel {
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
    }

    .spin-btn {
      background: linear-gradient(180deg, #a855f7, #7e22ce);
      box-shadow: 0 6px 0 #581c87, 0 0 20px rgba(168, 85, 247, 0.4);
      transition: all 0.1s;
    }
    .spin-btn:active { transform: translateY(6px); box-shadow: 0 0 0 transparent; }
    .spin-btn:disabled { filter: grayscale(1); cursor: not-allowed; transform: translateY(2px); box-shadow: 0 2px 0 #333; }

    /* Toast */
    .toast {
      position: fixed; top: 100px; right: 20px;
      background: rgba(0,0,0,0.95); border-left: 4px solid var(--neon-green);
      color: white; padding: 12px 24px; border-radius: 4px;
      font-size: 12px; opacity: 0; pointer-events: none; transition: opacity 0.3s;
      z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .toast.show { opacity: 1; transform: translateY(10px); }

    /* Jackpot Banner */
    .jackpot-banner {
      background: linear-gradient(90deg, #000, #222, #000);
      border: 1px solid #333; color: #facc15;
      text-align: center; font-family: 'Press Start 2P'; font-size: 10px;
      padding: 8px; border-radius: 8px; margin-bottom: 10px;
      animation: marquee 2s infinite alternate;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <nav class="bg-black/90 border-b border-white/10 p-3 flex justify-between items-center sticky top-0 z-50 backdrop-blur">
    <div class="flex items-center gap-2">
      <a href="../index.html" class="text-gray-400 hover:text-white text-xs pixel-font">‚Üê BACK</a>
      <span class="text-purple-400 pixel-font ml-2 text-xs md:text-sm">PEPE SLOTS</span>
    </div>
    <div class="bg-purple-900/20 border border-purple-800 px-3 py-1 rounded-full text-xs text-purple-300 flex items-center gap-2">
      <span>$PBJ</span>
      <span id="balance" class="font-mono font-bold">10,000</span>
    </div>
  </nav>

  <main class="flex-grow p-4 flex flex-col items-center justify-center gap-6 w-full">
    
    <!-- Jackpot Display -->
    <div class="w-full max-w-2xl">
       <div class="jackpot-banner text-yellow-400">
         GRAND JACKPOT: <span id="jackpot-counter">5,420,100</span> PBJ
       </div>
    </div>

    <!-- Machine -->
    <div class="slot-machine w-full">
      <div class="slot-screen">
        <div class="payline"></div> <!-- Visual guide -->
        <div class="reels-container" id="reels-wrapper">
           <!-- Reels injected by JS -->
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="glass-panel p-4 w-full max-w-2xl flex flex-col md:flex-row items-center justify-between gap-4">
      
      <!-- Bet Control -->
      <div class="flex items-center gap-3 w-full md:w-auto">
        <div class="bg-black/60 border border-gray-700 rounded-lg p-2 flex-1">
          <p class="text-[10px] text-gray-500 uppercase mb-1">Total Bet</p>
          <div class="flex items-center justify-between gap-2">
            <button onclick="adjustBet(-50)" class="bg-gray-800 hover:bg-gray-700 text-white w-6 h-6 rounded text-xs">-</button>
            <span id="bet-display" class="font-mono text-white font-bold text-sm">100</span>
            <button onclick="adjustBet(50)" class="bg-gray-800 hover:bg-gray-700 text-white w-6 h-6 rounded text-xs">+</button>
          </div>
        </div>
        <button onclick="maxBet()" class="bg-gray-800 hover:bg-purple-900 text-purple-300 border border-purple-900 text-[10px] px-3 py-4 rounded-lg font-bold">MAX</button>
      </div>

      <!-- Info Display -->
      <div class="text-center hidden md:block">
        <p class="text-[10px] text-gray-500">LAST WIN</p>
        <p id="last-win" class="text-xl pixel-font text-green-400">0</p>
      </div>

      <!-- Spin Button -->
      <button id="spin-btn" class="spin-btn w-full md:w-40 text-white font-bold py-4 rounded-xl pixel-font text-sm tracking-widest">
        SPIN
      </button>

    </div>

    <!-- Paytable Hint -->
    <div class="text-[10px] text-gray-600 text-center max-w-md">
      Match 3+ symbols for a win. üê∏ PEPE is WILD. <br> üíé Diamonds pay highest. üçí Cherries pay lowest.
    </div>

  </main>

  <div id="toast" class="toast">WINNER!</div>

  <script>
    /* --- CONFIGURATION --- */
    const SYMBOLS = [
      { id: 'wild', char: 'üê∏', value: 100 }, // Pepe
      { id: 'high', char: 'üíé', value: 50 },  // Diamond
      { id: 'mid1', char: 'üöÄ', value: 20 },  // Rocket
      { id: 'mid2', char: 'üåô', value: 15 },  // Moon
      { id: 'mid3', char: '7Ô∏è‚É£', value: 10 }, // Seven
      { id: 'low1', char: 'üçí', value: 5 },   // Cherry
      { id: 'low2', char: 'üçã', value: 3 },   // Lemon
      { id: 'low3', char: 'üçá', value: 2 }    // Grapes
    ];

    // Reel Configuration
    const REEL_COUNT = 5;
    const VISIBLE_ROWS = 3; // Though we mainly check the middle line
    const SYMBOL_HEIGHT_PERCENT = 100 / 3; // Percent of visible container
    
    // We generate a long strip for animation. 
    // Structure: [Buffer Symbols] ... [Target Symbols (visible)] ... [Buffer Symbols]
    const STRIP_LENGTH = 40; // Number of symbols in the DOM per reel

    let balance = 10000;
    let bet = 100;
    let isSpinning = false;

    /* --- INITIALIZATION --- */
    const reelsContainer = document.getElementById('reels-wrapper');
    const reelElements = []; // Stores DOM elements for strip movement

    function init() {
      reelsContainer.innerHTML = '';
      
      for(let i=0; i<REEL_COUNT; i++) {
        const reel = document.createElement('div');
        reel.className = 'reel';
        
        const strip = document.createElement('div');
        strip.className = 'reel-strip';
        
        // Fill strip with random symbols initially
        let content = '';
        for(let j=0; j<STRIP_LENGTH; j++) {
          content += `<div class="slot-symbol">${getRandomSymbol().char}</div>`;
        }
        strip.innerHTML = content;
        
        // Set initial position (show middle of strip roughly)
        // We want to show index 20, 21, 22 for example
        const initialOffset = -100 * (10); // Arbitrary start
        strip.style.transform = `translateY(${initialOffset}%)`; // % based on row height logic needs adjustment if % is used relative to parent. 
        // Let's use simple calc: The strip is huge. The parent has fixed height.
        // Slot symbol height is computed in CSS (calc(100% / 3)).
        // So translateY(-100%) moves down 3 symbols.
        strip.style.transform = `translateY(0px)`; // Reset for CSS control logic

        reel.appendChild(strip);
        reelsContainer.appendChild(reel);
        
        // Store reference
        reelElements.push({
            el: strip,
            symbols: Array.from(strip.children), // Cache the divs to update text later
            currentOffset: 0
        });
      }
      updateUI();
    }

    function getRandomSymbol() {
      // Weighted random could go here
      return SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
    }

    /* --- GAMEPLAY LOGIC --- */
    document.getElementById('spin-btn').addEventListener('click', spin);

    async function spin() {
      if(isSpinning) return;
      if(balance < bet) return showToast("Insufficient PBJ!", "error");

      // Deduct balance
      balance -= bet;
      isSpinning = true;
      updateUI();
      
      // Visuals
      document.getElementById('spin-btn').disabled = true;
      document.getElementById('last-win').textContent = "0";
      
      // 1. Determine Outcome (RNG)
      // We decide the 3 visible symbols for each of the 5 reels.
      // Middle row (index 1) is the Payline.
      const results = []; 
      for(let i=0; i<REEL_COUNT; i++) {
          results.push([getRandomSymbol(), getRandomSymbol(), getRandomSymbol()]); // Top, Middle, Bottom
      }

      // 2. Animate
      // Strategy: We don't actually scroll 1000 pixels. We blur the strip and translate it heavily.
      // Then we instantly swap the DOM elements at the destination to match result.
      
      const promises = reelElements.map((reelObj, index) => {
        return new Promise(resolve => {
           const strip = reelObj.el;
           const delay = index * 150; // Sequential stop
           const duration = 1500 + delay;
           
           // A. Start Spin (Blur & Move)
           strip.style.transition = `transform ${duration}ms cubic-bezier(0.45, 0.05, 0.55, 0.95)`;
           strip.classList.add('blur-spin');
           
           // Move down significantly to simulate speed
           // Assuming symbol height approx 80px (mobile) or dynamic. 
           // Let's use % relative to one symbol height. 
           // Actually, simplest CSS trick: translate Y by huge amount.
           const moveDistance = -1500 - (Math.random()*500); 
           strip.style.transform = `translateY(${moveDistance}%)`;

           // B. Stop
           setTimeout(() => {
             strip.classList.remove('blur-spin');
             strip.style.transition = "transform 400ms cubic-bezier(0.1, 0.9, 0.2, 1)"; // Snap effect
             
             // Inject the Result Symbols at the top of the visible area? 
             // Easier: Reset transform to 0 instantly (hidden), place results at top, then slide slightly?
             // Better: Just Replace the content of the strip so the current view *becomes* the result.
             
             // 1. Disable transition to reset position
             strip.style.transition = 'none';
             strip.style.transform = `translateY(-100%)`; // Shifted up slightly to allow "landing" anim
             
             // 2. Update DOM to have results in the viewable area
             // We need Top, Middle, Bottom at indices that are visible.
             // Let's say indices 1, 2, 3 are visible.
             const rData = results[index];
             const divs = reelObj.symbols;
             divs[0].textContent = getRandomSymbol().char; // Above
             divs[1].textContent = rData[0].char; // Top
             divs[2].textContent = rData[1].char; // Middle (Payline)
             divs[3].textContent = rData[2].char; // Bottom
             divs[4].textContent = getRandomSymbol().char; // Below
             
             // 3. Trigger Landing Animation
             requestAnimationFrame(() => {
                strip.style.transition = "transform 300ms cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                // Move to show index 1,2,3 (which is roughly Y offset 0 if we align top)
                // Let's assume standard alignment.
                // If container is height 300, each symbol 100.
                // 3 Symbols fill it.
                // If we want divs[1] at top: translateY(-33.33%)?
                // Let's align nicely:
                // The container shows 3 rows.
                // We want divs[1], divs[2], divs[3] to be visible.
                // divs[0] is hidden above.
                // So we translate Y so divs[0] is scrolled off.
                // Symbol height = 100% / 3.
                // So translate = - (100% / 3).
                strip.style.transform = `translateY(calc(-100% / 3))`;
             });
             
             resolve();
           }, duration);
        });
      });

      await Promise.all(promises);

      // 3. Calculate Win
      checkWin(results);
      isSpinning = false;
      document.getElementById('spin-btn').disabled = false;
    }

    function checkWin(reelResults) {
       // Check Payline (The Middle Row -> index 2 in our result array logic? No, index 1 in the subarray)
       // reelResults[0][1] is the middle symbol of Reel 1
       const middleLine = reelResults.map(r => r[1]); 

       // Simplify: check for 3, 4, or 5 matching sequential symbols from left
       // OR just count total matches if we want Scatter style.
       // Let's do "Left to Right" logic.
       
       let firstSym = middleLine[0];
       let matchCount = 1;
       
       // Handle Wilds (Pepe)
       // If first is Wild, it matches whatever the second is, unless second is wild etc.
       // Simplified: If Symbol matches First Symbol OR First/Current is Wild.
       
       let activeSymbol = firstSym; 

       for(let i=1; i<middleLine.length; i++) {
          const current = middleLine[i];
          const isWild = current.id === 'wild';
          const activeIsWild = activeSymbol.id === 'wild';
          
          if(isWild || activeIsWild || current.id === activeSymbol.id) {
             matchCount++;
             // If we started with Wild and now found a symbol, lock that symbol as the target
             if(activeIsWild && !isWild) activeSymbol = current;
          } else {
             break;
          }
       }

       let winnings = 0;
       if(matchCount >= 3) {
           // Paytable logic
           // 3 matches = 2x val
           // 4 matches = 5x val
           // 5 matches = 10x val
           let multiplier = 0;
           if(matchCount === 3) multiplier = 2;
           if(matchCount === 4) multiplier = 10;
           if(matchCount === 5) multiplier = 50;
           
           // If active symbol was Wild purely (5 wilds), pay highest
           const val = activeSymbol.value;
           winnings = bet * (val/10) * multiplier; // Normalize math slightly
           winnings = Math.floor(winnings);
       }

       if(winnings > 0) {
           balance += winnings;
           showToast(`BIG WIN! +${winnings} PBJ`, "success");
           document.getElementById('last-win').textContent = winnings.toLocaleString();
           confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
           // Highlight middle row? (Optional enhancement)
       } else {
           showToast("No win", "neutral");
       }
       
       updateUI();
    }

    /* --- UI HELPERS --- */
    function updateUI() {
        document.getElementById('balance').textContent = balance.toLocaleString();
        document.getElementById('bet-display').textContent = bet;
    }

    function adjustBet(amount) {
        if(isSpinning) return;
        let newBet = bet + amount;
        if(newBet < 10) newBet = 10;
        if(newBet > 5000) newBet = 5000;
        bet = newBet;
        updateUI();
    }

    function maxBet() {
        if(isSpinning) return;
        if(balance > 0) bet = Math.min(balance, 1000);
        updateUI();
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.borderColor = type === "error" ? "#ef4444" : (type === "success" ? "#39ff14" : "#666");
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // Jackpot Counter Animation
    setInterval(() => {
        const el = document.getElementById('jackpot-counter');
        let val = parseInt(el.textContent.replace(/,/g,''));
        val += Math.floor(Math.random()*50);
        el.textContent = val.toLocaleString();
    }, 2000);

    // Start
    init();

  </script>
</body>
</html>
